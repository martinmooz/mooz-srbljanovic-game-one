(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class U{static calculateBitmask(t){if(t.length!==8)throw new Error("neighborTracks array must contain exactly 8 boolean values.");let e=0;return t[0]&&(e|=1),t[1]&&(e|=2),t[2]&&(e|=4),t[3]&&(e|=8),t[4]&&(e|=16),t[5]&&(e|=32),t[6]&&(e|=64),t[7]&&(e|=128),e}}var g=(c=>(c.PASSENGERS="PASSENGERS",c.COAL="COAL",c.IRON_ORE="IRON_ORE",c.STEEL="STEEL",c.TOOLS="TOOLS",c.GOODS="GOODS",c))(g||{});const F=class F{static getCargoInfo(t){return this.cargoData[t]}static getRandomCargo(){const t=Object.values(g);return t[Math.floor(Math.random()*t.length)]}static getAllCargos(){return Object.values(this.cargoData)}};F.cargoData={PASSENGERS:{type:"PASSENGERS",baseValue:100,color:"#FFFFFF",name:"Passengers"},COAL:{type:"COAL",baseValue:200,color:"#2C2C2C",name:"Coal"},IRON_ORE:{type:"IRON_ORE",baseValue:250,color:"#8B4513",name:"Iron Ore"},STEEL:{type:"STEEL",baseValue:500,color:"#708090",name:"Steel"},TOOLS:{type:"TOOLS",baseValue:800,color:"#DAA520",name:"Tools"},GOODS:{type:"GOODS",baseValue:600,color:"#4682B4",name:"Goods"}};let b=F;class B{constructor(t,e){this.width=t,this.height=e,this.grid=[],this.initializeMap()}getWidth(){return this.width}getHeight(){return this.height}initializeMap(){for(let t=0;t<this.height;t++){const e=[];for(let i=0;i<this.width;i++)e.push({x:i,y:t,trackType:"none",bitmaskValue:0,segmentID:null,terrainType:"GRASS"});this.grid.push(e)}this.generateTerrain(),this.placeInitialIndustries()}generateTerrain(){for(let s=0;s<15;s++){let n=Math.floor(Math.random()*this.width),a=Math.floor(Math.random()*this.height);this.growCluster(n,a,"FOREST",.6,5)}for(let s=0;s<5;s++){let n=Math.floor(Math.random()*this.width),a=Math.floor(Math.random()*this.height);this.growCluster(n,a,"WATER",.7,8)}for(let s=0;s<3;s++){let n=Math.floor(Math.random()*this.width),a=Math.floor(Math.random()*this.height);this.growCluster(n,a,"MOUNTAIN",.8,4)}}growCluster(t,e,i,s,n){const a=[{x:t,y:e}],o=new Set;let r=0;for(;a.length>0&&r<n;){const l=a.shift(),h=`${l.x},${l.y}`;if(o.has(h))continue;o.add(h);const d=this.getTile(l.x,l.y);if(d){d.terrainType=i,r++;const u=[{x:l.x+1,y:l.y},{x:l.x-1,y:l.y},{x:l.x,y:l.y+1},{x:l.x,y:l.y-1}];for(const p of u)Math.random()<s&&a.push(p)}}}placeInitialIndustries(){this.forcePlaceStation("CITY"),this.forcePlaceStation("COAL_MINE"),this.forcePlaceStation("STEEL_MILL")}forcePlaceStation(t){let e=!1,i=0;for(;!e&&i<50;){const s=Math.floor(Math.random()*(this.width-2))+1,n=Math.floor(Math.random()*(this.height-2))+1,a=this.getTile(s,n);a&&a.trackType==="none"&&a.terrainType==="GRASS"&&(a.trackType="station",a.stationType=t,this.configureStationType(a,t),this.updateBitmask(s,n),this.updateNeighbors(s,n),e=!0),i++}}configureStationType(t,e){switch(e){case"COAL_MINE":t.produces=[g.COAL],t.accepts=[g.PASSENGERS];break;case"IRON_MINE":t.produces=[g.IRON_ORE],t.accepts=[g.PASSENGERS];break;case"STEEL_MILL":t.produces=[g.STEEL],t.accepts=[g.COAL,g.IRON_ORE];break;case"TOOL_FACTORY":t.produces=[g.TOOLS],t.accepts=[g.STEEL];break;case"CITY":t.produces=[g.PASSENGERS],t.accepts=[g.TOOLS,g.GOODS,g.PASSENGERS];break}}restoreStation(t,e,i){const s=this.getTile(t,e);s&&(s.trackType="station",s.stationType=i,this.configureStationType(s,i),this.updateBitmask(t,e),this.updateNeighbors(t,e))}getTile(t,e){return t<0||t>=this.width||e<0||e>=this.height?null:this.grid[e][t]}placeTrack(t,e,i,s,n){const a=this.getTile(t,e);if(!a||a.trackType==="rail"||a.trackType==="station"||a.terrainType==="WATER"||a.terrainType==="MOUNTAIN")return!1;let o=50;return a.terrainType==="FOREST"&&(o+=20),i&&!i.deduct(o)?!1:(a.terrainType==="FOREST"&&(a.terrainType="GRASS"),a.trackType="rail",this.updateBitmask(t,e),s&&n!==void 0&&s.registerTrack(t,e,n),this.updateNeighbors(t,e),!0)}placeStation(t,e,i){const s=this.getTile(t,e);if(!s||s.trackType==="station"||s.terrainType==="WATER"||s.terrainType==="MOUNTAIN")return!1;let n=200;if(s.terrainType==="FOREST"&&(n+=50),i&&!i.deduct(n))return!1;s.terrainType==="FOREST"&&(s.terrainType="GRASS"),s.trackType="station";const a=["COAL_MINE","IRON_MINE","STEEL_MILL","TOOL_FACTORY","CITY"],o=a[Math.floor(Math.random()*a.length)];return s.stationType=o,this.configureStationType(s,o),this.updateBitmask(t,e),this.updateNeighbors(t,e),!0}updateNeighbors(t,e){for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++)s===0&&i===0||this.updateBitmask(t+s,e+i)}updateBitmask(t,e){const i=this.getTile(t,e);if(!i||i.trackType!=="rail"&&i.trackType!=="station")return;const s=[];s.push(this.hasTrack(t,e-1)),s.push(this.hasTrack(t+1,e)),s.push(this.hasTrack(t,e+1)),s.push(this.hasTrack(t-1,e)),s.push(this.hasTrack(t+1,e-1)),s.push(this.hasTrack(t+1,e+1)),s.push(this.hasTrack(t-1,e+1)),s.push(this.hasTrack(t-1,e-1)),i.bitmaskValue=U.calculateBitmask(s)}hasTrack(t,e){const i=this.getTile(t,e);return i!==null&&(i.trackType==="rail"||i.trackType==="station")}getTrackPath(t,e){const i=[],s=e.x-t.x,n=e.y-t.y,a=s>=0?1:-1;for(let l=0;l<=Math.abs(s);l++)i.push({x:t.x+l*a,y:t.y});const o=t.x+s,r=n>=0?1:-1;for(let l=1;l<=Math.abs(n);l++)i.push({x:o,y:t.y+l*r});return i}buildTrackPath(t,e,i,s){let n=!1;for(const a of t)this.placeTrack(a.x,a.y,e,i,s)&&(n=!0);return n}}var M=(c=>(c.NORMAL="normal",c.FAST="fast",c.HEAVY="heavy",c))(M||{});const G=class G{static getTrainInfo(t){return this.trainData[t]}static getAllTrains(){return Object.values(this.trainData)}};G.trainData={normal:{type:"normal",speed:2,cost:100,name:"Normal",color:"#FF0000"},fast:{type:"fast",speed:4,cost:200,name:"Fast",color:"#00FF00"},heavy:{type:"heavy",speed:1.5,cost:150,name:"Heavy",color:"#0000FF"}};let I=G;class D{constructor(t,e,i,s,n){this.currentDirection=null,this.x=t,this.y=e,this.lastX=t,this.lastY=e,this.progress=.5,this.trainType=i||"normal";const a=I.getTrainInfo(this.trainType);a?this.speed=a.speed:(console.error("TrainActor: Invalid trainType:",i),this.speed=1),this.startTime=s,this.cargoType=n||b.getRandomCargo();const o=b.getCargoInfo(this.cargoType);this.cargoValue=o?o.baseValue:100,this.cargo={}}getVisualPosition(){let t=0,e=0;if(this.currentDirection!==null&&this.progress<1){const i=this.progress;this.currentDirection===0?e=-i:this.currentDirection===1?t=i:this.currentDirection===2?e=i:this.currentDirection===3&&(t=-i)}return{x:this.x+t,y:this.y+e,direction:this.currentDirection}}tick(t,e){this.currentDirection===null&&this.pickNextDirection(t),this.currentDirection!==null&&(this.progress+=this.speed*e,this.progress>=1&&this.moveTile(t))}pickNextDirection(t){const e=t.getTile(this.x,this.y);if(!e)return;const i=e.bitmaskValue,s=[];if(i&1&&s.push(0),i&2&&s.push(1),i&4&&s.push(2),i&8&&s.push(3),s.length>0){if(s.length>1){const n=s.filter(a=>{let o=this.x,r=this.y;return a===0?r-=1:a===1?o+=1:a===2?r+=1:a===3&&(o-=1),!(o===this.lastX&&r===this.lastY)});if(n.length>0){this.currentDirection=n[0];return}}this.currentDirection=s[0]}}moveTile(t){this.lastX=this.x,this.lastY=this.y,this.currentDirection===0?this.y-=1:this.currentDirection===1?this.x+=1:this.currentDirection===2?this.y+=1:this.currentDirection===3&&(this.x-=1),this.progress=0,this.currentDirection=null}}class ${constructor(t){this.isActive=!1,this.selectedTool="terrain",this.selectedBrush="GRASS",this.game=t}setActive(t){this.isActive=t;const e=document.getElementById("editor-ui");e&&(e.style.display=t?"block":"none");const i=document.getElementById("ui-layer");i&&(i.style.display=t?"none":"block")}isEditorActive(){return this.isActive}setTool(t,e){this.selectedTool=t,this.selectedBrush=e,console.log(`Tool: ${t}, Brush: ${e}`),this.updateUI()}handleClick(t,e){if(!this.isActive)return;const i=this.game.map,s=i.getTile(t,e);s&&(this.selectedTool==="terrain"?s.trackType==="none"&&(s.terrainType=this.selectedBrush):this.selectedTool==="station"?s.trackType==="none"&&i.restoreStation(t,e,this.selectedBrush):this.selectedTool==="clear"&&(s.trackType="none",s.terrainType="GRASS",s.bitmaskValue=0,s.stationType=void 0,s.produces=[],s.accepts=[],i.updateNeighbors(t,e),this.game.selectedSpawnStation&&this.game.selectedSpawnStation.x===t&&this.game.selectedSpawnStation.y===e&&(this.game.selectedSpawnStation=null,this.game.updateUI())))}setupUI(){document.getElementById("tool-grass")?.addEventListener("click",()=>this.setTool("terrain","GRASS")),document.getElementById("tool-water")?.addEventListener("click",()=>this.setTool("terrain","WATER")),document.getElementById("tool-forest")?.addEventListener("click",()=>this.setTool("terrain","FOREST")),document.getElementById("tool-mountain")?.addEventListener("click",()=>this.setTool("terrain","MOUNTAIN")),document.getElementById("tool-city")?.addEventListener("click",()=>this.setTool("station","CITY")),document.getElementById("tool-coal")?.addEventListener("click",()=>this.setTool("station","COAL_MINE")),document.getElementById("tool-iron")?.addEventListener("click",()=>this.setTool("station","IRON_MINE")),document.getElementById("tool-steel")?.addEventListener("click",()=>this.setTool("station","STEEL_MILL")),document.getElementById("tool-factory")?.addEventListener("click",()=>this.setTool("station","TOOL_FACTORY")),document.getElementById("tool-clear")?.addEventListener("click",()=>this.setTool("clear","CLEAR")),document.getElementById("editor-exit")?.addEventListener("click",()=>{this.setActive(!1),this.game.menuManager.setState("main_menu")}),document.getElementById("editor-save")?.addEventListener("click",()=>{this.game.saveGame(),alert("Map Saved!")})}updateUI(){document.querySelectorAll(".editor-btn").forEach(i=>i.classList.remove("active"));let e="";this.selectedTool==="terrain"?(this.selectedBrush==="GRASS"&&(e="tool-grass"),this.selectedBrush==="WATER"&&(e="tool-water"),this.selectedBrush==="FOREST"&&(e="tool-forest"),this.selectedBrush==="MOUNTAIN"&&(e="tool-mountain")):this.selectedTool==="station"?(this.selectedBrush==="CITY"&&(e="tool-city"),this.selectedBrush==="COAL_MINE"&&(e="tool-coal"),this.selectedBrush==="IRON_MINE"&&(e="tool-iron"),this.selectedBrush==="STEEL_MILL"&&(e="tool-steel"),this.selectedBrush==="TOOL_FACTORY"&&(e="tool-factory")):e="tool-clear",e&&document.getElementById(e)?.classList.add("active")}}var R=(c=>(c.NONE="NONE",c.RAIN="RAIN",c.SNOW="SNOW",c.GOLD_RUSH="GOLD_RUSH",c.STRIKE="STRIKE",c))(R||{});class W{constructor(){this.activeEvent=null,this.lastEventTime=0,this.eventInterval=5}update(t){if(this.activeEvent){if(t>=this.activeEvent.startTime+this.activeEvent.duration){const e=this.activeEvent.name;return this.activeEvent=null,this.lastEventTime=t,`Event Ended: ${e}`}return null}if(t-this.lastEventTime>this.eventInterval){if(Math.random()<.7){this.startRandomEvent(t);const e=this.activeEvent;if(e)return`Event Started: ${e.name}`}this.lastEventTime+=1}return null}startRandomEvent(t){const e=Math.random();let i="NONE";switch(e<.3?i="RAIN":e<.5?i="SNOW":e<.8?i="GOLD_RUSH":i="STRIKE",i){case"RAIN":this.activeEvent={type:"RAIN",name:"Heavy Rain",description:"Slippery tracks! Trains move at 80% speed.",duration:2,startTime:t,modifiers:{speed:.8}};break;case"SNOW":this.activeEvent={type:"SNOW",name:"Blizzard",description:"Freezing cold! Trains move at 60% speed.",duration:3,startTime:t,modifiers:{speed:.6}};break;case"GOLD_RUSH":this.activeEvent={type:"GOLD_RUSH",name:"Gold Rush",description:"High demand! Revenue x2.",duration:4,startTime:t,modifiers:{revenue:2}};break;case"STRIKE":this.activeEvent={type:"STRIKE",name:"Union Strike",description:"Workers are unhappy. Revenue reduced to 50%.",duration:2,startTime:t,modifiers:{revenue:.5}};break}}getActiveEvent(){return this.activeEvent}getSpeedModifier(){return this.activeEvent?.modifiers.speed||1}getRevenueModifier(){return this.activeEvent?.modifiers.revenue||1}updateUI(){const t=document.getElementById("event-banner"),e=document.getElementById("event-icon"),i=document.getElementById("event-name");if(!(!t||!e||!i))if(this.activeEvent)switch(t.style.display="flex",i.textContent=this.activeEvent.name,this.activeEvent.type){case"RAIN":e.textContent="üåßÔ∏è",i.style.color="#74C0FC";break;case"SNOW":e.textContent="‚ùÑÔ∏è",i.style.color="#A5D8FF";break;case"GOLD_RUSH":e.textContent="üí∞",i.style.color="#FFD43B";break;case"STRIKE":e.textContent="üö´",i.style.color="#FF6B6B";break}else t.style.display="none"}}class H{constructor(t){this.tileSize=40,this.weatherParticles=[],this.lastWeatherType=null,this.stars=[],this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context");this.ctx=e,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const t=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*t,this.canvas.height=window.innerHeight*t,this.canvas.style.width=`${window.innerWidth}px`,this.canvas.style.height=`${window.innerHeight}px`,this.ctx.scale(t,t)}render(t,e,i,s,n,a,o,r,l){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore();try{const h=o%1;let d=1;h<.2?d=.3:h<.3?d=.3+(h-.2)*7:h<.7?d=1:h<.8?d=1-(h-.7)*7:d=.3;const u=d<.5;this.drawBackgroundGrid(n,h),this.ctx.save();try{const p=window.innerWidth/2,y=window.innerHeight/2;this.ctx.translate(p,y),this.ctx.scale(n.zoom,n.zoom),this.ctx.translate(-p,-y),this.ctx.translate(-n.x,-n.y),this.drawGrid(t,a,h,u),l&&this.drawHoverTile(l.x,l.y,t),this.drawTrains(e,u),this.drawNotifications(i),s.render(this.ctx,this.tileSize,0,0)}finally{this.ctx.restore()}this.drawDayNightOverlay(h),r&&this.drawWeather(r)}catch(h){console.error("Render Error:",h)}}generateStars(){this.stars=[];const t=100;for(let e=0;e<t;e++)this.stars.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,size:Math.random()*2,alpha:Math.random()})}drawBackgroundGrid(t,e){this.ctx.save();const i=this.ctx.createLinearGradient(0,0,0,window.innerHeight);if(e<.2||e>.8?(i.addColorStop(0,"#0f0c29"),i.addColorStop(1,"#302b63")):e<.3?(i.addColorStop(0,"#ff9966"),i.addColorStop(1,"#ff5e62")):e<.7?(i.addColorStop(0,"#2980b9"),i.addColorStop(1,"#6dd5fa")):(i.addColorStop(0,"#2c3e50"),i.addColorStop(1,"#fd746c")),this.ctx.fillStyle=i,this.ctx.fillRect(0,0,window.innerWidth,window.innerHeight),e<.25||e>.75){this.stars.length===0&&this.generateStars(),this.ctx.fillStyle="white";for(const s of this.stars)Math.random()>.95?this.ctx.globalAlpha=Math.random():this.ctx.globalAlpha=s.alpha,this.ctx.fillRect(s.x,s.y,s.size,s.size)}this.ctx.restore()}drawDayNightOverlay(t){}drawWeather(t){const e=t.getActiveEvent();if(!e){this.lastWeatherType=null,this.weatherParticles=[];return}if(this.lastWeatherType!==e.type&&(this.lastWeatherType=e.type,this.generateWeatherParticles(e.type)),this.ctx.save(),e.type===R.RAIN){this.ctx.strokeStyle="rgba(174, 194, 224, 0.7)",this.ctx.lineWidth=2;for(const i of this.weatherParticles)i.y+=i.speed,i.y>window.innerHeight&&(i.y=-10,i.x=Math.random()*window.innerWidth),this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y),this.ctx.lineTo(i.x-3,i.y+10),this.ctx.stroke();this.ctx.fillStyle="rgba(0, 0, 50, 0.1)",this.ctx.fillRect(0,0,window.innerWidth,window.innerHeight)}else if(e.type===R.SNOW){this.ctx.fillStyle="rgba(255, 255, 255, 0.9)";for(const i of this.weatherParticles)i.y+=i.speed,i.x+=Math.sin(i.y*.01)*.5,i.y>window.innerHeight&&(i.y=-10,i.x=Math.random()*window.innerWidth),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,i.size,0,Math.PI*2),this.ctx.fill();this.ctx.fillStyle="rgba(200, 200, 255, 0.1)",this.ctx.fillRect(0,0,window.innerWidth,window.innerHeight)}this.ctx.restore()}generateWeatherParticles(t){this.weatherParticles=[];const e=t===R.RAIN?150:80;for(let i=0;i<e;i++)this.weatherParticles.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,speed:t===R.RAIN?8+Math.random()*4:1+Math.random()*2,size:t===R.SNOW?Math.random()*3+1:1})}drawGrid(t,e,i,s){for(let n=0;n<t.getHeight();n++)for(let a=0;a<t.getWidth();a++){const o=t.getTile(a,n);if(!o)continue;const r=a*this.tileSize,l=n*this.tileSize;this.drawTerrain(r,l,o.terrainType,i,a,n)}for(let n=0;n<t.getHeight();n++)for(let a=0;a<t.getWidth();a++){const o=t.getTile(a,n);if(!o)continue;const r=a*this.tileSize,l=n*this.tileSize;if(o.trackType==="rail")this.drawEnhancedTrack(r,l,o.bitmaskValue);else if(o.trackType==="station"){const h=e&&e.x===a&&e.y===n;this.drawEnhancedStation(r,l,o.stationType,h||!1,s)}}}drawTerrain(t,e,i,s,n,a){const o=this.tileSize;switch(i){case"WATER":this.ctx.fillStyle="#4A90E2",this.ctx.fillRect(t,e,o,o),this.ctx.fillStyle="rgba(255,255,255,0.2)";const r=Math.sin(s*20+n+a)*3;this.ctx.fillRect(t+5+r,e+10,10,2),this.ctx.fillRect(t+20-r,e+25,8,2);break;case"FOREST":this.ctx.fillStyle="#2d5a27",this.ctx.fillRect(t,e,o,o),this.drawTree(t+5,e+5,"#1e3c1a"),this.drawTree(t+20,e+15,"#1a3316"),this.drawTree(t+10,e+25,"#22441e");break;case"MOUNTAIN":this.ctx.fillStyle="#7f8c8d",this.ctx.fillRect(t,e,o,o),this.ctx.fillStyle="#95a5a6",this.ctx.beginPath(),this.ctx.moveTo(t,e+o),this.ctx.lineTo(t+o/2,e+5),this.ctx.lineTo(t+o,e+o),this.ctx.fill(),this.ctx.fillStyle="#ecf0f1",this.ctx.beginPath(),this.ctx.moveTo(t+o/2,e+5),this.ctx.lineTo(t+o/2-5,e+15),this.ctx.lineTo(t+o/2+5,e+15),this.ctx.fill();break;case"GRASS":default:this.ctx.fillStyle="#7CFC00",this.ctx.fillRect(t,e,o,o),this.ctx.fillStyle="rgba(0,0,0,0.03)",(n+a)%2===0&&this.ctx.fillRect(t,e,o,o),this.ctx.fillStyle="#66cc00",(n*3+a*7)%5===0&&(this.ctx.fillRect(t+5,e+5,2,2),this.ctx.fillRect(t+8,e+4,2,2));break}this.ctx.strokeStyle="rgba(0,0,0,0.05)",this.ctx.strokeRect(t,e,o,o)}drawTree(t,e,i){this.ctx.fillStyle="#5d4037",this.ctx.fillRect(t+3,e+10,4,6),this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.moveTo(t+5,e),this.ctx.lineTo(t,e+10),this.ctx.lineTo(t+10,e+10),this.ctx.fill()}drawEnhancedTrack(t,e,i){const s=this.tileSize;this.ctx.fillStyle="#7f8c8d",this.ctx.fillRect(t,e,s,s),this.ctx.fillStyle="rgba(0,0,0,0.1)";for(let E=0;E<5;E++)this.ctx.fillRect(t+Math.random()*s,e+Math.random()*s,2,2);const n=this.ctx,a=!!(i&1),o=!!(i&2),r=!!(i&4),l=!!(i&8),h=4,d=12,u=24,p=4,y="#3e2723",S="#bdc3c7",m="#7f8c8d";n.save(),n.translate(t+s/2,e+s/2);const k=E=>{n.save(),n.rotate(E),n.fillStyle=y,n.fillRect(-u/2,-s/2+4,u,p),n.fillRect(-u/2,-2,u,p),n.fillRect(-u/2,s/2-8,u,p),n.restore()},x=E=>{n.save(),n.rotate(E),k(0),n.fillStyle=S,n.strokeStyle=m,n.lineWidth=1;const T=-d/2-h/2,w=d/2-h/2;n.fillRect(T,-s/2,h,s),n.strokeRect(T,-s/2,h,s),n.fillRect(w,-s/2,h,s),n.strokeRect(w,-s/2,h,s),n.restore()},A=E=>{n.save(),n.rotate(E),n.fillStyle=y,n.save(),n.rotate(Math.PI/4),n.fillRect(-u/2,-p/2,u,p),n.restore(),n.save(),n.rotate(Math.PI/8),n.translate(0,-s/3),n.fillRect(-u/2,-p/2,u,p),n.restore(),n.save(),n.rotate(3*Math.PI/8),n.translate(0,-s/3),n.fillRect(-u/2,-p/2,u,p),n.restore(),n.strokeStyle=m,n.lineWidth=h,n.lineCap="butt";const T=s/2-d/2,w=s/2+d/2;n.beginPath(),n.arc(s/2,-s/2,w,Math.PI/2,Math.PI),n.stroke(),n.strokeStyle=S,n.lineWidth=h-2,n.stroke(),n.strokeStyle=m,n.lineWidth=h,n.beginPath(),n.arc(s/2,-s/2,T,Math.PI/2,Math.PI),n.stroke(),n.strokeStyle=S,n.lineWidth=h-2,n.stroke(),n.restore()};!a&&!o&&!r&&!l?x(Math.PI/2):a&&r&&!o&&!l?x(0):o&&l&&!a&&!r?x(Math.PI/2):a&&!o&&!r&&!l||r&&!o&&!a&&!l?x(0):o&&!a&&!r&&!l||l&&!a&&!r&&!o?x(Math.PI/2):a&&o&&!r&&!l?A(0):o&&r&&!a&&!l?A(Math.PI/2):r&&l&&!a&&!o?A(Math.PI):l&&a&&!r&&!o?A(-Math.PI/2):((a||r)&&x(0),(o||l)&&x(Math.PI/2)),n.restore()}drawEnhancedStation(t,e,i,s,n){const a=this.tileSize;let o="#6B8E23",r="#8B4513",l="#5D4037";switch(i){case"COAL_MINE":o="#2F4F4F",r="#34495e",l="#2c3e50";break;case"IRON_MINE":o="#8B4513",r="#e67e22",l="#a04000";break;case"STEEL_MILL":o="#7f8c8d",r="#95a5a6",l="#34495e";break;case"TOOL_FACTORY":o="#f39c12",r="#f1c40f",l="#d35400";break;case"CITY":o="#bdc3c7",r="#ecf0f1",l="#2980b9";break}const h=this.ctx.createLinearGradient(t,e,t,e+a);h.addColorStop(0,o),h.addColorStop(1,"#2c3e50"),this.ctx.fillStyle=h,this.ctx.fillRect(t,e,a,a),this.ctx.fillStyle=r,this.ctx.fillRect(t+6,e+6,a-12,a-12),this.ctx.fillStyle=l,this.ctx.beginPath(),this.ctx.moveTo(t+4,e+6),this.ctx.lineTo(t+a/2,e-2),this.ctx.lineTo(t+a-4,e+6),this.ctx.fill(),n?(this.ctx.fillStyle="#f1c40f",this.ctx.shadowColor="#f39c12",this.ctx.shadowBlur=10):(this.ctx.fillStyle="#34495e",this.ctx.shadowBlur=0),this.ctx.fillRect(t+10,e+12,6,6),this.ctx.fillRect(t+24,e+12,6,6),this.ctx.shadowBlur=0,i&&(this.ctx.fillStyle="#FFF",this.ctx.font="bold 10px Inter",this.ctx.textAlign="center",this.ctx.fillText(i.split("_")[0],t+a/2,e+a-4)),s&&(this.ctx.strokeStyle="#2ecc71",this.ctx.lineWidth=2,this.ctx.strokeRect(t+1,e+1,a-2,a-2))}drawTrains(t,e){for(const i of t){const s=I.getTrainInfo(i.trainType),n=b.getCargoInfo(i.cargoType),a=i.getVisualPosition(),o=a.x*this.tileSize+this.tileSize/2,r=a.y*this.tileSize+this.tileSize/2;if(this.ctx.save(),a.direction!==null){this.ctx.translate(o,r);const l=a.direction*(Math.PI/2);this.ctx.rotate(l),this.ctx.translate(-o,-r)}this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.fillRect(o-12,r-6,20,16),this.ctx.fillStyle=s.color,this.ctx.fillRect(o-14,r-8,20,16),this.ctx.fillStyle="rgba(255,255,255,0.2)",this.ctx.fillRect(o-14,r-2,20,4),this.ctx.fillStyle="#2c3e50",this.ctx.fillRect(o-12,r-6,8,12),this.ctx.fillStyle="#111",this.ctx.beginPath(),this.ctx.arc(o+4,r,4,0,Math.PI*2),this.ctx.fill(),e&&(this.ctx.save(),this.ctx.translate(o+10,r),this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(60,-20),this.ctx.lineTo(60,20),this.ctx.fillStyle="rgba(255, 255, 200, 0.4)",this.ctx.fill(),this.ctx.restore()),this.ctx.fillStyle=n.color,this.ctx.fillRect(o-28,r-7,12,14),this.ctx.strokeStyle="#2c3e50",this.ctx.lineWidth=1,this.ctx.strokeRect(o-28,r-7,12,14),this.ctx.fillStyle="#000",this.ctx.fillRect(o-16,r-1,4,2),this.ctx.restore()}}drawNotifications(t){const e=t.getNotifications();for(const i of e){const s=1-i.age/i.lifetime;this.ctx.save(),this.ctx.globalAlpha=s,this.ctx.font="bold 14px Inter",this.ctx.fillStyle=i.color,this.ctx.strokeStyle="rgba(0,0,0,0.8)",this.ctx.lineWidth=3,this.ctx.textAlign="center";const n=i.x*this.tileSize+this.tileSize/2,a=i.y*this.tileSize;this.ctx.strokeText(i.text,n,a),this.ctx.fillText(i.text,n,a),this.ctx.restore()}}drawGhostTracks(t){if(t.length===0)return;this.ctx.save(),this.ctx.globalAlpha=.6;const e=new Set;for(const i of t)e.add(`${i.x},${i.y}`);for(const i of t){const s=i.x*this.tileSize,n=i.y*this.tileSize,a=[];a.push(e.has(`${i.x},${i.y-1}`)),a.push(e.has(`${i.x+1},${i.y}`)),a.push(e.has(`${i.x},${i.y+1}`)),a.push(e.has(`${i.x-1},${i.y}`));let o=0;a[0]&&(o|=1),a[1]&&(o|=2),a[2]&&(o|=4),a[3]&&(o|=8),this.drawEnhancedTrack(s,n,o)}this.ctx.restore()}drawHoverTile(t,e,i){const s=this.tileSize,n=t*s,a=e*s,o=i.getTile(t,e),r=o&&o.trackType==="none";this.ctx.save(),this.ctx.strokeStyle=r?"rgba(82, 196, 26, 0.8)":"rgba(255, 77, 79, 0.8)",this.ctx.lineWidth=3,this.ctx.strokeRect(n+2,a+2,s-4,s-4),this.ctx.strokeStyle=r?"rgba(82, 196, 26, 0.3)":"rgba(255, 77, 79, 0.3)",this.ctx.lineWidth=6,this.ctx.strokeRect(n+2,a+2,s-4,s-4),this.ctx.restore()}getTileFromScreen(t,e,i){const s=window.innerWidth/2,n=window.innerHeight/2,a=(t-s)/i.zoom+s+i.x,o=(e-n)/i.zoom+n+i.y,r=Math.floor(a/this.tileSize),l=Math.floor(o/this.tileSize);return{x:r,y:l}}}class Y{calculateRevenue(t,e,i,s){const n=Math.max(1,e*20/s),a=1/(1+Math.pow(i/n,2));return t*a}}class L{constructor(t){this.balance=t}getBalance(){return this.balance}canAfford(t){return this.balance>=t}deduct(t){return this.canAfford(t)?(this.balance-=t,!0):!1}add(t){this.balance+=t}}class N{constructor(){this.totalTicks=0,this.gameSpeed=1,this.TICKS_PER_DAY=24}tick(t){this.totalTicks+=t*this.gameSpeed}setSpeed(t){this.gameSpeed=t}getSpeed(){return this.gameSpeed}getGameTimeDays(){return this.totalTicks/this.TICKS_PER_DAY}getDayString(){const t=Math.floor(this.getGameTimeDays()),e=Math.floor((this.getGameTimeDays()-t)*24);return`Day ${t}, ${e}h`}}class K{constructor(){this.notifications=[],this.nextId=0}addNotification(t,e,i,s="#FFD700"){this.notifications.push({id:this.nextId++,text:t,x:e,y:i,lifetime:2,age:0,color:s})}update(t){for(let e=this.notifications.length-1;e>=0;e--)this.notifications[e].age+=t,this.notifications[e].y-=20*t,this.notifications[e].age>=this.notifications[e].lifetime&&this.notifications.splice(e,1)}getNotifications(){return this.notifications}}const O=class O{static save(t,e,i,s,n,a,o,r){const l={version:this.VERSION,economy:{balance:t.getBalance()},time:{totalTicks:e.getGameTimeDays()*24,gameSpeed:e.getSpeed()},trains:i.map(h=>({x:h.x,y:h.y,trainType:h.trainType,cargoType:h.cargoType,startTime:h.startTime})),map:{width:s.getWidth(),height:s.getHeight(),tiles:this.serializeMap(s)},progression:{xp:n.getXp(),level:n.getLevel(),unlocks:Array.from(n.unlockFlags||[])},statistics:a.getStats(),achievements:o.getUnlockedAchievements(),selectedSpawn:r};try{localStorage.setItem(this.SAVE_KEY,JSON.stringify(l))}catch(h){console.error("Failed to save game:",h)}}static load(){try{const t=localStorage.getItem(this.SAVE_KEY);if(!t)return null;const e=JSON.parse(t);return e.version!==this.VERSION?(console.warn("Save version mismatch or old save"),null):e}catch(t){return console.error("Failed to load game:",t),null}}static serializeMap(t){const e=[];for(let i=0;i<t.getHeight();i++)for(let s=0;s<t.getWidth();s++){const n=t.getTile(s,i);n&&(n.trackType!=="none"||n.terrainType!=="GRASS")&&e.push({x:s,y:i,trackType:n.trackType,stationType:n.stationType,terrainType:n.terrainType,bitmaskValue:n.bitmaskValue})}return e}};O.SAVE_KEY="railsim_save",O.VERSION=2;let P=O;class z{constructor(){this.stats={totalRevenue:0,totalDeliveries:0,playtimeSeconds:0,highestRevenue:0}}recordDelivery(t){this.stats.totalRevenue+=t,this.stats.totalDeliveries++,t>this.stats.highestRevenue&&(this.stats.highestRevenue=t)}updatePlaytime(t){this.stats.playtimeSeconds+=t}getStats(){return{...this.stats}}loadStats(t){this.stats={...t}}loadData(t){this.loadStats(t)}}class X{constructor(){this.achievements=new Map,this.initializeAchievements()}initializeAchievements(){this.addAchievement({id:"first_delivery",name:"First Delivery",description:"Complete your first delivery",unlocked:!1,icon:"üöÇ"}),this.addAchievement({id:"millionaire",name:"Millionaire",description:"Earn $10,000 total revenue",unlocked:!1,icon:"üí∞"}),this.addAchievement({id:"speed_demon",name:"Speed Demon",description:"Complete a delivery in under 5 days",unlocked:!1,icon:"‚ö°"}),this.addAchievement({id:"train_collector",name:"Train Collector",description:"Own 10 trains simultaneously",unlocked:!1,icon:"üöÜ"})}addAchievement(t){this.achievements.set(t.id,t)}unlock(t){const e=this.achievements.get(t);return e&&!e.unlocked?(e.unlocked=!0,console.log(`Achievement unlocked: ${e.name}`),!0):!1}checkAchievements(t){const e=[];return t.deliveries>=1&&this.unlock("first_delivery")&&e.push("first_delivery"),t.totalRevenue>=1e4&&this.unlock("millionaire")&&e.push("millionaire"),t.lastDeliveryTime&&t.lastDeliveryTime<5&&this.unlock("speed_demon")&&e.push("speed_demon"),t.trainCount>=10&&this.unlock("train_collector")&&e.push("train_collector"),e}getAchievements(){return Array.from(this.achievements.values())}getUnlockedCount(){return Array.from(this.achievements.values()).filter(t=>t.unlocked).length}getUnlockedAchievements(){return Array.from(this.achievements.values()).filter(t=>t.unlocked).map(t=>t.id)}loadData(t){for(const e of t){const i=this.achievements.get(e);i&&(i.unlocked=!0)}}}class q{constructor(){this.currentTooltip=null,this.tooltipElement=document.createElement("div"),this.tooltipElement.id="game-tooltip",this.tooltipElement.style.cssText=`
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            max-width: 200px;
            line-height: 1.4;
        `,document.body.appendChild(this.tooltipElement)}showTrainTooltip(t,e,i){const s=I.getTrainInfo(t.trainType),n=b.getCargoInfo(t.cargoType),a=[`üöÇ ${s.name} Train`,`üì¶ Cargo: ${n.name} ($${n.baseValue})`,`‚ö° Speed: ${s.speed.toFixed(1)} tiles/sec`,`üìç Position: (${t.x}, ${t.y})`];this.show(a,e,i)}showStationTooltip(t,e,i,s){const n=["üè≠ Station",`üìç Location: (${t}, ${e})`,"üí∞ Delivery point"];this.show(n,i,s)}show(t,e,i){this.tooltipElement.innerHTML=t.join("<br>"),this.tooltipElement.style.left=e+15+"px",this.tooltipElement.style.top=i+15+"px",this.tooltipElement.style.display="block"}hide(){this.tooltipElement.style.display="none"}}class j{constructor(){this.updateTimer=0,this.UPDATE_INTERVAL=10,this.prices=new Map,this.initializePrices()}initializePrices(){const t=b.getAllCargos();for(const e of t)this.prices.set(e.type,{cargoType:e.type,basePrice:e.baseValue,currentMultiplier:1,trend:0})}update(t){t-this.updateTimer>=this.UPDATE_INTERVAL&&(this.updatePrices(),this.updateTimer=t)}updatePrices(){for(const[t,e]of this.prices){const i=(Math.random()-.5)*.3;e.currentMultiplier=Math.max(.5,Math.min(2,e.currentMultiplier+i)),i>.05?e.trend=1:i<-.05?e.trend=-1:e.trend=0}console.log("Market prices updated!")}getCurrentPrice(t){const e=this.prices.get(t);return e?Math.floor(e.basePrice*e.currentMultiplier):b.getCargoInfo(t).baseValue}getPriceInfo(t){return this.prices.get(t)}getAllPrices(){return Array.from(this.prices.values())}}class Z{constructor(){this.DEGRADATION_RATE=.01,this.REPAIR_COST_PER_TILE=10,this.CRITICAL_HEALTH=.3,this.trackHealth=new Map}getKey(t,e){return`${t},${e}`}registerTrack(t,e,i){const s=this.getKey(t,e);this.trackHealth.has(s)||this.trackHealth.set(s,{x:t,y:e,health:1,lastMaintenance:i})}update(t){for(const[e,i]of this.trackHealth){const n=(t-i.lastMaintenance)*this.DEGRADATION_RATE;i.health=Math.max(0,1-n)}}repairTrack(t,e,i,s){const n=this.getKey(t,e),a=this.trackHealth.get(n);return!a||a.health>=1?!1:i.deduct(this.REPAIR_COST_PER_TILE)?(a.health=1,a.lastMaintenance=s,!0):!1}getTrackHealth(t,e){const i=this.getKey(t,e),s=this.trackHealth.get(i);return s?s.health:1}getCriticalTracks(){return Array.from(this.trackHealth.values()).filter(t=>t.health<this.CRITICAL_HEALTH)}getTotalMaintenanceCost(){return this.getCriticalTracks().length*this.REPAIR_COST_PER_TILE}}class J{constructor(){this.audioContext=null,this.enabled=!0,this.musicEnabled=!0,this.volume=.5,this.musicOscillators=[],this.musicGain=null,this.isPlayingMusic=!1,window.addEventListener("click",()=>this.initAudioContext(),{once:!0}),window.addEventListener("keydown",()=>this.initAudioContext(),{once:!0})}initAudioContext(){if(this.audioContext)return;const t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t,this.musicEnabled&&this.startAmbientMusic()}playSound(t){if(!this.enabled||!this.audioContext)return;const e=this.audioContext,i=e.currentTime,s=e.createOscillator(),n=e.createGain();switch(s.connect(n),n.connect(e.destination),n.gain.setValueAtTime(this.volume*.3,i),t){case"click":s.type="sine",s.frequency.setValueAtTime(800,i),s.frequency.exponentialRampToValueAtTime(400,i+.1),n.gain.exponentialRampToValueAtTime(.01,i+.1),s.start(i),s.stop(i+.1);break;case"build":s.type="square",s.frequency.setValueAtTime(100,i),s.frequency.linearRampToValueAtTime(50,i+.1),n.gain.setValueAtTime(this.volume*.4,i),n.gain.exponentialRampToValueAtTime(.01,i+.2),s.start(i),s.stop(i+.2),this.playNoise(.2);break;case"train":this.playNoise(.1,200);break;case"delivery":s.type="sine",s.frequency.setValueAtTime(1200,i),s.frequency.setValueAtTime(1600,i+.1),n.gain.setValueAtTime(this.volume*.3,i),n.gain.exponentialRampToValueAtTime(.01,i+.4),s.start(i),s.stop(i+.4);break;case"achievement":this.playNote(523.25,i,.1,"triangle"),this.playNote(659.25,i+.1,.1,"triangle"),this.playNote(783.99,i+.2,.1,"triangle"),this.playNote(1046.5,i+.3,.4,"triangle");break;case"whistle":this.playNote(587.33,i,.4,"triangle"),this.playNote(698.46,i,.4,"triangle"),this.playNote(587.33,i+.1,.4,"triangle");break;case"error":s.type="sawtooth",s.frequency.setValueAtTime(150,i),s.frequency.linearRampToValueAtTime(100,i+.2),n.gain.exponentialRampToValueAtTime(.01,i+.3),s.start(i),s.stop(i+.3);break;case"ui-click":s.type="sine",s.frequency.setValueAtTime(600,i),s.frequency.exponentialRampToValueAtTime(300,i+.1),n.gain.setValueAtTime(this.volume*.2,i),n.gain.exponentialRampToValueAtTime(.01,i+.1),s.start(i),s.stop(i+.1);break;case"ui-hover":s.type="sine",s.frequency.setValueAtTime(400,i),n.gain.setValueAtTime(this.volume*.05,i),n.gain.exponentialRampToValueAtTime(.01,i+.05),s.start(i),s.stop(i+.05);break}}playNote(t,e,i,s="sine"){if(!this.audioContext)return;const n=this.audioContext,a=n.createOscillator(),o=n.createGain();a.type=s,a.frequency.value=t,a.connect(o),o.connect(n.destination),o.gain.setValueAtTime(this.volume*.2,e),o.gain.exponentialRampToValueAtTime(.01,e+i),a.start(e),a.stop(e+i)}playNoise(t,e){if(!this.audioContext)return;const i=this.audioContext,s=i.sampleRate*t,n=i.createBuffer(1,s,i.sampleRate),a=n.getChannelData(0);for(let l=0;l<s;l++)a[l]=Math.random()*2-1;const o=i.createBufferSource();o.buffer=n;const r=i.createGain();if(r.gain.setValueAtTime(this.volume*.1,i.currentTime),r.gain.exponentialRampToValueAtTime(.01,i.currentTime+t),e){const l=i.createBiquadFilter();l.type="lowpass",l.frequency.value=e,o.connect(l),l.connect(r)}else o.connect(r);r.connect(i.destination),o.start()}startAmbientMusic(){if(!this.audioContext||this.isPlayingMusic)return;this.isPlayingMusic=!0,this.musicGain=this.audioContext.createGain(),this.musicGain.gain.value=this.volume*.1,this.musicGain.connect(this.audioContext.destination),[220,277.18,329.63].forEach(e=>{const i=this.audioContext.createOscillator();i.type="sine",i.frequency.value=e,i.connect(this.musicGain),i.start(),this.musicOscillators.push(i);const s=this.audioContext.createOscillator();s.frequency.value=.1+Math.random()*.1;const n=this.audioContext.createGain();n.gain.value=5,s.connect(n),n.connect(i.frequency),s.start()})}stopAmbientMusic(){this.musicOscillators.forEach(t=>t.stop()),this.musicOscillators=[],this.isPlayingMusic=!1}toggleSound(){this.enabled=!this.enabled,this.musicEnabled=this.enabled,this.musicEnabled?this.startAmbientMusic():this.stopAmbientMusic()}toggleMusic(){this.musicEnabled=!this.musicEnabled,this.musicEnabled?this.startAmbientMusic():this.stopAmbientMusic()}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this.musicGain&&(this.musicGain.gain.value=this.volume*.1)}isSoundEnabled(){return this.enabled}}class Q{constructor(){this.currentStep=0,this.active=!1,this.overlay=null,this.completed=!1,this.steps=this.createSteps(),this.checkIfCompleted()}checkIfCompleted(){const t=localStorage.getItem("railsim_tutorial_completed");this.completed=t==="true"}createSteps(){return[{id:"welcome",title:"üöÇ Welcome to RailSim!",message:"Build your railway empire! Let's learn the basics.",position:"center"},{id:"build_track",title:"üõ§Ô∏è Build Tracks",message:"Left-click on tiles to place tracks ($50 each). Try building a few!",position:"top"},{id:"build_station",title:"üöâ Build Station",message:"Right-click to place a station ($200). Stations are delivery points!",position:"top"},{id:"buy_train",title:"üöÇ Buy a Train",message:'Click "Buy Train" button to purchase your first train. It will automatically navigate!',position:"bottom"},{id:"watch_delivery",title:"üí∞ Watch & Earn",message:"Your train will deliver cargo to stations. Faster delivery = more money!",position:"center"},{id:"advanced",title:"üéì Advanced Tips",message:"Try: Different train types, station types, hover for info, check statistics!",position:"center"},{id:"complete",title:"‚úÖ Tutorial Complete!",message:"You're ready to build your empire. Good luck!",position:"center"}]}start(){this.completed||(this.active=!0,this.currentStep=0,this.showStep())}skip(){this.active=!1,this.completed=!0,localStorage.setItem("railsim_tutorial_completed","true"),this.hideOverlay()}showStep(){if(this.currentStep>=this.steps.length){this.complete();return}const t=this.steps[this.currentStep];this.createOverlay(t)}createOverlay(t){this.hideOverlay(),this.overlay=document.createElement("div"),this.overlay.style.cssText=`
            position: fixed;
            ${t.position==="center"?"top: 50%; left: 50%; transform: translate(-50%, -50%);":""}
            ${t.position==="top"?"top: 100px; left: 50%; transform: translateX(-50%);":""}
            ${t.position==="bottom"?"bottom: 100px; left: 50%; transform: translateX(-50%);":""}
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            z-index: 10000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 2px solid #4A90E2;
        `,this.overlay.innerHTML=`
            <h2 style="margin: 0 0 12px 0; font-size: 20px;">${t.title}</h2>
            <p style="margin: 0 0 16px 0; line-height: 1.5;">${t.message}</p>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button id="tutorial-skip" style="padding: 8px 16px; background: #666; border: none; border-radius: 4px; color: white; cursor: pointer;">Skip Tutorial</button>
                <button id="tutorial-next" style="padding: 8px 16px; background: #4A90E2; border: none; border-radius: 4px; color: white; cursor: pointer;">Next</button>
            </div>
        `,document.body.appendChild(this.overlay),document.getElementById("tutorial-next")?.addEventListener("click",()=>this.nextStep()),document.getElementById("tutorial-skip")?.addEventListener("click",()=>this.skip())}hideOverlay(){this.overlay&&(this.overlay.remove(),this.overlay=null)}nextStep(){this.currentStep++,this.showStep()}complete(){this.active=!1,this.completed=!0,localStorage.setItem("railsim_tutorial_completed","true"),this.hideOverlay()}isActive(){return this.active}isCompleted(){return this.completed}getCurrentStep(){return this.currentStep}reset(){localStorage.removeItem("railsim_tutorial_completed"),this.completed=!1,this.start()}}var v=(c=>(c.SMOKE="smoke",c.SPARKLE="sparkle",c.DUST="dust",c.STAR="star",c.STEAM="steam",c.SPARKS="sparks",c))(v||{});class tt{constructor(){this.particles=[]}emit(t,e,i,s=10){for(let n=0;n<s;n++)this.particles.push(this.createParticle(t,e,i))}createParticle(t,e,i){const s={x:e,y:i,vx:0,vy:0,life:0,maxLife:1,size:4,color:"#FFF",type:t,alpha:1};switch(t){case"smoke":s.vx=(Math.random()-.5)*10,s.vy=-20-Math.random()*20,s.maxLife=1.5,s.size=6+Math.random()*4,s.color=`rgba(100, 100, 100, ${.5+Math.random()*.3})`;break;case"sparkle":const n=Math.random()*Math.PI*2,a=30+Math.random()*40;s.vx=Math.cos(n)*a,s.vy=Math.sin(n)*a,s.maxLife=.8,s.size=3+Math.random()*3,s.color="#FFD700";break;case"dust":s.vx=(Math.random()-.5)*30,s.vy=-10-Math.random()*20,s.maxLife=.6,s.size=3+Math.random()*2,s.color="#8B7355";break;case"star":const o=Math.random()*Math.PI*2,r=50+Math.random()*50;s.vx=Math.cos(o)*r,s.vy=Math.sin(o)*r,s.maxLife=1.2,s.size=4+Math.random()*4;const l=["#FFD700","#FF6B6B","#51CF66","#4A90E2","#9B59B6"];s.color=l[Math.floor(Math.random()*l.length)];break;case"steam":s.vx=(Math.random()-.5)*5,s.vy=-15-Math.random()*10,s.maxLife=2,s.size=4+Math.random()*6,s.color=`rgba(255, 255, 255, ${.3+Math.random()*.2})`;break;case"sparks":const h=Math.random()*Math.PI,d=20+Math.random()*30;s.vx=Math.cos(h)*d,s.vy=-Math.abs(Math.sin(h)*d),s.maxLife=.4,s.size=2+Math.random()*2,s.color="#FFD700";break}return s}update(t){for(let e=this.particles.length-1;e>=0;e--){const i=this.particles[e];i.x+=i.vx*t,i.y+=i.vy*t,i.type!=="smoke"&&(i.vy+=100*t),i.vx*=.98,i.vy*=.98,i.life+=t,i.alpha=1-i.life/i.maxLife,i.life>=i.maxLife&&this.particles.splice(e,1)}}render(t,e,i,s){for(const n of this.particles){t.save(),t.globalAlpha=n.alpha;const a=n.x*e+i,o=n.y*e+s;n.type==="star"?this.drawStar(t,a,o,n.size,n.color):(t.fillStyle=n.color,t.beginPath(),t.arc(a,o,n.size,0,Math.PI*2),t.fill()),t.restore()}}drawStar(t,e,i,s,n){t.fillStyle=n,t.beginPath();for(let a=0;a<5;a++){const o=a*4*Math.PI/5-Math.PI/2,r=a%2===0?s:s/2,l=e+Math.cos(o)*r,h=i+Math.sin(o)*r;a===0?t.moveTo(l,h):t.lineTo(l,h)}t.closePath(),t.fill()}getParticleCount(){return this.particles.length}}var f=(c=>(c.MAIN_MENU="main_menu",c.PLAYING="playing",c.PAUSED="paused",c.SETTINGS="settings",c))(f||{});class et{constructor(){this.currentState="main_menu",this.mainMenuElement=null,this.pauseMenuElement=null,this.settingsMenuElement=null,this.createMenus()}createMenus(){this.createMainMenu(),this.createPauseMenu(),this.createSettingsMenu()}createMainMenu(){this.mainMenuElement=document.createElement("div"),this.mainMenuElement.id="main-menu",this.mainMenuElement.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `,this.mainMenuElement.innerHTML=`
            <div class="glass-panel" style="padding: 60px; text-align: center; min-width: 400px; border: 1px solid rgba(255,255,255,0.1);">
                <h1 style="font-size: 72px; margin: 0 0 10px 0; background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));">
                    üöÇ RailSim
                </h1>
                <p style="font-size: 18px; margin: 0 0 50px 0; color: #a0a0a0; letter-spacing: 1px; text-transform: uppercase;">
                    Build Your Railway Empire
                </p>
                <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                    <button id="btn-new-game" class="primary" style="width: 100%; justify-content: center; padding: 16px; font-size: 16px;">
                        <span>‚ñ∂</span> New Game
                    </button>
                    <button id="btn-continue" style="width: 100%; justify-content: center; padding: 16px; font-size: 16px;">
                        <span>‚èØ</span> Continue
                    </button>
                    <div style="display: flex; gap: 10px; width: 100%;">
                         <button id="btn-editor" style="flex: 1; justify-content: center;">üõ† Editor</button>
                         <button id="btn-tutorial-menu" style="flex: 1; justify-content: center;">üéì Tutorial</button>
                    </div>
                    <button id="btn-settings-menu" style="width: 100%; justify-content: center;">‚öô Settings</button>
                </div>
                <p style="margin-top: 40px; color: #666; font-size: 12px;">
                    v1.1 ‚Ä¢ Premium Edition
                </p>
            </div>
        `,document.body.appendChild(this.mainMenuElement)}setCallbacks(t){document.getElementById("btn-new-game")?.addEventListener("click",t.onStartGame),document.getElementById("btn-continue")?.addEventListener("click",t.onResumeGame),document.getElementById("btn-editor")?.addEventListener("click",t.onOpenEditor),document.getElementById("btn-resume")?.addEventListener("click",t.onResumeGame),document.getElementById("btn-main-menu")?.addEventListener("click",t.onExitToMain),document.getElementById("btn-settings-menu")?.addEventListener("click",t.onOpenSettings),document.getElementById("btn-settings-pause")?.addEventListener("click",t.onOpenSettings),document.getElementById("btn-close-settings")?.addEventListener("click",()=>{this.settingsMenuElement.style.display="none",this.currentState==="paused"?this.pauseMenuElement.style.display="flex":this.mainMenuElement.style.display="flex"})}createPauseMenu(){this.pauseMenuElement=document.createElement("div"),this.pauseMenuElement.id="pause-menu",this.pauseMenuElement.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        `,this.pauseMenuElement.innerHTML=`
            <div class="glass-panel" style="text-align: center; padding: 40px; min-width: 300px;">
                <h2 style="font-size: 32px; margin: 0 0 30px 0; color: #FFF;">Paused</h2>
                <div style="display: flex; flex-direction: column; gap: 16px; align-items: center;">
                    <button id="btn-resume" class="primary" style="width: 100%; justify-content: center;">Resume</button>
                    <button id="btn-settings-pause" style="width: 100%; justify-content: center;">Settings</button>
                    <button id="btn-main-menu" class="danger" style="width: 100%; justify-content: center;">Main Menu</button>
                </div>
            </div>
        `,document.body.appendChild(this.pauseMenuElement)}createSettingsMenu(){this.settingsMenuElement=document.createElement("div"),this.settingsMenuElement.id="settings-menu",this.settingsMenuElement.style.cssText=`
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 16px;
            border: 2px solid #4A90E2;
            display: none;
            z-index: 10000;
            min-width: 400px;
        `,this.settingsMenuElement.innerHTML=`
            <div class="glass-panel" style="padding: 30px; min-width: 400px;">
                <h2 style="margin: 0 0 24px 0; color: #FFF; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Settings</h2>
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div>
                        <label style="color: #CCC; display: block; margin-bottom: 8px; font-size: 14px;">Sound Volume</label>
                        <input type="range" id="sound-volume" min="0" max="100" value="50" style="width: 100%; accent-color: #4facfe;">
                    </div>
                    <div>
                        <label style="color: #CCC; display: block; margin-bottom: 8px; font-size: 14px;">Auto-save Interval</label>
                        <select id="autosave-interval" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); color: #FFF; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                            <option value="30">30 seconds</option>
                            <option value="60">1 minute</option>
                            <option value="300">5 minutes</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button id="btn-reset-tutorial" style="flex: 1; justify-content: center;">Reset Tutorial</button>
                        <button id="btn-clear-save" class="danger" style="flex: 1; justify-content: center;">Clear Save</button>
                    </div>
                    <button id="btn-close-settings" style="width: 100%; justify-content: center; margin-top: 10px;">Close</button>
                </div>
            </div>
        `,document.body.appendChild(this.settingsMenuElement)}setState(t){this.currentState=t,this.updateVisibility()}updateVisibility(){this.mainMenuElement&&(this.mainMenuElement.style.display=this.currentState==="main_menu"?"flex":"none"),this.pauseMenuElement&&(this.pauseMenuElement.style.display=this.currentState==="paused"?"flex":"none"),this.settingsMenuElement&&(this.settingsMenuElement.style.display=this.currentState==="settings"?"block":"none")}getState(){return this.currentState}setupEventListeners(t){document.getElementById("btn-new-game")?.addEventListener("click",t.onNewGame),document.getElementById("btn-continue")?.addEventListener("click",t.onContinue),document.getElementById("btn-tutorial-menu")?.addEventListener("click",t.onTutorial),document.getElementById("btn-resume")?.addEventListener("click",t.onResume),document.getElementById("btn-main-menu")?.addEventListener("click",t.onMainMenu),document.getElementById("btn-reset-tutorial")?.addEventListener("click",t.onResetTutorial),document.getElementById("btn-clear-save")?.addEventListener("click",t.onClearSave),document.getElementById("btn-settings-menu")?.addEventListener("click",()=>{this.setState("settings")}),document.getElementById("btn-settings-pause")?.addEventListener("click",()=>{this.setState("settings")}),document.getElementById("btn-close-settings")?.addEventListener("click",()=>{this.setState("main_menu")})}}class it{constructor(){this.victoryConditions={targetRevenue:5e4,targetDeliveries:100},this.victoryScreenElement=null,this.isVictoryAchieved=!1,this.createVictoryScreen()}createVictoryScreen(){this.victoryScreenElement=document.createElement("div"),this.victoryScreenElement.id="victory-screen",this.victoryScreenElement.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30, 60, 114, 0.95) 0%, rgba(42, 82, 152, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        `,this.victoryScreenElement.innerHTML=`
            <div style="text-align: center; animation: slideIn 0.5s ease;">
                <h1 id="victory-title" style="font-size: 72px; margin: 0 0 20px 0; color: #FFD700; text-shadow: 0 4px 8px rgba(0,0,0,0.5);">
                    üèÜ Victory!
                </h1>
                <p id="victory-subtitle" style="font-size: 24px; margin: 0 0 40px 0; color: #E0E0E0;">
                    You've built a successful railway empire!
                </p>
                
                <div style="background: rgba(0,0,0,0.3); padding: 30px; border-radius: 12px; margin-bottom: 40px; min-width: 400px;">
                    <h3 style="margin: 0 0 20px 0; color: #FFF;">Final Statistics</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: left; color: #CCC;">
                        <div>üí∞ Total Revenue:</div>
                        <div id="final-revenue" style="color: #FFD700; font-weight: bold;">$0</div>
                        
                        <div>üì¶ Deliveries:</div>
                        <div id="final-deliveries" style="color: #51CF66; font-weight: bold;">0</div>
                        
                        <div>‚è±Ô∏è Time Played:</div>
                        <div id="final-time" style="color: #4A90E2; font-weight: bold;">0 days</div>
                        
                        <div>üöÇ Trains Owned:</div>
                        <div id="final-trains" style="color: #FF6B6B; font-weight: bold;">0</div>
                        
                        <div>üèÜ Achievements:</div>
                        <div id="final-achievements" style="color: #9B59B6; font-weight: bold;">0/4</div>
                        
                        <div>üíé Highest Delivery:</div>
                        <div id="final-highest" style="color: #FFD700; font-weight: bold;">$0</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 16px; justify-content: center;">
                    <button id="btn-play-again" class="menu-button" style="width: 200px;">Play Again</button>
                    <button id="btn-victory-menu" class="menu-button" style="width: 200px;">Main Menu</button>
                </div>
            </div>
        `,document.body.appendChild(this.victoryScreenElement)}checkVictory(t){if(this.isVictoryAchieved)return!1;const e=this.victoryConditions.targetRevenue?t.totalRevenue>=this.victoryConditions.targetRevenue:!1,i=this.victoryConditions.targetDeliveries?t.totalDeliveries>=this.victoryConditions.targetDeliveries:!1;return e||i?(this.isVictoryAchieved=!0,!0):!1}showVictoryScreen(t){this.victoryScreenElement&&(document.getElementById("final-revenue").textContent=`$${Math.floor(t.totalRevenue)}`,document.getElementById("final-deliveries").textContent=t.totalDeliveries.toString(),document.getElementById("final-time").textContent=`${Math.floor(t.gameDays)} days`,document.getElementById("final-trains").textContent=t.trainCount.toString(),document.getElementById("final-achievements").textContent=`${t.achievementCount}/4`,document.getElementById("final-highest").textContent=`$${Math.floor(t.highestRevenue)}`,this.victoryScreenElement.style.display="flex")}hide(){this.victoryScreenElement&&(this.victoryScreenElement.style.display="none"),this.isVictoryAchieved=!1}setupEventListeners(t){document.getElementById("btn-play-again")?.addEventListener("click",t.onPlayAgain),document.getElementById("btn-victory-menu")?.addEventListener("click",t.onMainMenu)}}class st{constructor(){this.xp=0,this.level=1,this.nextLevelXp=1e3,this.unlockFlags=new Set,this.activeBonuses={speed:1,capacity:1,revenue:1},this.rewards=[{level:2,description:"Unlock Fast Trains",unlocks:["FAST_TRAIN"]},{level:3,description:"+10% Revenue",bonus:{type:"REVENUE",value:1.1}},{level:4,description:"Unlock Heavy Trains",unlocks:["HEAVY_TRAIN"]},{level:5,description:"+20% Train Speed",bonus:{type:"SPEED",value:1.2}},{level:6,description:"Master Tycoon Status"}],this.load()}addXp(t){this.xp+=t;const e=[];for(;this.xp>=this.nextLevelXp;)this.levelUp(e);return this.save(),e}levelUp(t){this.xp-=this.nextLevelXp,this.level++,this.nextLevelXp=Math.floor(this.nextLevelXp*1.5);const e=this.rewards.find(i=>i.level===this.level);e?(t.push(`Level Up! ${this.level}: ${e.description}`),e.unlocks&&e.unlocks.forEach(i=>this.unlockFlags.add(i)),e.bonus&&(e.bonus.type==="SPEED"&&(this.activeBonuses.speed*=e.bonus.value),e.bonus.type==="CAPACITY"&&(this.activeBonuses.capacity*=e.bonus.value),e.bonus.type==="REVENUE"&&(this.activeBonuses.revenue*=e.bonus.value))):t.push(`Level Up! You are now level ${this.level}`)}getLevel(){return this.level}getXp(){return this.xp}getNextLevelXp(){return this.nextLevelXp}getBonuses(){return this.activeBonuses}isUnlocked(t){return this.unlockFlags.has(t)}save(){const t={xp:this.xp,level:this.level,nextLevelXp:this.nextLevelXp,unlockFlags:Array.from(this.unlockFlags),activeBonuses:this.activeBonuses};localStorage.setItem("railsim_progression",JSON.stringify(t))}loadData(t){t&&(this.xp=t.xp,this.level=t.level,this.nextLevelXp=t.nextLevelXp,this.unlockFlags=new Set(t.unlockFlags),this.activeBonuses=t.activeBonuses||{speed:1,capacity:1,revenue:1})}load(){const t=localStorage.getItem("railsim_progression");t&&this.loadData(JSON.parse(t))}}class nt{constructor(){this.goals=[],this.currentGoalIndex=0,this.goalElement=null,this.goalTextElement=null,this.initializeGoals(),this.goalElement=document.getElementById("goal-container"),this.goalTextElement=document.getElementById("current-goal-text"),this.updateUI()}initializeGoals(){this.goals=[{id:"g1",description:"Earn $500",target:500,current:0,type:"money",completed:!1,reward:100},{id:"g2",description:"Buy 2 Trains",target:2,current:0,type:"trains",completed:!1,reward:200},{id:"g3",description:"Deliver 10 Cargo",target:10,current:0,type:"delivery",completed:!1,reward:300},{id:"g4",description:"Earn $2000",target:2e3,current:0,type:"money",completed:!1,reward:500},{id:"g5",description:"Buy 5 Trains",target:5,current:0,type:"trains",completed:!1,reward:1e3}]}updateProgress(t,e){if(this.currentGoalIndex>=this.goals.length)return;const i=this.goals[this.currentGoalIndex];i.type===t&&!i.completed&&(t==="money"?i.current=e:i.current+=e,i.current>=i.target?this.completeGoal(i):this.updateUI())}completeGoal(t){t.completed=!0,t.current=t.target,console.log(`Goal Completed: ${t.description}! Reward: $${t.reward}`),this.currentGoalIndex++,this.updateUI()}getCurrentGoal(){return this.currentGoalIndex<this.goals.length?this.goals[this.currentGoalIndex]:null}updateUI(){if(!this.goalTextElement||!this.goalElement)return;const t=this.getCurrentGoal();t?(this.goalTextElement.textContent=`${t.description} (${t.current}/${t.target})`,this.goalTextElement.style.color="#FFD700",this.goalElement.classList.remove("pulse"),this.goalElement.offsetWidth,this.goalElement.classList.add("pulse")):(this.goalTextElement.textContent="All Goals Completed!",this.goalTextElement.style.color="#51CF66",this.goalTextElement.style.textShadow="0 0 10px #51CF66")}}class at{constructor(t,e){this.x=0,this.y=0,this.zoom=1,this.minZoom=.5,this.maxZoom=2,this.x=t,this.y=e}move(t,e){this.x+=t,this.y+=e}setZoom(t,e,i){const s=Math.max(this.minZoom,Math.min(this.maxZoom,t));s-this.zoom,this.zoom=s}zoomIn(t){this.zoom=Math.min(this.maxZoom,this.zoom+t)}zoomOut(t){this.zoom=Math.max(this.minZoom,this.zoom-t)}}class ot{constructor(){this.trains=[],this.lastTime=0,this.selectedSpawnStation=null,this.selectedTrainType=M.NORMAL,this.autoSaveInterval=0,this.isPaused=!1,this.keys={},this.isDragging=!1,this.dragStartTile=null,this.dragEndTile=null,this.currentMouseTile=null;const t=document.getElementById("gameCanvas");this.renderer=new H(t),this.map=new B(20,15),this.trains=[],this.revenueSimulator=new Y,this.economy=new L(1e3),this.timeManager=new N,this.notificationManager=new K,this.statisticsManager=new z,this.achievementManager=new X,this.tooltipManager=new q,this.marketManager=new j,this.maintenanceManager=new Z,this.audioManager=new J,this.tutorialManager=new Q,this.particleManager=new tt,this.menuManager=new et,this.victoryManager=new it,this.progressionManager=new st,this.goalManager=new nt,this.eventManager=new W,this.camera=new at(0,0),this.editorManager=new $(this),this.lastTime=performance.now();const e=P.load();e?this.loadGame(e):(this.camera.x=-100,this.camera.y=-100),this.setupInput(t),this.setupUIControls(),this.setupMenuCallbacks(),this.setupVictoryCallbacks(),this.editorManager.setupUI(),this.updateUI(),this.loop(),setInterval(()=>{this.isPaused||this.saveGame()},3e4)}saveGame(){const t=document.getElementById("auto-save-indicator");t&&(t.style.opacity="1",setTimeout(()=>{t.style.opacity="0"},1500)),P.save(this.economy,this.timeManager,this.trains,this.map,this.progressionManager,this.statisticsManager,this.achievementManager,this.selectedSpawnStation)}loadGame(t){console.log("Loading save data...",t),t&&t.economy?this.economy=new L(t.economy.balance):this.economy=new L(1e3),this.timeManager=new N,t&&t.time&&this.timeManager.setSpeed(t.time.gameSpeed);const e=t&&t.map&&t.map.width?t.map.width:20,i=t&&t.map&&t.map.height?t.map.height:15;if(this.map=new B(e,i),t&&t.map&&t.map.tiles)for(const s of t.map.tiles){const n=this.map.getTile(s.x,s.y);n&&(n.trackType=s.trackType,n.stationType=s.stationType,n.terrainType=s.terrainType||"GRASS",n.bitmaskValue=s.bitmaskValue||0,n.trackType==="station"&&n.stationType&&this.map.restoreStation(n.x,n.y,n.stationType))}if(this.trains=[],t&&t.trains)for(const s of t.trains){const n=new D(s.x,s.y,s.trainType,s.startTime,s.cargoType);this.trains.push(n)}t&&t.progression&&this.progressionManager.loadData(t.progression),t&&t.statistics&&this.statisticsManager.loadData(t.statistics),t&&t.achievements&&this.achievementManager.loadData(t.achievements),t&&t.selectedSpawn&&(this.selectedSpawnStation=t.selectedSpawn),this.updateUI(),console.log("Game loaded!")}setupUIControls(){document.getElementById("btn-buy-train")?.addEventListener("click",()=>{this.buyTrain()}),document.getElementById("btn-pause")?.addEventListener("click",()=>{this.timeManager.setSpeed(0),this.isPaused=!0}),document.getElementById("btn-play")?.addEventListener("click",()=>{this.timeManager.setSpeed(1),this.isPaused=!1}),document.getElementById("btn-fast")?.addEventListener("click",()=>{this.timeManager.setSpeed(5),this.isPaused=!1}),document.getElementById("btn-train-normal")?.addEventListener("click",()=>{this.selectedTrainType=M.NORMAL,this.updateUI()}),document.getElementById("btn-train-fast")?.addEventListener("click",()=>{this.selectedTrainType=M.FAST,this.updateUI()}),document.getElementById("btn-train-heavy")?.addEventListener("click",()=>{this.selectedTrainType=M.HEAVY,this.updateUI()}),document.getElementById("stats-toggle")?.addEventListener("click",()=>{const e=document.getElementById("stats-panel"),i=document.getElementById("stats-toggle");if(e&&i){const s=e.style.display==="none";e.style.display=s?"block":"none",i.textContent=s?"üìä Statistics ‚ñº":"üìä Statistics ‚ñ∂"}this.audioManager.playSound("click")}),document.getElementById("btn-sound-toggle")?.addEventListener("click",()=>{this.audioManager.toggleSound();const e=document.getElementById("btn-sound-toggle");e&&(e.textContent=this.audioManager.isSoundEnabled()?"üîä":"üîá")})}buyTrain(){if(console.log("buyTrain called, balance:",this.economy.getBalance()),!this.selectedSpawnStation){this.notificationManager.addNotification("Select a spawn station first (press E)!",10,10,"#FF0000");return}const t=this.map.getTile(this.selectedSpawnStation.x,this.selectedSpawnStation.y);if(!t||t.trackType!=="station"){this.notificationManager.addNotification("Not a station! Build a station with Q.",10,10,"#FF0000"),this.audioManager.playSound("error");return}this.selectedSpawnStation.x===t.x&&(this.selectedSpawnStation.y,t.y);const e=I.getTrainInfo(this.selectedTrainType);if(this.economy.deduct(e.cost)){const i=g.PASSENGERS,s=new D(this.selectedSpawnStation.x,this.selectedSpawnStation.y,this.selectedTrainType,this.timeManager.getGameTimeDays(),i);this.trains.push(s),this.updateUI(),this.audioManager.playSound("build"),this.audioManager.playSound("build"),this.audioManager.playSound("whistle"),this.goalManager.updateProgress("trains",1),this.particleManager.emit(v.SMOKE,this.selectedSpawnStation.x,this.selectedSpawnStation.y,10),!this.tutorialManager.isCompleted()&&this.tutorialManager.getCurrentStep()===1&&this.tutorialManager.nextStep()}else this.notificationManager.addNotification("Not enough money!",this.selectedSpawnStation.x,this.selectedSpawnStation.y,"#FF0000"),this.audioManager.playSound("error")}setupInput(t){t.addEventListener("mousedown",e=>{const i=t.getBoundingClientRect(),s=e.clientX-i.left,n=e.clientY-i.top,a=this.renderer.getTileFromScreen(s,n,this.camera);if(this.editorManager.isEditorActive()){e.button===0&&(this.editorManager.handleClick(a.x,a.y),this.updateUI());return}e.button===0&&(this.isDragging=!0,this.dragStartTile={x:a.x,y:a.y},this.dragEndTile={x:a.x,y:a.y})}),t.addEventListener("contextmenu",e=>e.preventDefault()),t.addEventListener("mousemove",e=>{const i=t.getBoundingClientRect(),s=e.clientX-i.left,n=e.clientY-i.top,a=this.renderer.getTileFromScreen(s,n,this.camera);this.currentMouseTile={x:a.x,y:a.y},this.isDragging?(this.dragEndTile={x:a.x,y:a.y},this.updateBuildCostPreview()):this.hideBuildCostPreview();let o=!1;for(const r of this.trains){const l=r.getVisualPosition(),h=t.width/2,d=t.height/2,u=(s-h)/this.camera.zoom+h+this.camera.x,p=(n-d)/this.camera.zoom+d+this.camera.y,y=(l.x+.5)*40,S=(l.y+.5)*40,m=u-y,k=p-S;if(Math.sqrt(m*m+k*k)<20){this.tooltipManager.showTrainTooltip(r,e.clientX,e.clientY),o=!0;break}}if(!o){const r=this.map.getTile(a.x,a.y);r&&r.trackType==="station"?this.tooltipManager.showStationTooltip(a.x,a.y,e.clientX,e.clientY):this.tooltipManager.hide()}}),t.addEventListener("mouseleave",()=>{this.tooltipManager.hide(),this.isDragging=!1,this.dragStartTile=null,this.dragEndTile=null}),window.addEventListener("mouseup",e=>{if(this.isDragging&&this.dragStartTile&&this.dragEndTile){const i=this.map.getTrackPath(this.dragStartTile,this.dragEndTile);this.map.buildTrackPath(i,this.economy,this.maintenanceManager,this.timeManager.getGameTimeDays())&&(this.audioManager.playSound("build"),this.particleManager.emit(v.DUST,this.dragEndTile.x+.5,this.dragEndTile.y+.5,8),this.updateUI())}this.isDragging=!1,this.dragStartTile=null,this.dragEndTile=null,this.hideBuildCostPreview()}),window.addEventListener("keydown",e=>{if(this.keys[e.code]=!0,e.code==="KeyQ"){if(this.currentMouseTile){const i=this.currentMouseTile;this.map.placeStation(i.x,i.y,this.economy)&&(this.audioManager.playSound("build"),this.particleManager.emit(v.DUST,i.x+.5,i.y+.5,12),this.selectedSpawnStation||(this.selectedSpawnStation={x:i.x,y:i.y},this.notificationManager.addNotification("Spawn Point Set!",i.x,i.y,"#00FF00")),this.updateUI())}}else if(e.code==="KeyE"){if(this.currentMouseTile){const i=this.currentMouseTile,s=this.map.getTile(i.x,i.y);s&&s.trackType==="station"&&(this.selectedSpawnStation={x:i.x,y:i.y},console.log("Selected spawn station:",i.x,i.y),this.notificationManager.addNotification("Spawn Point Set!",i.x,i.y,"#00FF00"),this.updateUI())}}else if(e.code==="Space"){let i=0,s=0,n=!1;if(this.selectedSpawnStation)i=this.selectedSpawnStation.x,s=this.selectedSpawnStation.y,n=!0;else if(this.currentMouseTile){const a=this.map.getTile(this.currentMouseTile.x,this.currentMouseTile.y);a&&(a.trackType==="rail"||a.trackType==="station")&&(i=this.currentMouseTile.x,s=this.currentMouseTile.y,n=!0)}if(n){const a=new D(i,s,M.NORMAL,this.timeManager.getGameTimeDays());this.trains.push(a),this.audioManager.playSound("build"),this.particleManager.emit(v.SMOKE,i,s,10),this.updateUI()}else this.notificationManager.addNotification("Invalid Spawn!",10,10,"#FF0000"),this.audioManager.playSound("error")}else e.code==="Escape"&&(this.menuManager.getState()===f.PLAYING?(this.menuManager.setState(f.PAUSED),this.isPaused=!0):this.menuManager.getState()===f.PAUSED&&(this.menuManager.setState(f.PLAYING),this.isPaused=!1))}),window.addEventListener("keyup",e=>{this.keys[e.code]=!1}),t.addEventListener("wheel",e=>{e.preventDefault();const i=.1;e.deltaY<0?this.camera.zoomIn(i):this.camera.zoomOut(i)})}setupMenuCallbacks(){this.menuManager.setCallbacks({onStartGame:()=>{this.menuManager.setState(f.PLAYING),this.isPaused=!1,this.trains=[],this.selectedSpawnStation=null,this.economy=new L(1e3),this.timeManager=new N,this.map=new B(60,40),this.updateUI(),this.tutorialManager.isCompleted()||setTimeout(()=>this.tutorialManager.start(),500)},onResumeGame:()=>{this.menuManager.setState(f.PLAYING),this.isPaused=!1},onRestartGame:()=>{localStorage.clear(),location.reload()},onOpenSettings:()=>{this.menuManager.setState(f.SETTINGS)},onExitToMain:()=>{this.menuManager.setState(f.MAIN_MENU),this.isPaused=!0},onOpenEditor:()=>{this.menuManager.setState(f.PLAYING),this.editorManager.setActive(!0),this.isPaused=!0}})}setupVictoryCallbacks(){this.victoryManager.setupEventListeners({onPlayAgain:()=>{this.victoryManager.hide(),this.menuManager.setState(f.PLAYING),this.isPaused=!1,this.trains=[],this.economy=new L(1e3),this.timeManager=new N,this.statisticsManager=new z,this.map=new B(20,15),this.updateUI()},onMainMenu:()=>{this.victoryManager.hide(),this.menuManager.setState(f.MAIN_MENU)}})}updateUI(){const t=document.getElementById("revenue-display");t&&(t.innerText=this.economy.getBalance().toString());const e=document.getElementById("train-count");e&&(e.innerText=this.trains.length.toString());const i=document.getElementById("time-display");i&&(i.innerText=this.timeManager.getDayString());const s=document.getElementById("level-display");s&&(s.innerText=this.progressionManager.getLevel().toString());const n=document.getElementById("xp-display");n&&(n.innerText=`${this.progressionManager.getXp()} / ${this.progressionManager.getNextLevelXp()}`);const a=this.statisticsManager.getStats(),o=document.getElementById("total-revenue");o&&(o.innerText=a.totalRevenue.toString());const r=document.getElementById("total-deliveries");r&&(r.innerText=a.totalDeliveries.toString());const l=document.getElementById("highest-revenue");l&&(l.innerText=a.highestRevenue.toString());const h=document.getElementById("achievement-count");h&&(h.innerText=this.achievementManager.getUnlockedCount().toString());const d=document.getElementById("spawn-station");d&&(this.selectedSpawnStation?d.innerText=`(${this.selectedSpawnStation.x},${this.selectedSpawnStation.y})`:d.innerText="None");const u=document.getElementById("selected-train-type");if(u){const m=I.getTrainInfo(this.selectedTrainType);u.innerText=`${m.name} ($${m.cost})`,u.style.color=m.color}const p=document.getElementById("btn-train-normal"),y=document.getElementById("btn-train-fast"),S=document.getElementById("btn-train-heavy");p&&p.classList.toggle("active",this.selectedTrainType===M.NORMAL),y&&y.classList.toggle("active",this.selectedTrainType===M.FAST),S&&S.classList.toggle("active",this.selectedTrainType===M.HEAVY)}updateBuildCostPreview(){if(!this.dragStartTile||!this.dragEndTile)return;const e=this.map.getTrackPath(this.dragStartTile,this.dragEndTile).length*50,i=document.getElementById("build-cost-preview"),s=document.getElementById("build-cost-amount");if(i&&s){i.style.display="flex",s.textContent=`$${e}`;const n=this.economy.getBalance()>=e;s.style.color=n?"#51CF66":"#FF6B6B"}}hideBuildCostPreview(){const t=document.getElementById("build-cost-preview");t&&(t.style.display="none")}celebrateFirstDelivery(t,e){const i=document.getElementById("gameCanvas");i&&(i.style.animation="screen-shake 0.3s",setTimeout(()=>{i.style.animation=""},300));for(let s=0;s<30;s++){const n=Math.PI*2*s/30,a=2+Math.random()*2,o=Math.cos(n)*a,r=Math.sin(n)*a;this.particleManager.emit(v.SPARKLE,t+o*.5,e+r*.5,1)}this.notificationManager.addNotification("üéâ FIRST DELIVERY! üéâ",t,e-2,"#FFD700"),this.audioManager.playSound("achievement")}loop(){const t=performance.now();let e=(t-this.lastTime)/1e3;this.lastTime=t;const i=500*e;if((this.keys.KeyW||this.keys.ArrowUp)&&this.camera.move(0,-i),(this.keys.KeyS||this.keys.ArrowDown)&&this.camera.move(0,i),(this.keys.KeyA||this.keys.ArrowLeft)&&this.camera.move(-i,0),(this.keys.KeyD||this.keys.ArrowRight)&&this.camera.move(i,0),this.isPaused||this.menuManager.getState()!==f.PLAYING){if(this.menuManager.getState()!==f.MAIN_MENU&&(this.renderer.render(this.map,this.trains,this.notificationManager,this.particleManager,this.camera,this.selectedSpawnStation,this.timeManager.getGameTimeDays(),this.eventManager,this.currentMouseTile),this.isDragging&&this.dragStartTile&&this.dragEndTile)){const n=this.map.getTrackPath(this.dragStartTile,this.dragEndTile);this.renderer.drawGhostTracks(n)}requestAnimationFrame(()=>this.loop());return}const s=this.timeManager.getSpeed();e*=s,this.timeManager.tick(e);try{this.marketManager.update(this.timeManager.getGameTimeDays()),this.maintenanceManager.update(this.timeManager.getGameTimeDays()),this.notificationManager.update(e),this.particleManager.update(e);const n=this.eventManager.update(this.timeManager.getGameTimeDays());n&&(this.notificationManager.addNotification(n,10,5,"#FFA500"),this.audioManager.playSound("achievement"),this.eventManager.updateUI()),this.updateUI();for(let a=this.trains.length-1;a>=0;a--){const o=this.trains[a],r=this.progressionManager.getBonuses(),l=(r?r.speed:1)*this.eventManager.getSpeedModifier();if(o.tick(this.map,e*l),Math.random()<.3){const d=o.getVisualPosition();this.particleManager.emit(v.STEAM,d.x,d.y,1),o.trainType===M.HEAVY&&Math.random()<.1&&this.particleManager.emit(v.SPARKS,d.x,d.y,1)}const h=this.map.getTile(o.x,o.y);if(h&&h.trackType==="station"){const d=Math.abs(o.x-0)+Math.abs(o.y-0),p=this.timeManager.getGameTimeDays()-o.startTime,y=o.speed*50,S=this.marketManager.getCurrentPrice(o.cargoType);let m=this.revenueSimulator.calculateRevenue(S,d,p,y),k=!0;if(h.accepts&&h.accepts.length>0&&(k=h.accepts.includes(o.cargoType)),!k)m*=.2,this.notificationManager.addNotification("Wrong Station!",o.x,o.y-1,"#FF0000");else{m*=this.progressionManager.getBonuses().revenue,m*=this.eventManager.getRevenueModifier();const w=Math.floor(m/10),_=this.progressionManager.addXp(w);for(const C of _)this.notificationManager.addNotification(C,o.x,o.y-2,"#00FFFF"),this.audioManager.playSound("achievement"),this.particleManager.emit(v.STAR,o.x,o.y,30)}this.statisticsManager.recordDelivery(m),this.statisticsManager.getStats().totalDeliveries===1&&this.celebrateFirstDelivery(o.x,o.y);const A=this.achievementManager.checkAchievements({totalRevenue:this.statisticsManager.getStats().totalRevenue,deliveries:this.statisticsManager.getStats().totalDeliveries,trainCount:this.trains.length,lastDeliveryTime:p});for(const w of A){const C=this.achievementManager.getAchievements().find(V=>V.id===w);C&&(this.notificationManager.addNotification(`${C.icon} ${C.name}!`,o.x,o.y-1,"#FFD700"),this.audioManager.playSound("achievement"),this.particleManager.emit(v.STAR,o.x+.5,o.y+.5,20))}const E=b.getCargoInfo(o.cargoType);this.notificationManager.addNotification(`+$${Math.floor(m)}`,o.x,o.y,"#FFD700"),this.audioManager.playSound("delivery"),this.particleManager.emit(v.SPARKLE,o.x+.5,o.y+.5,15),this.economy.add(m),this.goalManager.updateProgress("delivery",1),this.goalManager.updateProgress("money",this.statisticsManager.getStats().totalRevenue),this.updateUI();const T=this.statisticsManager.getStats();this.victoryManager.checkVictory({totalRevenue:T.totalRevenue,totalDeliveries:T.totalDeliveries,gameDays:this.timeManager.getGameTimeDays()})&&(this.victoryManager.showVictoryScreen({totalRevenue:T.totalRevenue,totalDeliveries:T.totalDeliveries,gameDays:this.timeManager.getGameTimeDays(),trainCount:this.trains.length,achievementCount:this.achievementManager.getUnlockedCount(),highestRevenue:T.highestRevenue}),this.isPaused=!0),this.trains.splice(a,1)}}if(Math.random()<.05)for(let a=0;a<this.map.getHeight();a++)for(let o=0;o<this.map.getWidth();o++){const r=this.map.getTile(o,a);r&&r.trackType==="station"&&(r.stationType==="STEEL_MILL"||r.stationType==="COAL_MINE"||r.stationType==="TOOL_FACTORY")&&this.particleManager.emit(v.SMOKE,o+.5,a+.2,1)}if(this.renderer.render(this.map,this.trains,this.notificationManager,this.particleManager,this.camera,this.selectedSpawnStation,this.timeManager.getGameTimeDays(),this.eventManager,this.isDragging?null:this.currentMouseTile),this.isDragging&&this.dragStartTile&&this.dragEndTile){const a=this.map.getTrackPath(this.dragStartTile,this.dragEndTile);this.renderer.drawGhostTracks(a)}}catch(n){console.error("Game Loop Error:",n),this.isPaused=!0,this.notificationManager.addNotification("Game Error! Check Console",10,10,"#FF0000")}requestAnimationFrame(()=>this.loop())}}try{window.game=new ot,console.log("Game initialized successfully")}catch(c){console.error("Failed to initialize game:",c),window.gameError=c}
