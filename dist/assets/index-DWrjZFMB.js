(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}})();class H{static calculateBitmask(t){if(t.length!==8)throw new Error("neighborTracks array must contain exactly 8 boolean values.");let i=0;return t[0]&&(i|=1),t[1]&&(i|=2),t[2]&&(i|=4),t[3]&&(i|=8),t[4]&&(i|=16),t[5]&&(i|=32),t[6]&&(i|=64),t[7]&&(i|=128),i}}var p=(g=>(g.PASSENGERS="PASSENGERS",g.COAL="COAL",g.IRON_ORE="IRON_ORE",g.STEEL="STEEL",g.TOOLS="TOOLS",g.GOODS="GOODS",g.WOOD="WOOD",g.LUMBER="LUMBER",g.OIL="OIL",g.GOLD="GOLD",g))(p||{});const U=class U{static getCargoInfo(t){return this.cargoData[t]}static getRandomCargo(){const t=Object.values(p);return t[Math.floor(Math.random()*t.length)]}static getAllCargos(){return Object.values(this.cargoData)}};U.cargoData={PASSENGERS:{type:"PASSENGERS",baseValue:70,color:"#FFFFFF",name:"Passengers"},COAL:{type:"COAL",baseValue:140,color:"#2C2C2C",name:"Coal"},IRON_ORE:{type:"IRON_ORE",baseValue:175,color:"#8B4513",name:"Iron Ore"},STEEL:{type:"STEEL",baseValue:350,color:"#708090",name:"Steel"},TOOLS:{type:"TOOLS",baseValue:560,color:"#DAA520",name:"Tools"},GOODS:{type:"GOODS",baseValue:420,color:"#4682B4",name:"Goods"},WOOD:{type:"WOOD",baseValue:100,color:"#8B4513",name:"Wood"},LUMBER:{type:"LUMBER",baseValue:280,color:"#D2B48C",name:"Lumber"},OIL:{type:"OIL",baseValue:250,color:"#1A1A1A",name:"Oil"},GOLD:{type:"GOLD",baseValue:700,color:"#FFD700",name:"Gold"}};let k=U;class B{constructor(t,i){this.width=t,this.height=i,this.grid=[],this.initializeMap()}getWidth(){return this.width}getHeight(){return this.height}updateProduction(t){for(let i=0;i<this.height;i++)for(let e=0;e<this.width;e++){const s=this.grid[i][e];s.trackType==="station"&&s.stationType&&this.processStationProduction(s,t)}}processStationProduction(t,i){if(t.storage||(t.storage={}),t.lastProduction||(t.lastProduction=0),t.lastProduction+=i,t.lastProduction<2e3)return;t.lastProduction=0;const e=t.stationType,s=t.storage,n=100;if(e==="COAL_MINE")s[p.COAL]=Math.min(n,(s[p.COAL]||0)+5);else if(e==="IRON_MINE")s[p.IRON_ORE]=Math.min(n,(s[p.IRON_ORE]||0)+5);else if(e==="LUMBER_CAMP")s[p.WOOD]=Math.min(n,(s[p.WOOD]||0)+5);else if(e==="OIL_WELL")s[p.OIL]=Math.min(n,(s[p.OIL]||0)+5);else if(e==="GOLD_MINE")s[p.GOLD]=Math.min(n,(s[p.GOLD]||0)+2);else if(e==="STEEL_MILL"){const a=s[p.COAL]||0,r=s[p.IRON_ORE]||0;a>=2&&r>=2&&(s[p.COAL]-=2,s[p.IRON_ORE]-=2,s[p.STEEL]=Math.min(n,(s[p.STEEL]||0)+2))}else e==="TOOL_FACTORY"?(s[p.STEEL]||0)>=2&&(s[p.STEEL]-=2,s[p.TOOLS]=Math.min(n,(s[p.TOOLS]||0)+2)):e==="SAWMILL"?(s[p.WOOD]||0)>=2&&(s[p.WOOD]-=2,s[p.LUMBER]=Math.min(n,(s[p.LUMBER]||0)+2)):e==="CITY"&&(s[p.PASSENGERS]=Math.min(n,(s[p.PASSENGERS]||0)+2),(s[p.TOOLS]||0)>0&&s[p.TOOLS]--,(s[p.GOODS]||0)>0&&s[p.GOODS]--,(s[p.LUMBER]||0)>0&&s[p.LUMBER]--)}restoreStationData(t,i,e,s){const n=this.getTile(t,i);n&&n.trackType==="station"&&(n.storage=e,n.lastProduction=s)}initializeMap(){for(let t=0;t<this.height;t++){const i=[];for(let e=0;e<this.width;e++)i.push({x:e,y:t,trackType:"none",bitmaskValue:0,segmentID:null,terrainType:"GRASS"});this.grid.push(i)}this.generateTerrain(),this.placeInitialIndustries()}generateTerrain(){for(let n=0;n<this.height;n++)for(let a=0;a<this.width;a++){const r=this.grid[n][a],o=Math.sin(a*.1)+Math.cos(n*.1)+Math.random()*.5;o>1.2?r.terrainType="SNOW":o<-.5?r.terrainType="DESERT":r.terrainType="GRASS"}const i=20,e=8,s=8;for(let n=0;n<i;n++){let a=Math.floor(Math.random()*this.width),r=Math.floor(Math.random()*this.height);this.growCluster(a,r,"FOREST",.6,5)}for(let n=0;n<e;n++){let a=Math.floor(Math.random()*this.width),r=Math.floor(Math.random()*this.height);const o=this.getTile(a,r);o&&o.terrainType!=="DESERT"&&this.growCluster(a,r,"WATER",.7,8)}for(let n=0;n<s;n++){let a=Math.floor(Math.random()*this.width),r=Math.floor(Math.random()*this.height);this.growCluster(a,r,"MOUNTAIN",.8,6)}}growCluster(t,i,e,s,n){const a=[{x:t,y:i}],r=new Set;let o=0;for(;a.length>0&&o<n;){const c=a.shift(),h=`${c.x},${c.y}`;if(r.has(h))continue;r.add(h);const l=this.getTile(c.x,c.y);if(l){l.terrainType=e,o++;const u=[{x:c.x+1,y:c.y},{x:c.x-1,y:c.y},{x:c.x,y:c.y+1},{x:c.x,y:c.y-1}];for(const d of u)Math.random()<s&&a.push(d)}}}placeInitialIndustries(){const t=Math.floor(this.width/2),i=Math.floor(this.height/2);this.forcePlaceStation("CITY",t,i,!0);for(let s=-5;s<=5;s++)for(let n=-5;n<=5;n++){const a=t+n,r=i+s,o=this.getTile(a,r);o&&(o.terrainType==="FOREST"||o.terrainType==="WATER")&&(o.terrainType="GRASS")}const e=["COAL_MINE","IRON_MINE","STEEL_MILL","LUMBER_CAMP","SAWMILL"];for(const s of e)this.placeIndustryAtDistance(s,t,i,15)}placeIndustryAtDistance(t,i,e,s){let n=!1,a=0;for(;!n&&a<50;){const r=Math.random()*Math.PI*2,o=s+Math.random()*20,c=Math.floor(i+Math.cos(r)*o),h=Math.floor(e+Math.sin(r)*o);if(c<2||c>=this.width-2||h<2||h>=this.height-2){a++;continue}const l=this.getTile(c,h);if(l&&l.trackType==="none"&&l.terrainType!=="WATER"&&l.terrainType!=="MOUNTAIN"){l.trackType="station",l.stationType=t,this.configureStationType(l,t);for(let u=-1;u<=1;u++)for(let d=-1;d<=1;d++){const y=this.getTile(c+d,h+u);y&&y.terrainType==="FOREST"&&(y.terrainType="GRASS")}this.updateBitmask(c,h),this.updateNeighbors(c,h),n=!0}a++}}forcePlaceStation(t,i,e,s=!1){if(i!==void 0&&e!==void 0){const r=this.getTile(i,e);r&&(s&&(r.terrainType="GRASS"),r.trackType="station",r.stationType=t,this.configureStationType(r,t),this.updateBitmask(i,e),this.updateNeighbors(i,e));return}let n=!1,a=0;for(;!n&&a<50;){const r=Math.floor(Math.random()*(this.width-2))+1,o=Math.floor(Math.random()*(this.height-2))+1,c=this.getTile(r,o);c&&c.trackType==="none"&&c.terrainType==="GRASS"&&(c.trackType="station",c.stationType=t,this.configureStationType(c,t),this.updateBitmask(r,o),this.updateNeighbors(r,o),n=!0),a++}}getCapitalCity(){for(let t=0;t<this.height;t++)for(let i=0;i<this.width;i++)if(this.grid[t][i].stationType==="CITY")return{x:i,y:t};return null}demolishTile(t,i,e){const s=this.getTile(t,i);if(!s||s.trackType==="none")return!1;let n=0;return s.trackType==="rail"?n=25:s.trackType==="station"&&(n=250),s.trackType="none",s.stationType=void 0,s.bitmaskValue=0,s.produces=void 0,s.accepts=void 0,e&&n>0&&e.add(n),this.updateNeighbors(t,i),!0}configureStationType(t,i){switch(t.storage={},t.lastProduction=0,i){case"COAL_MINE":t.produces=[p.COAL],t.accepts=[p.PASSENGERS],t.storage[p.COAL]=50;break;case"IRON_MINE":t.produces=[p.IRON_ORE],t.accepts=[p.PASSENGERS],t.storage[p.IRON_ORE]=50;break;case"STEEL_MILL":t.produces=[p.STEEL],t.accepts=[p.COAL,p.IRON_ORE];break;case"TOOL_FACTORY":t.produces=[p.TOOLS],t.accepts=[p.STEEL];break;case"CITY":t.produces=[p.PASSENGERS],t.accepts=[p.TOOLS,p.GOODS,p.PASSENGERS,p.LUMBER],t.storage[p.PASSENGERS]=50;break;case"LUMBER_CAMP":t.produces=[p.WOOD],t.accepts=[p.PASSENGERS],t.storage[p.WOOD]=50;break;case"SAWMILL":t.produces=[p.LUMBER],t.accepts=[p.WOOD];break;case"OIL_WELL":t.produces=[p.OIL],t.accepts=[p.PASSENGERS],t.storage[p.OIL]=50;break;case"GOLD_MINE":t.produces=[p.GOLD],t.accepts=[p.TOOLS,p.PASSENGERS],t.storage[p.GOLD]=20;break}}restoreStation(t,i,e){const s=this.getTile(t,i);s&&(s.trackType="station",s.stationType=e,this.configureStationType(s,e),this.updateBitmask(t,i),this.updateNeighbors(t,i))}getTile(t,i){return t<0||t>=this.width||i<0||i>=this.height?null:this.grid[i][t]}placeTrack(t,i,e,s,n){const a=this.getTile(t,i);if(!a||a.trackType==="rail"||a.trackType==="station"||a.terrainType==="WATER"||a.terrainType==="MOUNTAIN")return!1;let r=50;return a.terrainType==="FOREST"&&(r+=20),e&&!e.deduct(r)?!1:(a.terrainType==="FOREST"&&(a.terrainType="GRASS"),a.trackType="rail",this.updateBitmask(t,i),s&&n!==void 0&&s.registerTrack(t,i,n),this.updateNeighbors(t,i),!0)}placeStation(t,i,e,s=1){const n=this.getTile(t,i);if(!n||n.trackType==="station"||n.terrainType==="WATER"||n.terrainType==="MOUNTAIN")return!1;let a=500;if(n.terrainType==="FOREST"&&(a+=50),e&&!e.deduct(a))return!1;n.terrainType==="FOREST"&&(n.terrainType="GRASS"),n.trackType="station";const r=["COAL_MINE","IRON_MINE","CITY","LUMBER_CAMP","SAWMILL"];n.terrainType==="DESERT"?r.push("OIL_WELL"):n.terrainType==="SNOW"&&r.push("GOLD_MINE"),s>=4&&r.push("STEEL_MILL","TOOL_FACTORY");let o=r;n.terrainType;const c=o[Math.floor(Math.random()*o.length)];return n.stationType=c,this.configureStationType(n,c),this.updateBitmask(t,i),this.updateNeighbors(t,i),!0}updateNeighbors(t,i){for(let e=-1;e<=1;e++)for(let s=-1;s<=1;s++)s===0&&e===0||this.updateBitmask(t+s,i+e)}updateBitmask(t,i){const e=this.getTile(t,i);if(!e||e.trackType!=="rail"&&e.trackType!=="station")return;const s=[];s.push(this.hasTrack(t,i-1)),s.push(this.hasTrack(t+1,i)),s.push(this.hasTrack(t,i+1)),s.push(this.hasTrack(t-1,i)),s.push(this.hasTrack(t+1,i-1)),s.push(this.hasTrack(t+1,i+1)),s.push(this.hasTrack(t-1,i+1)),s.push(this.hasTrack(t-1,i-1)),e.bitmaskValue=H.calculateBitmask(s)}hasTrack(t,i){const e=this.getTile(t,i);return e!==null&&(e.trackType==="rail"||e.trackType==="station")}getTrackPath(t,i){return this.findPath(t,i)}findPath(t,i){const e=[],s=new Set;for(e.push({x:t.x,y:t.y,f:0,g:0,h:0,parent:null});e.length>0;){e.sort((r,o)=>r.f-o.f);const n=e.shift();if(n.x===i.x&&n.y===i.y){const r=[];let o=n;for(;o;)r.unshift({x:o.x,y:o.y}),o=o.parent;return r}s.add(`${n.x},${n.y}`);const a=[{x:n.x,y:n.y-1},{x:n.x+1,y:n.y},{x:n.x,y:n.y+1},{x:n.x-1,y:n.y}];for(const r of a){if(s.has(`${r.x},${r.y}`))continue;const o=this.getTile(r.x,r.y);if(!o||o.terrainType==="WATER"||o.terrainType==="MOUNTAIN")continue;let c=1;o.terrainType==="FOREST"&&(c=2);const h=n.g+c,l=Math.abs(r.x-i.x)+Math.abs(r.y-i.y),u=h+l,d=e.find(y=>y.x===r.x&&y.y===r.y);d&&d.g<=h||(d?(d.g=h,d.f=u,d.parent=n):e.push({x:r.x,y:r.y,f:u,g:h,h:l,parent:n}))}}return[]}buildTrackPath(t,i,e,s){let n=!1;for(const a of t)this.placeTrack(a.x,a.y,i,e,s)&&(n=!0);return n}loadMapData(t){if(!(!t||!t.tiles)){this.initializeMap();for(const i of t.tiles){const e=this.getTile(i.x,i.y);e&&(e.trackType=i.trackType,e.stationType=i.stationType,e.terrainType=i.terrainType,e.bitmaskValue=i.bitmaskValue,e.stationType&&this.configureStationType(e,e.stationType))}for(let i=0;i<this.height;i++)for(let e=0;e<this.width;e++)this.updateBitmask(e,i)}}}var M=(g=>(g.NORMAL="normal",g.FAST="fast",g.HEAVY="heavy",g.EXPRESS="express",g))(M||{});const $=class ${static getTrainInfo(t){return this.trainData[t]}static getAllTrains(){return Object.values(this.trainData)}};$.trainData={normal:{type:"normal",speed:2,cost:150,name:"Normal",color:"#FF0000",unlockLevel:1},fast:{type:"fast",speed:4,cost:300,name:"Fast",color:"#00FF00",unlockLevel:2},heavy:{type:"heavy",speed:1.5,cost:225,name:"Heavy",color:"#0000FF",unlockLevel:3},express:{type:"express",speed:6,cost:600,name:"Express",color:"#00FFFF",unlockLevel:5}};let x=$;class N{constructor(t,i,e,s,n){this.currentDirection=null,this.hasDelivered=!1,this.assignedRoute=null,this.currentRouteStopIndex=0,this.history=[],this.wagonCount=3,this.historyLimit=100,this.x=t,this.y=i,this.lastX=t,this.lastY=i,this.progress=.5,this.startX=t,this.startY=i,this.trainType=e||"normal";const a=x.getTrainInfo(this.trainType);a?this.speed=a.speed:(console.error("TrainActor: Invalid trainType:",e),this.speed=1),this.startTime=s,this.cargoType=n||k.getRandomCargo();const r=k.getCargoInfo(this.cargoType);this.cargoValue=r?r.baseValue:100,this.cargo={}}getVisualPosition(){let t=0,i=0;if(this.currentDirection!==null&&this.progress<1){const e=this.progress;this.currentDirection===0?i=-e:this.currentDirection===1?t=e:this.currentDirection===2?i=e:this.currentDirection===3&&(t=-e)}return{x:this.x+t,y:this.y+i,direction:this.currentDirection}}getWagonPosition(t){const e=(t+1)*15;return e<this.history.length?this.history[e]:null}tick(t,i){if(this.currentDirection===null&&this.pickNextDirection(t),this.currentDirection!==null){this.progress+=this.speed*i;const e=this.getVisualPosition();this.history.unshift(e),this.history.length>this.historyLimit&&this.history.pop(),this.progress>=1&&this.moveTile(t)}}pickNextDirection(t){const i=t.getTile(this.x,this.y);if(!i)return;if(this.assignedRoute&&this.assignedRoute.stops.length>0){const n=this.assignedRoute.stops[this.currentRouteStopIndex];this.x===n.x&&this.y===n.y&&(this.currentRouteStopIndex=(this.currentRouteStopIndex+1)%this.assignedRoute.stops.length,console.log(`Train reached stop ${this.currentRouteStopIndex} of route ${this.assignedRoute.name}`))}const e=i.bitmaskValue,s=[];if(e&1&&s.push(0),e&2&&s.push(1),e&4&&s.push(2),e&8&&s.push(3),s.length>0){let n=s;if(s.length>1&&(n=s.filter(a=>{let r=this.x,o=this.y;return a===0?o-=1:a===1?r+=1:a===2?o+=1:a===3&&(r-=1),!(r===this.lastX&&o===this.lastY)})),this.assignedRoute&&this.assignedRoute.stops.length>0&&n.length>0){const a=this.assignedRoute.stops[this.currentRouteStopIndex];n.sort((r,o)=>{const c=this.getFuturePos(r),h=this.getFuturePos(o),l=Math.abs(c.x-a.x)+Math.abs(c.y-a.y),u=Math.abs(h.x-a.x)+Math.abs(h.y-a.y);return l-u}),this.currentDirection=n[0];return}if(n.length>0){this.currentDirection=n[0];return}this.currentDirection=s[0]}}getFuturePos(t){let i=this.x,e=this.y;return t===0?e-=1:t===1?i+=1:t===2?e+=1:t===3&&(i-=1),{x:i,y:e}}moveTile(t){this.lastX=this.x,this.lastY=this.y,this.currentDirection===0?this.y-=1:this.currentDirection===1?this.x+=1:this.currentDirection===2?this.y+=1:this.currentDirection===3&&(this.x-=1),this.progress=0,this.currentDirection=null}}const F=class F{static save(t,i,e,s,n,a,r,o,c,h,l){const u={version:this.VERSION,economy:{balance:t.getBalance()},time:{totalTicks:i.getGameTimeDays()*24,gameSpeed:i.getSpeed()},trains:e.map(d=>({x:d.x,y:d.y,trainType:d.trainType,cargoType:d.cargoType,startTime:d.startTime,assignedRouteId:d.assignedRoute?.id})),map:{width:s.getWidth(),height:s.getHeight(),tiles:this.serializeMap(s)},progression:{xp:n.getXp(),level:n.getLevel(),unlocks:Array.from(n.unlockFlags||[])},statistics:a.getStats(),achievements:r.getUnlockedAchievements(),selectedSpawn:o,routes:c.getAllRoutes().map(d=>({id:d.id,name:d.name,color:d.color,stops:d.stops})),goal:h.getCurrentGoal(),event:l.getActiveEvent()};try{localStorage.setItem(this.SAVE_KEY,JSON.stringify(u))}catch(d){console.error("Failed to save game:",d)}}static load(){try{const t=localStorage.getItem(this.SAVE_KEY);if(!t)return null;const i=JSON.parse(t);return i.version!==this.VERSION?(console.warn("Save version mismatch or old save"),null):i}catch(t){return console.error("Failed to load game:",t),null}}static serializeMap(t){const i=[];for(let e=0;e<t.getHeight();e++)for(let s=0;s<t.getWidth();s++){const n=t.getTile(s,e);n&&(n.trackType!=="none"||n.terrainType!=="GRASS")&&i.push({x:s,y:e,trackType:n.trackType,stationType:n.stationType,terrainType:n.terrainType,bitmaskValue:n.bitmaskValue,storage:n.storage,lastProduction:n.lastProduction})}return i}static saveMap(t,i){const e={width:t.getWidth(),height:t.getHeight(),tiles:this.serializeMap(t)};try{localStorage.setItem(this.MAP_KEY_PREFIX+i,JSON.stringify(e)),console.log(`Map '${i}' saved successfully`)}catch(s){console.error("Failed to save map:",s)}}static loadMap(t){try{const i=localStorage.getItem(this.MAP_KEY_PREFIX+t);return i?JSON.parse(i):null}catch(i){return console.error("Failed to load map:",i),null}}static getSavedMaps(){const t=[];for(let i=0;i<localStorage.length;i++){const e=localStorage.key(i);e&&e.startsWith(this.MAP_KEY_PREFIX)&&t.push(e.substring(this.MAP_KEY_PREFIX.length))}return t}};F.SAVE_KEY="railsim_save",F.MAP_KEY_PREFIX="railsim_map_",F.VERSION=3;let A=F;class Y{constructor(t){this.isActive=!1,this.selectedTool="terrain",this.selectedBrush="GRASS",this.game=t}setActive(t){this.isActive=t;const i=document.getElementById("editor-ui");i&&(i.style.display=t?"block":"none");const e=document.getElementById("ui-layer");e&&(e.style.display=t?"none":"block")}isEditorActive(){return this.isActive}setTool(t,i){this.selectedTool=t,this.selectedBrush=i,console.log(`Tool: ${t}, Brush: ${i}`),this.updateUI()}handleClick(t,i){if(!this.isActive)return;const e=this.game.map,s=e.getTile(t,i);s&&(this.selectedTool==="terrain"?s.trackType==="none"&&(s.terrainType=this.selectedBrush):this.selectedTool==="station"?s.trackType==="none"&&e.restoreStation(t,i,this.selectedBrush):this.selectedTool==="clear"&&(s.trackType="none",s.terrainType="GRASS",s.bitmaskValue=0,s.stationType=void 0,s.produces=[],s.accepts=[],e.updateNeighbors(t,i),this.game.selectedSpawnStation&&this.game.selectedSpawnStation.x===t&&this.game.selectedSpawnStation.y===i&&(this.game.selectedSpawnStation=null,this.game.updateUI())))}setupUI(){document.getElementById("tool-grass")?.addEventListener("click",()=>this.setTool("terrain","GRASS")),document.getElementById("tool-water")?.addEventListener("click",()=>this.setTool("terrain","WATER")),document.getElementById("tool-forest")?.addEventListener("click",()=>this.setTool("terrain","FOREST")),document.getElementById("tool-mountain")?.addEventListener("click",()=>this.setTool("terrain","MOUNTAIN")),document.getElementById("tool-city")?.addEventListener("click",()=>this.setTool("station","CITY")),document.getElementById("tool-coal")?.addEventListener("click",()=>this.setTool("station","COAL_MINE")),document.getElementById("tool-iron")?.addEventListener("click",()=>this.setTool("station","IRON_MINE")),document.getElementById("tool-steel")?.addEventListener("click",()=>this.setTool("station","STEEL_MILL")),document.getElementById("tool-factory")?.addEventListener("click",()=>this.setTool("station","TOOL_FACTORY")),document.getElementById("tool-lumber")?.addEventListener("click",()=>this.setTool("station","LUMBER_CAMP")),document.getElementById("tool-sawmill")?.addEventListener("click",()=>this.setTool("station","SAWMILL")),document.getElementById("tool-clear")?.addEventListener("click",()=>this.setTool("clear","CLEAR")),document.getElementById("editor-exit")?.addEventListener("click",()=>{this.setActive(!1),this.game.menuManager.setState("main_menu")}),document.getElementById("editor-save-map")?.addEventListener("click",()=>{const t=document.getElementById("editor-map-name"),i=t?t.value:"MyMap";if(!i){alert("Please enter a map name");return}A.saveMap(this.game.map,i),alert(`Map '${i}' Saved!`)}),document.getElementById("editor-load-map")?.addEventListener("click",()=>{const t=document.getElementById("editor-map-name"),i=t?t.value:"MyMap";if(!i){alert("Please enter a map name");return}const e=A.loadMap(i);e?(this.game.map.loadMapData(e),alert(`Map '${i}' Loaded!`)):alert(`Map '${i}' not found!`)})}updateUI(){document.querySelectorAll(".editor-btn").forEach(e=>e.classList.remove("active"));let i="";this.selectedTool==="terrain"?(this.selectedBrush==="GRASS"&&(i="tool-grass"),this.selectedBrush==="WATER"&&(i="tool-water"),this.selectedBrush==="FOREST"&&(i="tool-forest"),this.selectedBrush==="MOUNTAIN"&&(i="tool-mountain")):this.selectedTool==="station"?(this.selectedBrush==="CITY"&&(i="tool-city"),this.selectedBrush==="COAL_MINE"&&(i="tool-coal"),this.selectedBrush==="IRON_MINE"&&(i="tool-iron"),this.selectedBrush==="STEEL_MILL"&&(i="tool-steel"),this.selectedBrush==="TOOL_FACTORY"&&(i="tool-factory"),this.selectedBrush==="LUMBER_CAMP"&&(i="tool-lumber"),this.selectedBrush==="SAWMILL"&&(i="tool-sawmill")):i="tool-clear",i&&document.getElementById(i)?.classList.add("active")}}var L=(g=>(g.NONE="NONE",g.RAIN="RAIN",g.SNOW="SNOW",g.GOLD_RUSH="GOLD_RUSH",g.STRIKE="STRIKE",g))(L||{});class X{constructor(){this.activeEvent=null,this.lastEventTime=0,this.eventInterval=5}update(t){if(this.activeEvent){if(t>=this.activeEvent.startTime+this.activeEvent.duration){const i=this.activeEvent.name;return this.activeEvent=null,this.lastEventTime=t,`Event Ended: ${i}`}return null}if(t-this.lastEventTime>this.eventInterval){if(Math.random()<.7){this.startRandomEvent(t);const i=this.activeEvent;if(i)return`Event Started: ${i.name}`}this.lastEventTime+=1}return null}startRandomEvent(t){const i=Math.random();let e="NONE";switch(i<.3?e="RAIN":i<.5?e="SNOW":i<.8?e="GOLD_RUSH":e="STRIKE",e){case"RAIN":this.activeEvent={type:"RAIN",name:"Heavy Rain",description:"Slippery tracks! Trains move at 80% speed.",duration:2,startTime:t,modifiers:{speed:.8}};break;case"SNOW":this.activeEvent={type:"SNOW",name:"Blizzard",description:"Freezing cold! Trains move at 60% speed.",duration:3,startTime:t,modifiers:{speed:.6}};break;case"GOLD_RUSH":this.activeEvent={type:"GOLD_RUSH",name:"Gold Rush",description:"High demand! Revenue x2.",duration:4,startTime:t,modifiers:{revenue:2}};break;case"STRIKE":this.activeEvent={type:"STRIKE",name:"Union Strike",description:"Workers are unhappy. Revenue reduced to 50%.",duration:2,startTime:t,modifiers:{revenue:.5}};break}}getActiveEvent(){return this.activeEvent}getSpeedModifier(){return this.activeEvent?.modifiers.speed||1}getRevenueModifier(){return this.activeEvent?.modifiers.revenue||1}restoreEvent(t){this.activeEvent=t,this.updateUI()}updateUI(){const t=document.getElementById("event-banner"),i=document.getElementById("event-icon"),e=document.getElementById("event-name");if(!(!t||!i||!e))if(this.activeEvent)switch(t.style.display="flex",e.textContent=this.activeEvent.name,this.activeEvent.type){case"RAIN":i.textContent="üåßÔ∏è",e.style.color="#74C0FC";break;case"SNOW":i.textContent="‚ùÑÔ∏è",e.style.color="#A5D8FF";break;case"GOLD_RUSH":i.textContent="üí∞",e.style.color="#FFD43B";break;case"STRIKE":i.textContent="üö´",e.style.color="#FF6B6B";break}else t.style.display="none"}}class K{constructor(t){this.tileSize=40,this.weatherParticles=[],this.lastWeatherType=null,this.stars=[],this.canvas=t;const i=t.getContext("2d",{alpha:!1});if(!i)throw new Error("Could not get 2D context");this.ctx=i,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const t=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*t,this.canvas.height=window.innerHeight*t,this.canvas.style.width=`${window.innerWidth}px`,this.canvas.style.height=`${window.innerHeight}px`,this.ctx.scale(t,t)}render(t,i,e,s,n,a,r,o,c,h=null){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore();try{const l=r%1;let u=1;l<.2?u=.3:l<.3?u=.3+(l-.2)*7:l<.7?u=1:l<.8?u=1-(l-.7)*7:u=.3;const d=u<.5;let y=0,m=0,f=0;if(d)y=5,m=5,f=.2;else{const v=(l-.2)/.6;y=(v-.5)*30,m=Math.abs(v-.5)*10+2,f=.4-Math.abs(v-.5)*.4}this.drawBackgroundGrid(n,l),this.ctx.save();try{const v=window.innerWidth/2,T=window.innerHeight/2;this.ctx.translate(v,T),this.ctx.scale(n.zoom,n.zoom),this.ctx.translate(-v,-T),this.ctx.translate(-n.x,-n.y),this.drawGrid(t,a,l,d),h&&this.drawRoute(h),c&&this.drawHoverTile(c.x,c.y,t),this.drawTrains(i,d,y,m,f),this.drawNotifications(e),s.render(this.ctx,this.tileSize,0,0)}finally{this.ctx.restore()}this.drawDayNightOverlay(l),o&&this.drawWeather(o)}catch(l){console.error("Render Error:",l)}}generateStars(){this.stars=[];const t=150;for(let i=0;i<t;i++)this.stars.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,size:Math.random()*2.5,alpha:Math.random()})}drawBackgroundGrid(t,i){this.ctx.save();const e=this.ctx.createLinearGradient(0,0,0,window.innerHeight);if(i<.2||i>.8?(e.addColorStop(0,"#0f0c29"),e.addColorStop(1,"#302b63")):i<.3?(e.addColorStop(0,"#ff9966"),e.addColorStop(1,"#ff5e62")):i<.7?(e.addColorStop(0,"#2980b9"),e.addColorStop(1,"#6dd5fa")):(e.addColorStop(0,"#2c3e50"),e.addColorStop(1,"#fd746c")),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,window.innerWidth,window.innerHeight),i<.25||i>.75){this.stars.length===0&&this.generateStars(),this.ctx.fillStyle="white";for(const s of this.stars)Math.random()>.95?this.ctx.globalAlpha=Math.random():this.ctx.globalAlpha=s.alpha,this.ctx.fillRect(s.x,s.y,s.size,s.size)}this.ctx.restore()}drawDayNightOverlay(t){let i="",e=0;if(t<.15)i="#000033",e=.5;else if(t<.25){const s=(t-.15)/.1,n=Math.floor(0+s*255),a=Math.floor(0+s*140),r=Math.floor(51-s*51);i=`rgb(${n}, ${a}, ${r})`,e=.5*(1-s)+.2*s}else if(t<.7)e=0;else if(t<.8){const s=(t-.7)/.1,n=Math.floor(255*s),a=Math.floor(140*(1-s*.5)),r=Math.floor(100*s);i=`rgb(${n}, ${a}, ${r})`,e=.3*s}else{const s=(t-.8)/.2;i="#000033",e=.5*s}e>0&&(this.ctx.fillStyle=i,this.ctx.globalAlpha=e,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalAlpha=1)}drawWeather(t){const i=t.getActiveEvent();if(!i){this.lastWeatherType=null,this.weatherParticles=[];return}if(this.lastWeatherType!==i.type&&(this.lastWeatherType=i.type,this.generateWeatherParticles(i.type)),this.ctx.save(),i.type===L.RAIN){this.ctx.strokeStyle="rgba(174, 194, 224, 0.7)",this.ctx.lineWidth=2;for(const e of this.weatherParticles)e.y+=e.speed,e.y>window.innerHeight&&(e.y=-10,e.x=Math.random()*window.innerWidth),this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(e.x-3,e.y+10),this.ctx.stroke();this.ctx.fillStyle="rgba(0, 0, 50, 0.1)",this.ctx.fillRect(0,0,window.innerWidth,window.innerHeight)}else if(i.type===L.SNOW){this.ctx.fillStyle="rgba(255, 255, 255, 0.9)";for(const e of this.weatherParticles)e.y+=e.speed,e.x+=Math.sin(e.y*.01)*.5,e.y>window.innerHeight&&(e.y=-10,e.x=Math.random()*window.innerWidth),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.fill();this.ctx.fillStyle="rgba(200, 200, 255, 0.1)",this.ctx.fillRect(0,0,window.innerWidth,window.innerHeight)}this.ctx.restore()}generateWeatherParticles(t){this.weatherParticles=[];const i=t===L.RAIN?150:80;for(let e=0;e<i;e++)this.weatherParticles.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,speed:t===L.RAIN?8+Math.random()*4:1+Math.random()*2,size:t===L.SNOW?Math.random()*3+1:1})}drawGrid(t,i,e,s){let n=0,a=0,r=0;if(s)n=5,a=5,r=.2;else{const o=(e-.2)/.6;n=(o-.5)*30,a=Math.abs(o-.5)*10+2,r=.4-Math.abs(o-.5)*.4}for(let o=0;o<t.getHeight();o++)for(let c=0;c<t.getWidth();c++){const h=t.getTile(c,o);if(!h)continue;const l=c*this.tileSize,u=o*this.tileSize;this.drawTerrain(l,u,h.terrainType,e,c,o,n,a,r)}for(let o=0;o<t.getHeight();o++)for(let c=0;c<t.getWidth();c++){const h=t.getTile(c,o);if(!h)continue;const l=c*this.tileSize,u=o*this.tileSize;if(h.trackType==="rail")this.drawEnhancedTrack(l,u,h.bitmaskValue);else if(h.trackType==="station"){const d=i&&i.x===c&&i.y===o;this.drawEnhancedStation(l,u,h.stationType,d||!1,s,n,a,r)}}}drawTerrain(t,i,e,s,n,a,r,o,c){const h=this.tileSize;switch(e){case"WATER":this.ctx.fillStyle="#29B6F6",this.ctx.fillRect(t,i,h,h),this.drawTerrainDetails(t,i,h,n,a,e,s,r,o,c);break;case"FOREST":this.ctx.fillStyle="#388E3C",this.ctx.fillRect(t,i,h,h),this.drawTerrainDetails(t,i,h,n,a,e,s,r,o,c);break;case"MOUNTAIN":this.ctx.fillStyle="#9E9E9E",this.ctx.fillRect(t,i,h,h),this.drawTerrainDetails(t,i,h,n,a,e,s,r,o,c);break;case"DESERT":this.ctx.fillStyle="#E6C288",this.ctx.fillRect(t,i,h,h),this.drawTerrainDetails(t,i,h,n,a,e,s,r,o,c);break;case"SNOW":this.ctx.fillStyle="#F0F8FF",this.ctx.fillRect(t,i,h,h),this.drawTerrainDetails(t,i,h,n,a,e,s,r,o,c);break;case"GRASS":default:this.ctx.fillStyle="#8BC34A",this.ctx.fillRect(t,i,h,h),this.drawTerrainDetails(t,i,h,n,a,"GRASS",s,r,o,c);break}this.ctx.strokeStyle="rgba(0,0,0,0.05)",this.ctx.strokeRect(t,i,h,h)}deterministicRandom(t,i,e=0){let r=(t*1e3+i+e)%2147483648;return r=(1103515245*r+12345)%2147483648,r/2147483648}drawTerrainDetails(t,i,e,s,n,a,r,o,c,h){const l=this.ctx,u=d=>this.deterministicRandom(s,n,d);switch(a){case"WATER":l.strokeStyle="rgba(255,255,255,0.4)",l.lineWidth=1.5;const d=Math.sin(r*5+s*.5+n*.5)*2;l.beginPath(),l.moveTo(t+4,i+e/2+d),l.quadraticCurveTo(t+e/2,i+e/2+d-4,t+e-4,i+e/2+d),l.stroke(),l.strokeStyle="rgba(255,255,255,0.2)",l.beginPath(),l.moveTo(t+8,i+e/2+d+6),l.quadraticCurveTo(t+e/2,i+e/2+d+2,t+e-8,i+e/2+d+6),l.stroke();break;case"FOREST":const y=3+Math.floor(u(0)*3);for(let m=0;m<y;m++){const f=t+5+u(m+1)*(e-10),v=i+5+u(m+10)*(e-10);l.fillStyle=`rgba(0,0,0,${h})`,l.beginPath(),l.ellipse(f+5+o*.5,v+10+c*.5,4,2,0,0,Math.PI*2),l.fill(),this.drawTree(f,v,"#1B5E20")}break;case"MOUNTAIN":l.fillStyle=`rgba(0,0,0,${h})`,l.beginPath(),l.moveTo(t+5+o,i+e-5+c),l.lineTo(t+e/2+o,i+5+c),l.lineTo(t+e-5+o,i+e-5+c),l.fill(),l.fillStyle="#757575",l.beginPath(),l.moveTo(t+5,i+e-5),l.lineTo(t+e/2,i+5),l.lineTo(t+e-5,i+e-5),l.fill(),l.fillStyle="#ecf0f1",l.beginPath(),l.moveTo(t+e/2,i+5),l.lineTo(t+e/2-4,i+12),l.lineTo(t+e/2+4,i+12),l.fill();break;case"DESERT":if(u(100)>.8){const m=t+u(10)*(e-4),f=i+u(20)*(e-8);l.fillStyle=`rgba(0,0,0,${h})`,l.beginPath(),l.ellipse(m+3+o*.3,f+8+c*.3,3,1.5,0,0,Math.PI*2),l.fill(),l.fillStyle="#2E7D32",l.fillRect(m+2,f,2,8),l.fillRect(m,f+2,6,2),l.fillRect(m,f-1,2,2)}break;case"SNOW":if(u(200)>.7){const m=t+u(30)*(e-10),f=i+u(40)*(e-10);l.fillStyle=`rgba(0,0,0,${h*.5})`,l.beginPath(),l.ellipse(m+5+o*.5,f+10+c*.5,4,2,0,0,Math.PI*2),l.fill(),this.drawTree(m,f,"#2c3e50"),l.fillStyle="#FFF",l.beginPath(),l.moveTo(m+5,f),l.lineTo(m+2,f+4),l.lineTo(m+8,f+4),l.fill()}break;case"GRASS":default:for(let m=0;m<3;m++)if(u(m+100)>.6){const f=t+u(m*10)*e,v=i+u(m*20)*e;l.fillStyle=u(m+200)>.9?"#FFEB3B":"#689F38",l.fillRect(f,v,2,2)}break}}drawTree(t,i,e){this.ctx.fillStyle="#5d4037",this.ctx.fillRect(t+3,i+10,4,6),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.moveTo(t+5,i),this.ctx.lineTo(t,i+10),this.ctx.lineTo(t+10,i+10),this.ctx.fill()}drawEnhancedTrack(t,i,e){const s=this.tileSize;this.ctx.fillStyle="#7f8c8d",this.ctx.fillRect(t,i,s,s),this.ctx.fillStyle="rgba(0,0,0,0.1)";for(let E=0;E<5;E++)this.ctx.fillRect(t+Math.random()*s,i+Math.random()*s,2,2);const n=this.ctx,a=!!(e&1),r=!!(e&2),o=!!(e&4),c=!!(e&8),h=4,l=12,u=24,d=4,y="#3e2723",m="#bdc3c7",f="#7f8c8d";n.save(),n.translate(t+s/2,i+s/2);const v=E=>{n.save(),n.rotate(E),n.fillStyle=y,n.fillRect(-u/2,-s/2+4,u,d),n.fillRect(-u/2,-2,u,d),n.fillRect(-u/2,s/2-8,u,d),n.restore()},T=E=>{n.save(),n.rotate(E),v(0),n.fillStyle=m,n.strokeStyle=f,n.lineWidth=1;const R=-l/2-h/2,w=l/2-h/2;n.fillRect(R,-s/2,h,s),n.strokeRect(R,-s/2,h,s),n.fillRect(w,-s/2,h,s),n.strokeRect(w,-s/2,h,s),n.restore()},S=E=>{n.save(),n.rotate(E),n.fillStyle=y,n.save(),n.rotate(Math.PI/4),n.fillRect(-u/2,-d/2,u,d),n.restore(),n.save(),n.rotate(Math.PI/8),n.translate(0,-s/3),n.fillRect(-u/2,-d/2,u,d),n.restore(),n.save(),n.rotate(3*Math.PI/8),n.translate(0,-s/3),n.fillRect(-u/2,-d/2,u,d),n.restore(),n.strokeStyle=f,n.lineWidth=h,n.lineCap="butt";const R=s/2-l/2,w=s/2+l/2;n.beginPath(),n.arc(s/2,-s/2,w,Math.PI/2,Math.PI),n.stroke(),n.strokeStyle=m,n.lineWidth=h-2,n.stroke(),n.strokeStyle=f,n.lineWidth=h,n.beginPath(),n.arc(s/2,-s/2,R,Math.PI/2,Math.PI),n.stroke(),n.strokeStyle=m,n.lineWidth=h-2,n.stroke(),n.restore()};!a&&!r&&!o&&!c?T(Math.PI/2):a&&o&&!r&&!c?T(0):r&&c&&!a&&!o?T(Math.PI/2):a&&!r&&!o&&!c||o&&!r&&!a&&!c?T(0):r&&!a&&!o&&!c||c&&!a&&!o&&!r?T(Math.PI/2):a&&r&&!o&&!c?S(0):r&&o&&!a&&!c?S(Math.PI/2):o&&c&&!a&&!r?S(Math.PI):c&&a&&!o&&!r?S(-Math.PI/2):((a||o)&&T(0),(r||c)&&T(Math.PI/2)),n.restore()}drawEnhancedStation(t,i,e,s,n,a,r,o){const c=this.tileSize;let h="#6B8E23",l="#8B4513",u="#5D4037";switch(e){case"COAL_MINE":h="#2F4F4F",l="#34495e",u="#2c3e50";break;case"IRON_MINE":h="#8B4513",l="#e67e22",u="#a04000";break;case"STEEL_MILL":h="#7f8c8d",l="#95a5a6",u="#34495e";break;case"TOOL_FACTORY":h="#f39c12",l="#f1c40f",u="#d35400";break;case"CITY":h="#bdc3c7",l="#ecf0f1",u="#2980b9";break;case"OIL_WELL":h="#1A1A1A",l="#2c3e50",u="#000000";break;case"GOLD_MINE":h="#F1C40F",l="#F39C12",u="#D35400";break}const d=this.ctx.createLinearGradient(t,i,t,i+c);if(d.addColorStop(0,h),d.addColorStop(1,"#2c3e50"),this.ctx.fillStyle=d,this.ctx.fillRect(t,i,c,c),this.ctx.fillStyle=`rgba(0,0,0,${o})`,this.ctx.fillRect(t+6+a,i+6+r,c-12,c-12),this.ctx.fillStyle=l,this.ctx.fillRect(t+6,i+6,c-12,c-12),this.ctx.fillStyle=u,this.ctx.beginPath(),this.ctx.moveTo(t+4,i+6),this.ctx.lineTo(t+c/2,i-2),this.ctx.lineTo(t+c-4,i+6),this.ctx.fill(),n?(this.ctx.fillStyle="#f1c40f",this.ctx.shadowColor="#f39c12",this.ctx.shadowBlur=10):(this.ctx.fillStyle="#34495e",this.ctx.shadowBlur=0),this.ctx.fillRect(t+10,i+12,6,6),this.ctx.fillRect(t+24,i+12,6,6),this.ctx.shadowBlur=0,e&&(this.ctx.fillStyle="#FFF",this.ctx.font="bold 10px Inter",this.ctx.textAlign="center",this.ctx.fillText(e.split("_")[0],t+c/2,i+c-4)),s){const y=Date.now()/1e3,m=(Math.sin(y*3)+1)/2,f=10+m*15,v=.6+m*.4;this.ctx.shadowColor="#2ecc71",this.ctx.shadowBlur=f,this.ctx.strokeStyle=`rgba(46, 204, 113, ${v})`,this.ctx.lineWidth=3,this.ctx.strokeRect(t+1,i+1,c-2,c-2),this.ctx.shadowBlur=f/2,this.ctx.strokeStyle=`rgba(255, 255, 255, ${v*.5})`,this.ctx.lineWidth=1,this.ctx.strokeRect(t+3,i+3,c-6,c-6),this.ctx.shadowBlur=0,this.ctx.fillStyle=`rgba(46, 204, 113, ${v})`,this.ctx.font="bold 8px Inter",this.ctx.textAlign="center",this.ctx.fillText("SPAWN",t+c/2,i-4)}}drawTrains(t,i,e,s,n){for(const a of t){const r=x.getTrainInfo(a.trainType),o=k.getCargoInfo(a.cargoType),c=a.getVisualPosition(),h=c.x*this.tileSize+this.tileSize/2,l=c.y*this.tileSize+this.tileSize/2;if(this.ctx.save(),c.direction!==null){this.ctx.translate(h,l);const d=(c.direction-1)*(Math.PI/2);this.ctx.rotate(d),this.ctx.translate(-h,-l)}const u=a.trainType===M.HEAVY?4:3;for(let d=u-1;d>=0;d--){const y=a.getWagonPosition(d);if(y){const m=y.x*this.tileSize+this.tileSize/2,f=y.y*this.tileSize+this.tileSize/2;if(this.ctx.save(),y.direction!==null){this.ctx.translate(m,f);const v=(y.direction-1)*(Math.PI/2);this.ctx.rotate(v),this.ctx.translate(-m,-f)}this.ctx.fillStyle=`rgba(0,0,0,${n})`,this.ctx.fillRect(m-8+e,f-6+s,16,12),this.drawWagon(m,f,a.cargoType,o.color),(d<u-1||d===0)&&(this.ctx.fillStyle="#000",this.ctx.fillRect(m+8,f-1,4,2)),this.ctx.restore()}}if(this.ctx.restore(),this.ctx.save(),c.direction!==null){this.ctx.translate(h,l);const d=(c.direction-1)*(Math.PI/2);this.ctx.rotate(d),this.ctx.translate(-h,-l)}this.ctx.fillStyle=`rgba(0,0,0,${n})`,this.ctx.fillRect(h-12+e,l-6+s,20,16),this.ctx.fillStyle=r.color,this.ctx.fillRect(h-14,l-8,20,16),this.ctx.fillStyle="rgba(255,255,255,0.2)",this.ctx.fillRect(h-14,l-2,20,4),this.ctx.fillStyle="#2c3e50",this.ctx.fillRect(h-12,l-6,8,12),this.ctx.fillStyle="#111",this.ctx.beginPath(),this.ctx.arc(h+4,l,4,0,Math.PI*2),this.ctx.fill(),i&&(this.ctx.save(),this.ctx.translate(h+10,l),this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(60,-20),this.ctx.lineTo(60,20),this.ctx.fillStyle="rgba(255, 255, 200, 0.4)",this.ctx.fill(),this.ctx.shadowColor="#FFFFE0",this.ctx.shadowBlur=20,this.ctx.beginPath(),this.ctx.arc(0,0,5,0,Math.PI*2),this.ctx.fillStyle="#FFFFE0",this.ctx.fill(),this.ctx.restore()),this.ctx.fillStyle="#000",this.ctx.fillRect(h-16,l-1,4,2),this.ctx.restore()}}drawWagon(t,i,e,s){const n=this.ctx;switch(e){case p.PASSENGERS:n.fillStyle="#8B4513",n.fillRect(t-8,i-6,16,12),n.fillStyle="#87CEEB",n.fillRect(t-6,i-4,3,4),n.fillRect(t-1,i-4,3,4),n.fillRect(t+4,i-4,3,4),n.fillStyle="#654321",n.fillRect(t-8,i-7,16,2);break;case p.OIL:n.fillStyle="#2F4F4F",n.beginPath(),n.ellipse(t,i,8,6,0,0,Math.PI*2),n.fill(),n.strokeStyle="#1C1C1C",n.lineWidth=1,n.beginPath(),n.moveTo(t-4,i-6),n.lineTo(t-4,i+6),n.stroke(),n.beginPath(),n.moveTo(t+4,i-6),n.lineTo(t+4,i+6),n.stroke();break;case p.WOOD:case p.LUMBER:n.fillStyle="#654321",n.fillRect(t-8,i+2,16,4),n.fillStyle="#8B4513",n.fillRect(t-6,i-4,12,6),n.strokeStyle="#654321",n.lineWidth=1;for(let a=0;a<3;a++)n.beginPath(),n.moveTo(t-6+a*4,i-4),n.lineTo(t-6+a*4,i+2),n.stroke();break;default:n.fillStyle=s,n.fillRect(t-8,i-6,16,12),n.strokeStyle="#2c3e50",n.lineWidth=2,n.strokeRect(t+1,i-4,6,10),n.strokeStyle="#000",n.lineWidth=1,n.strokeRect(t-8,i-6,16,12);break}n.fillStyle="#2c3e50",n.beginPath(),n.arc(t-5,i+6,2,0,Math.PI*2),n.fill(),n.beginPath(),n.arc(t+5,i+6,2,0,Math.PI*2),n.fill()}drawNotifications(t){const i=t.getNotifications();for(const e of i){const s=1-e.age/e.lifetime;this.ctx.save(),this.ctx.globalAlpha=s,this.ctx.font="bold 14px Inter",this.ctx.fillStyle=e.color,this.ctx.strokeStyle="rgba(0,0,0,0.8)",this.ctx.lineWidth=3,this.ctx.textAlign="center";const n=e.x*this.tileSize+this.tileSize/2,a=e.y*this.tileSize;this.ctx.strokeText(e.text,n,a),this.ctx.fillText(e.text,n,a),this.ctx.restore()}}drawGhostTracks(t){if(t.length===0)return;this.ctx.save(),this.ctx.globalAlpha=.6;const i=new Set;for(const e of t)i.add(`${e.x},${e.y}`);for(const e of t){const s=e.x*this.tileSize,n=e.y*this.tileSize,a=[];a.push(i.has(`${e.x},${e.y-1}`)),a.push(i.has(`${e.x+1},${e.y}`)),a.push(i.has(`${e.x},${e.y+1}`)),a.push(i.has(`${e.x-1},${e.y}`));let r=0;a[0]&&(r|=1),a[1]&&(r|=2),a[2]&&(r|=4),a[3]&&(r|=8),this.drawEnhancedTrack(s,n,r)}this.ctx.restore()}drawHoverTile(t,i,e){const s=t*this.tileSize,n=i*this.tileSize;this.ctx.save(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=2,this.ctx.strokeRect(s,n,this.tileSize,this.tileSize),this.ctx.restore()}drawRoute(t){if(t.stops.length===0)return;this.ctx.save(),this.ctx.strokeStyle=t.color,this.ctx.lineWidth=3,this.ctx.setLineDash([5,5]),this.ctx.globalAlpha=.7,this.ctx.beginPath();const i=t.stops[0];this.ctx.moveTo(i.x*this.tileSize+this.tileSize/2,i.y*this.tileSize+this.tileSize/2);for(let e=1;e<t.stops.length;e++){const s=t.stops[e];this.ctx.lineTo(s.x*this.tileSize+this.tileSize/2,s.y*this.tileSize+this.tileSize/2)}this.ctx.stroke();for(let e=0;e<t.stops.length;e++){const s=t.stops[e],n=s.x*this.tileSize+this.tileSize/2,a=s.y*this.tileSize+this.tileSize/2;this.ctx.fillStyle=t.color,this.ctx.beginPath(),this.ctx.arc(n,a,6,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="white",this.ctx.font="bold 10px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText((e+1).toString(),n,a)}this.ctx.restore()}getTileFromScreen(t,i,e){const s=window.innerWidth/2,n=window.innerHeight/2,a=(t-s)/e.zoom+s+e.x,r=(i-n)/e.zoom+n+e.y,o=Math.floor(a/this.tileSize),c=Math.floor(r/this.tileSize);return{x:o,y:c}}}class q{calculateRevenue(t,i,e,s){const n=Math.max(1,i*20/s),a=1/(1+Math.pow(e/n,2));return t*a}}class C{constructor(t){this.balance=t}getBalance(){return this.balance}canAfford(t){return this.balance>=t}deduct(t){return this.canAfford(t)?(this.balance-=t,!0):!1}add(t){this.balance+=t}}class P{constructor(){this.totalTicks=0,this.gameSpeed=1,this.TICKS_PER_DAY=24}tick(t){this.totalTicks+=t*this.gameSpeed}setSpeed(t){this.gameSpeed=t}getSpeed(){return this.gameSpeed}getGameTimeDays(){return this.totalTicks/this.TICKS_PER_DAY}getDayString(){const t=Math.floor(this.getGameTimeDays()),i=Math.floor((this.getGameTimeDays()-t)*24);return`Day ${t}, ${i}h`}}class j{constructor(){this.notifications=[],this.nextId=0}addNotification(t,i,e,s="#FFD700"){this.notifications.push({id:this.nextId++,text:t,x:i,y:e,lifetime:2,age:0,color:s})}update(t){for(let i=this.notifications.length-1;i>=0;i--)this.notifications[i].age+=t,this.notifications[i].y-=20*t,this.notifications[i].age>=this.notifications[i].lifetime&&this.notifications.splice(i,1)}getNotifications(){return this.notifications}}class G{constructor(){this.stats={totalRevenue:0,totalDeliveries:0,playtimeSeconds:0,highestRevenue:0}}recordDelivery(t){this.stats.totalRevenue+=t,this.stats.totalDeliveries++,t>this.stats.highestRevenue&&(this.stats.highestRevenue=t)}updatePlaytime(t){this.stats.playtimeSeconds+=t}getStats(){return{...this.stats}}loadStats(t){this.stats={...t}}loadData(t){this.loadStats(t)}}class _{constructor(){this.achievements=new Map,this.initializeAchievements()}initializeAchievements(){this.addAchievement({id:"first_delivery",name:"First Delivery",description:"Complete your first delivery",unlocked:!1,icon:"üöÇ"}),this.addAchievement({id:"millionaire",name:"Millionaire",description:"Earn $10,000 total revenue",unlocked:!1,icon:"üí∞"}),this.addAchievement({id:"speed_demon",name:"Speed Demon",description:"Complete a delivery in under 5 days",unlocked:!1,icon:"‚ö°"}),this.addAchievement({id:"train_collector",name:"Train Collector",description:"Own 10 trains simultaneously",unlocked:!1,icon:"üöÜ"})}addAchievement(t){this.achievements.set(t.id,t)}unlock(t){const i=this.achievements.get(t);return i&&!i.unlocked?(i.unlocked=!0,console.log(`Achievement unlocked: ${i.name}`),!0):!1}checkAchievements(t){const i=[];return t.deliveries>=1&&this.unlock("first_delivery")&&i.push("first_delivery"),t.totalRevenue>=1e4&&this.unlock("millionaire")&&i.push("millionaire"),t.lastDeliveryTime&&t.lastDeliveryTime<5&&this.unlock("speed_demon")&&i.push("speed_demon"),t.trainCount>=10&&this.unlock("train_collector")&&i.push("train_collector"),i}getAchievements(){return Array.from(this.achievements.values())}getUnlockedCount(){return Array.from(this.achievements.values()).filter(t=>t.unlocked).length}getUnlockedAchievements(){return Array.from(this.achievements.values()).filter(t=>t.unlocked).map(t=>t.id)}loadData(t){for(const i of t){const e=this.achievements.get(i);e&&(e.unlocked=!0)}}}class Z{constructor(){this.currentTooltip=null,this.tooltipElement=document.createElement("div"),this.tooltipElement.id="game-tooltip",this.tooltipElement.style.cssText=`
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            max-width: 200px;
            line-height: 1.4;
        `,document.body.appendChild(this.tooltipElement)}showTrainTooltip(t,i,e){const s=x.getTrainInfo(t.trainType),n=k.getCargoInfo(t.cargoType),a=[`üöÇ ${s.name} Train`,`üì¶ Cargo: ${n.name} ($${n.baseValue})`,`‚ö° Speed: ${s.speed.toFixed(1)} tiles/sec`,`üìç Position: (${t.x}, ${t.y})`];this.show(a,i,e)}showStationTooltip(t,i,e){const s=[`üè≠ ${t.stationType?.replace("_"," ")||"Station"}`,`üìç Location: (${t.x}, ${t.y})`];if(t.produces&&t.produces.length>0&&s.push(`üì§ Produces: ${t.produces.join(", ")}`),t.accepts&&t.accepts.length>0&&s.push(`üì• Accepts: ${t.accepts.join(", ")}`),t.storage){s.push("--- Storage ---");for(const[n,a]of Object.entries(t.storage))a>0&&s.push(`üì¶ ${n}: ${Math.floor(a)}`)}this.show(s,i,e)}show(t,i,e){this.tooltipElement.innerHTML=t.join("<br>"),this.tooltipElement.style.left=i+15+"px",this.tooltipElement.style.top=e+15+"px",this.tooltipElement.style.display="block"}hide(){this.tooltipElement.style.display="none"}}class J{constructor(){this.updateTimer=0,this.UPDATE_INTERVAL=10,this.prices=new Map,this.initializePrices()}initializePrices(){const t=k.getAllCargos();for(const i of t)this.prices.set(i.type,{cargoType:i.type,basePrice:i.baseValue,currentMultiplier:1,trend:0})}update(t){t-this.updateTimer>=this.UPDATE_INTERVAL&&(this.updatePrices(),this.updateTimer=t)}updatePrices(){for(const[t,i]of this.prices){const e=(Math.random()-.5)*.3;i.currentMultiplier=Math.max(.5,Math.min(2,i.currentMultiplier+e)),e>.05?i.trend=1:e<-.05?i.trend=-1:i.trend=0}console.log("Market prices updated!")}getCurrentPrice(t){const i=this.prices.get(t);return i?Math.floor(i.basePrice*i.currentMultiplier):k.getCargoInfo(t).baseValue}getPriceInfo(t){return this.prices.get(t)}getAllPrices(){return Array.from(this.prices.values())}}class Q{constructor(){this.DEGRADATION_RATE=.01,this.REPAIR_COST_PER_TILE=10,this.CRITICAL_HEALTH=.3,this.trackHealth=new Map}getKey(t,i){return`${t},${i}`}registerTrack(t,i,e){const s=this.getKey(t,i);this.trackHealth.has(s)||this.trackHealth.set(s,{x:t,y:i,health:1,lastMaintenance:e})}update(t){for(const[i,e]of this.trackHealth){const n=(t-e.lastMaintenance)*this.DEGRADATION_RATE;e.health=Math.max(0,1-n)}}repairTrack(t,i,e,s){const n=this.getKey(t,i),a=this.trackHealth.get(n);return!a||a.health>=1?!1:e.deduct(this.REPAIR_COST_PER_TILE)?(a.health=1,a.lastMaintenance=s,!0):!1}getTrackHealth(t,i){const e=this.getKey(t,i),s=this.trackHealth.get(e);return s?s.health:1}getCriticalTracks(){return Array.from(this.trackHealth.values()).filter(t=>t.health<this.CRITICAL_HEALTH)}getTotalMaintenanceCost(){return this.getCriticalTracks().length*this.REPAIR_COST_PER_TILE}}class tt{constructor(){this.audioContext=null,this.enabled=!0,this.musicEnabled=!0,this.volume=.5,this.musicOscillators=[],this.musicGain=null,this.isPlayingMusic=!1,window.addEventListener("click",()=>this.initAudioContext(),{once:!0}),window.addEventListener("keydown",()=>this.initAudioContext(),{once:!0})}initAudioContext(){if(this.audioContext)return;const t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t,this.musicEnabled&&this.startAmbientMusic()}playSound(t){if(!this.enabled||!this.audioContext)return;const i=this.audioContext,e=i.currentTime,s=i.createOscillator(),n=i.createGain();switch(s.connect(n),n.connect(i.destination),n.gain.setValueAtTime(this.volume*.3,e),t){case"click":s.type="sine",s.frequency.setValueAtTime(800,e),s.frequency.exponentialRampToValueAtTime(400,e+.1),n.gain.exponentialRampToValueAtTime(.01,e+.1),s.start(e),s.stop(e+.1);break;case"build":s.type="square",s.frequency.setValueAtTime(100,e),s.frequency.linearRampToValueAtTime(50,e+.1),n.gain.setValueAtTime(this.volume*.4,e),n.gain.exponentialRampToValueAtTime(.01,e+.2),s.start(e),s.stop(e+.2),this.playNoise(.2);break;case"train":this.playNoise(.1,200);break;case"delivery":s.type="sine",s.frequency.setValueAtTime(1200,e),s.frequency.setValueAtTime(1600,e+.1),n.gain.setValueAtTime(this.volume*.3,e),n.gain.exponentialRampToValueAtTime(.01,e+.4),s.start(e),s.stop(e+.4);break;case"achievement":this.playNote(523.25,e,.1,"triangle"),this.playNote(659.25,e+.1,.1,"triangle"),this.playNote(783.99,e+.2,.1,"triangle"),this.playNote(1046.5,e+.3,.4,"triangle");break;case"whistle":this.playNote(587.33,e,.4,"triangle"),this.playNote(698.46,e,.4,"triangle"),this.playNote(587.33,e+.1,.4,"triangle");break;case"error":s.type="sawtooth",s.frequency.setValueAtTime(150,e),s.frequency.linearRampToValueAtTime(100,e+.2),n.gain.exponentialRampToValueAtTime(.01,e+.3),s.start(e),s.stop(e+.3);break;case"ui-click":s.type="sine",s.frequency.setValueAtTime(600,e),s.frequency.exponentialRampToValueAtTime(300,e+.1),n.gain.setValueAtTime(this.volume*.2,e),n.gain.exponentialRampToValueAtTime(.01,e+.1),s.start(e),s.stop(e+.1);break;case"ui-hover":s.type="sine",s.frequency.setValueAtTime(400,e),n.gain.setValueAtTime(this.volume*.05,e),n.gain.exponentialRampToValueAtTime(.01,e+.05),s.start(e),s.stop(e+.05);break;case"levelUp":this.playNote(523.25,e,.1,"square"),this.playNote(659.25,e+.1,.1,"square"),this.playNote(783.99,e+.2,.1,"square"),this.playNote(1046.5,e+.3,.6,"square"),this.playNote(329.63,e,.4,"triangle"),this.playNote(392,e+.2,.4,"triangle");break;case"error":s.type="sawtooth",s.frequency.setValueAtTime(150,e),s.frequency.linearRampToValueAtTime(100,e+.2),n.gain.setValueAtTime(this.volume*.5,e),n.gain.exponentialRampToValueAtTime(.01,e+.3),s.start(e),s.stop(e+.3);break;case"gameOver":this.playNote(392,e,.3,"sawtooth"),this.playNote(369.99,e+.3,.3,"sawtooth"),this.playNote(349.23,e+.6,.3,"sawtooth"),this.playNote(329.63,e+.9,1,"sawtooth");break}}playNote(t,i,e,s="sine"){if(!this.audioContext)return;const n=this.audioContext,a=n.createOscillator(),r=n.createGain();a.type=s,a.frequency.value=t,a.connect(r),r.connect(n.destination),r.gain.setValueAtTime(this.volume*.2,i),r.gain.exponentialRampToValueAtTime(.01,i+e),a.start(i),a.stop(i+e)}playNoise(t,i){if(!this.audioContext)return;const e=this.audioContext,s=e.sampleRate*t,n=e.createBuffer(1,s,e.sampleRate),a=n.getChannelData(0);for(let c=0;c<s;c++)a[c]=Math.random()*2-1;const r=e.createBufferSource();r.buffer=n;const o=e.createGain();if(o.gain.setValueAtTime(this.volume*.1,e.currentTime),o.gain.exponentialRampToValueAtTime(.01,e.currentTime+t),i){const c=e.createBiquadFilter();c.type="lowpass",c.frequency.value=i,r.connect(c),c.connect(o)}else r.connect(o);o.connect(e.destination),r.start()}startAmbientMusic(){if(!this.audioContext||this.isPlayingMusic)return;this.isPlayingMusic=!0,this.musicGain=this.audioContext.createGain(),this.musicGain.gain.value=this.volume*.1,this.musicGain.connect(this.audioContext.destination),[220,277.18,329.63].forEach(i=>{const e=this.audioContext.createOscillator();e.type="sine",e.frequency.value=i,e.connect(this.musicGain),e.start(),this.musicOscillators.push(e);const s=this.audioContext.createOscillator();s.frequency.value=.1+Math.random()*.1;const n=this.audioContext.createGain();n.gain.value=5,s.connect(n),n.connect(e.frequency),s.start()})}stopAmbientMusic(){this.musicOscillators.forEach(t=>t.stop()),this.musicOscillators=[],this.isPlayingMusic=!1}toggleSound(){this.enabled=!this.enabled,this.musicEnabled=this.enabled,this.musicEnabled?this.startAmbientMusic():this.stopAmbientMusic()}toggleMusic(){this.musicEnabled=!this.musicEnabled,this.musicEnabled?this.startAmbientMusic():this.stopAmbientMusic()}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this.musicGain&&(this.musicGain.gain.value=this.volume*.1)}isSoundEnabled(){return this.enabled}}class et{constructor(){this.currentStep=0,this.active=!1,this.overlay=null,this.completed=!1,this.steps=this.createSteps(),this.checkIfCompleted()}checkIfCompleted(){const t=localStorage.getItem("railsim_tutorial_completed");this.completed=t==="true"}createSteps(){return[{id:"welcome",title:"üöÇ Welcome to RailSim!",message:"Build your railway empire! Let's learn the basics.",position:"center"},{id:"build_track",title:"üõ§Ô∏è Build Tracks",message:"Left-click on tiles to place tracks ($50 each). Try building a few!",position:"top"},{id:"build_station",title:"üöâ Build Station",message:"Right-click to place a station ($200). Stations are delivery points!",position:"top"},{id:"buy_train",title:"üöÇ Buy a Train",message:'Click "Buy Train" button to purchase your first train. It will automatically navigate!',position:"bottom"},{id:"watch_delivery",title:"üí∞ Watch & Earn",message:"Your train will deliver cargo to stations. Faster delivery = more money!",position:"center"},{id:"advanced",title:"üéì Advanced Tips",message:"Try: Different train types, station types, hover for info, check statistics!",position:"center"},{id:"complete",title:"‚úÖ Tutorial Complete!",message:"You're ready to build your empire. Good luck!",position:"center"}]}start(){this.completed||(this.active=!0,this.currentStep=0,this.showStep())}skip(){this.active=!1,this.completed=!0,localStorage.setItem("railsim_tutorial_completed","true"),this.hideOverlay()}showStep(){if(this.currentStep>=this.steps.length){this.complete();return}const t=this.steps[this.currentStep];this.createOverlay(t)}createOverlay(t){this.hideOverlay(),this.overlay=document.createElement("div"),this.overlay.style.cssText=`
            position: fixed;
            ${t.position==="center"?"top: 50%; left: 50%; transform: translate(-50%, -50%);":""}
            ${t.position==="top"?"top: 100px; left: 50%; transform: translateX(-50%);":""}
            ${t.position==="bottom"?"bottom: 100px; left: 50%; transform: translateX(-50%);":""}
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            z-index: 10000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 2px solid #4A90E2;
        `,this.overlay.innerHTML=`
            <h2 style="margin: 0 0 12px 0; font-size: 20px;">${t.title}</h2>
            <p style="margin: 0 0 16px 0; line-height: 1.5;">${t.message}</p>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button id="tutorial-skip" style="padding: 8px 16px; background: #666; border: none; border-radius: 4px; color: white; cursor: pointer;">Skip Tutorial</button>
                <button id="tutorial-next" style="padding: 8px 16px; background: #4A90E2; border: none; border-radius: 4px; color: white; cursor: pointer;">Next</button>
            </div>
        `,document.body.appendChild(this.overlay),document.getElementById("tutorial-next")?.addEventListener("click",()=>this.nextStep()),document.getElementById("tutorial-skip")?.addEventListener("click",()=>this.skip())}hideOverlay(){this.overlay&&(this.overlay.remove(),this.overlay=null)}nextStep(){this.currentStep++,this.showStep()}complete(){this.active=!1,this.completed=!0,localStorage.setItem("railsim_tutorial_completed","true"),this.hideOverlay()}isActive(){return this.active}isCompleted(){return this.completed}getCurrentStep(){return this.currentStep}reset(){localStorage.removeItem("railsim_tutorial_completed"),this.completed=!1,this.start()}}var b=(g=>(g.SMOKE="smoke",g.SPARKLE="sparkle",g.DUST="dust",g.STAR="star",g.STEAM="steam",g.SPARKS="sparks",g.MONEY="money",g.LEVEL_UP="level_up",g))(b||{});class it{constructor(){this.particles=[]}emit(t,i,e,s=10){for(let n=0;n<s;n++)this.particles.push(this.createParticle(t,i,e))}createFloatingText(t,i,e,s){const n={x:t,y:i,vx:0,vy:-1,life:0,maxLife:2,size:16,color:s,type:"money",alpha:1,text:e};this.particles.push(n)}createParticle(t,i,e){const s={x:i,y:e,vx:0,vy:0,life:0,maxLife:1,size:4,color:"#FFF",type:t,alpha:1};switch(t){case"smoke":s.vx=(Math.random()-.5)*2,s.vy=-2-Math.random()*3,s.maxLife=2,s.size=8+Math.random()*6,s.color=`rgba(80, 80, 80, ${.6+Math.random()*.2})`;break;case"sparkle":const n=Math.random()*Math.PI*2,a=2+Math.random()*3;s.vx=Math.cos(n)*a,s.vy=Math.sin(n)*a,s.maxLife=.8,s.size=3+Math.random()*3,s.color="#FFD700";break;case"dust":s.vx=(Math.random()-.5)*3,s.vy=-1-Math.random()*2,s.maxLife=.6,s.size=3+Math.random()*2,s.color="#8B7355";break;case"star":const r=Math.random()*Math.PI*2,o=4+Math.random()*4;s.vx=Math.cos(r)*o,s.vy=Math.sin(r)*o,s.maxLife=1.2,s.size=4+Math.random()*4;const c=["#FFD700","#FF6B6B","#51CF66","#4A90E2","#9B59B6"];s.color=c[Math.floor(Math.random()*c.length)];break;case"steam":s.vx=(Math.random()-.5)*1,s.vy=-2-Math.random()*1,s.maxLife=2,s.size=4+Math.random()*6,s.color=`rgba(255, 255, 255, ${.3+Math.random()*.2})`;break;case"sparks":const h=-Math.PI/2+(Math.random()-.5)*2,l=3+Math.random()*3;s.vx=Math.cos(h)*l,s.vy=Math.sin(h)*l,s.maxLife=.5,s.size=2+Math.random()*2,s.color="#FFD700";break;case"money":s.vx=(Math.random()-.5)*1,s.vy=-2-Math.random()*1,s.maxLife=2,s.size=14+Math.random()*6,s.color="#51CF66",s.text="$";break;case"level_up":s.vx=(Math.random()-.5)*5,s.vy=-5-Math.random()*5,s.maxLife=2,s.size=4+Math.random()*4;const u=["#FFD700","#FF6B6B","#51CF66","#4A90E2","#9B59B6"];s.color=u[Math.floor(Math.random()*u.length)];break}return s}update(t){for(let i=this.particles.length-1;i>=0;i--){const e=this.particles[i];e.x+=e.vx*t,e.y+=e.vy*t,e.type!=="smoke"&&e.type!=="money"&&e.type!=="steam"&&(e.vy+=5*t),e.vx*=.98,e.vy*=.98,e.life+=t,e.alpha=1-e.life/e.maxLife,e.life>=e.maxLife&&this.particles.splice(i,1)}}render(t,i,e,s){for(const n of this.particles){t.save(),t.globalAlpha=n.alpha;const a=n.x*i+e,r=n.y*i+s;n.type==="star"?this.drawStar(t,a,r,n.size,n.color):n.type==="money"&&n.text?(t.fillStyle=n.color,t.font=`bold ${n.size}px Arial`,t.textAlign="center",t.textBaseline="middle",t.shadowColor=n.color,t.shadowBlur=6,t.fillText(n.text,a,r),t.shadowBlur=0):(t.fillStyle=n.color,t.beginPath(),t.arc(a,r,n.size,0,Math.PI*2),t.fill()),t.restore()}}drawStar(t,i,e,s,n){t.fillStyle=n,t.beginPath();for(let a=0;a<5;a++){const r=a*4*Math.PI/5-Math.PI/2,o=a%2===0?s:s/2,c=i+Math.cos(r)*o,h=e+Math.sin(r)*o;a===0?t.moveTo(c,h):t.lineTo(c,h)}t.closePath(),t.fill()}getParticleCount(){return this.particles.length}}var I=(g=>(g.MAIN_MENU="main_menu",g.PLAYING="playing",g.PAUSED="paused",g.SETTINGS="settings",g))(I||{});class st{constructor(){this.currentState="main_menu",this.mainMenuElement=null,this.pauseMenuElement=null,this.settingsMenuElement=null,this.createMenus()}createMenus(){this.createMainMenu(),this.createPauseMenu(),this.createSettingsMenu()}createMainMenu(){this.mainMenuElement=document.createElement("div"),this.mainMenuElement.id="main-menu",this.mainMenuElement.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `,this.mainMenuElement.innerHTML=`
            <div class="glass-panel" style="padding: 60px; text-align: center; min-width: 400px; border: 1px solid rgba(255,255,255,0.1);">
                <h1 style="font-size: 72px; margin: 0 0 10px 0; background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));">
                    üöÇ RailSim
                </h1>
                <p style="font-size: 18px; margin: 0 0 50px 0; color: #a0a0a0; letter-spacing: 1px; text-transform: uppercase;">
                    Build Your Railway Empire
                </p>
                <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                    <button id="btn-new-game" class="primary" style="width: 100%; justify-content: center; padding: 16px; font-size: 16px;">
                        <span>‚ñ∂</span> New Game
                    </button>
                    <button id="btn-continue" style="width: 100%; justify-content: center; padding: 16px; font-size: 16px;">
                        <span>‚èØ</span> Continue
                    </button>
                    <div style="display: flex; gap: 10px; width: 100%;">
                         <button id="btn-editor" style="flex: 1; justify-content: center;">üõ† Editor</button>
                         <button id="btn-tutorial-menu" style="flex: 1; justify-content: center;">üéì Tutorial</button>
                    </div>
                    <button id="btn-settings-menu" style="width: 100%; justify-content: center;">‚öô Settings</button>
                </div>
                <p style="margin-top: 40px; color: #666; font-size: 12px;">
                    v1.1 ‚Ä¢ Premium Edition
                </p>
            </div>
        `,document.body.appendChild(this.mainMenuElement)}setCallbacks(t){document.getElementById("btn-new-game")?.addEventListener("click",t.onStartGame),document.getElementById("btn-continue")?.addEventListener("click",t.onResumeGame),document.getElementById("btn-editor")?.addEventListener("click",t.onOpenEditor),document.getElementById("btn-resume")?.addEventListener("click",t.onResumeGame),document.getElementById("btn-main-menu")?.addEventListener("click",t.onExitToMain),document.getElementById("btn-settings-menu")?.addEventListener("click",t.onOpenSettings),document.getElementById("btn-settings-pause")?.addEventListener("click",t.onOpenSettings),document.getElementById("btn-close-settings")?.addEventListener("click",()=>{this.settingsMenuElement.style.display="none",this.currentState==="paused"?this.pauseMenuElement.style.display="flex":this.mainMenuElement.style.display="flex"})}createPauseMenu(){this.pauseMenuElement=document.createElement("div"),this.pauseMenuElement.id="pause-menu",this.pauseMenuElement.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        `,this.pauseMenuElement.innerHTML=`
            <div class="glass-panel" style="text-align: center; padding: 40px; min-width: 300px;">
                <h2 style="font-size: 32px; margin: 0 0 30px 0; color: #FFF;">Paused</h2>
                <div style="display: flex; flex-direction: column; gap: 16px; align-items: center;">
                    <button id="btn-resume" class="primary" style="width: 100%; justify-content: center;">Resume</button>
                    <button id="btn-settings-pause" style="width: 100%; justify-content: center;">Settings</button>
                    <button id="btn-main-menu" class="danger" style="width: 100%; justify-content: center;">Main Menu</button>
                </div>
            </div>
        `,document.body.appendChild(this.pauseMenuElement)}createSettingsMenu(){this.settingsMenuElement=document.createElement("div"),this.settingsMenuElement.id="settings-menu",this.settingsMenuElement.style.cssText=`
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 16px;
            border: 2px solid #4A90E2;
            display: none;
            z-index: 10000;
            min-width: 400px;
        `,this.settingsMenuElement.innerHTML=`
            <div class="glass-panel" style="padding: 30px; min-width: 400px;">
                <h2 style="margin: 0 0 24px 0; color: #FFF; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Settings</h2>
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div>
                        <label style="color: #CCC; display: block; margin-bottom: 8px; font-size: 14px;">Sound Volume</label>
                        <input type="range" id="sound-volume" min="0" max="100" value="50" style="width: 100%; accent-color: #4facfe;">
                    </div>
                    <div>
                        <label style="color: #CCC; display: block; margin-bottom: 8px; font-size: 14px;">Auto-save Interval</label>
                        <select id="autosave-interval" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); color: #FFF; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                            <option value="30">30 seconds</option>
                            <option value="60">1 minute</option>
                            <option value="300">5 minutes</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button id="btn-reset-tutorial" style="flex: 1; justify-content: center;">Reset Tutorial</button>
                        <button id="btn-clear-save" class="danger" style="flex: 1; justify-content: center;">Clear Save</button>
                    </div>
                    <button id="btn-close-settings" style="width: 100%; justify-content: center; margin-top: 10px;">Close</button>
                </div>
            </div>
        `,document.body.appendChild(this.settingsMenuElement)}setState(t){this.currentState=t,this.updateVisibility()}updateVisibility(){this.mainMenuElement&&(this.mainMenuElement.style.display=this.currentState==="main_menu"?"flex":"none"),this.pauseMenuElement&&(this.pauseMenuElement.style.display=this.currentState==="paused"?"flex":"none"),this.settingsMenuElement&&(this.settingsMenuElement.style.display=this.currentState==="settings"?"block":"none")}getState(){return this.currentState}setupEventListeners(t){document.getElementById("btn-new-game")?.addEventListener("click",t.onNewGame),document.getElementById("btn-continue")?.addEventListener("click",t.onContinue),document.getElementById("btn-tutorial-menu")?.addEventListener("click",t.onTutorial),document.getElementById("btn-resume")?.addEventListener("click",t.onResume),document.getElementById("btn-main-menu")?.addEventListener("click",t.onMainMenu),document.getElementById("btn-reset-tutorial")?.addEventListener("click",t.onResetTutorial),document.getElementById("btn-clear-save")?.addEventListener("click",t.onClearSave),document.getElementById("btn-settings-menu")?.addEventListener("click",()=>{this.setState("settings")}),document.getElementById("btn-settings-pause")?.addEventListener("click",()=>{this.setState("settings")}),document.getElementById("btn-close-settings")?.addEventListener("click",()=>{this.setState("main_menu")})}}class nt{constructor(){this.victoryConditions={targetRevenue:5e4,targetDeliveries:100},this.victoryScreenElement=null,this.isVictoryAchieved=!1,this.isGameOver=!1,this.createVictoryScreen()}createVictoryScreen(){this.victoryScreenElement=document.createElement("div"),this.victoryScreenElement.id="victory-screen",this.victoryScreenElement.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30, 60, 114, 0.95) 0%, rgba(42, 82, 152, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        `,this.victoryScreenElement.innerHTML=`
            <div style="text-align: center; animation: slideIn 0.5s ease;">
                <h1 id="victory-title" style="font-size: 72px; margin: 0 0 20px 0; color: #FFD700; text-shadow: 0 4px 8px rgba(0,0,0,0.5);">
                    üèÜ Victory!
                </h1>
                <p id="victory-subtitle" style="font-size: 24px; margin: 0 0 40px 0; color: #E0E0E0;">
                    You've built a successful railway empire!
                </p>
                
                <div style="background: rgba(0,0,0,0.3); padding: 30px; border-radius: 12px; margin-bottom: 40px; min-width: 400px;">
                    <h3 style="margin: 0 0 20px 0; color: #FFF;">Final Statistics</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: left; color: #CCC;">
                        <div>üí∞ Total Revenue:</div>
                        <div id="final-revenue" style="color: #FFD700; font-weight: bold;">$0</div>
                        
                        <div>üì¶ Deliveries:</div>
                        <div id="final-deliveries" style="color: #51CF66; font-weight: bold;">0</div>
                        
                        <div>‚è±Ô∏è Time Played:</div>
                        <div id="final-time" style="color: #4A90E2; font-weight: bold;">0 days</div>
                        
                        <div>üöÇ Trains Owned:</div>
                        <div id="final-trains" style="color: #FF6B6B; font-weight: bold;">0</div>
                        
                        <div>üèÜ Achievements:</div>
                        <div id="final-achievements" style="color: #9B59B6; font-weight: bold;">0/4</div>
                        
                        <div>üíé Highest Delivery:</div>
                        <div id="final-highest" style="color: #FFD700; font-weight: bold;">$0</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 16px; justify-content: center;">
                    <button id="btn-play-again" class="menu-button" style="width: 200px;">Play Again</button>
                    <button id="btn-victory-menu" class="menu-button" style="width: 200px;">Main Menu</button>
                </div>
            </div>
        `,document.body.appendChild(this.victoryScreenElement)}checkVictory(t){if(this.isVictoryAchieved||this.isGameOver)return!1;const i=this.victoryConditions.targetRevenue?t.totalRevenue>=this.victoryConditions.targetRevenue:!1,e=this.victoryConditions.targetDeliveries?t.totalDeliveries>=this.victoryConditions.targetDeliveries:!1;return i||e?(this.isVictoryAchieved=!0,!0):!1}showVictoryScreen(t){this.victoryScreenElement&&(document.getElementById("final-revenue").textContent=`$${Math.floor(t.totalRevenue)}`,document.getElementById("final-deliveries").textContent=t.totalDeliveries.toString(),document.getElementById("final-time").textContent=`${Math.floor(t.gameDays)} days`,document.getElementById("final-trains").textContent=t.trainCount.toString(),document.getElementById("final-achievements").textContent=`${t.achievementCount}/4`,document.getElementById("final-highest").textContent=`$${Math.floor(t.highestRevenue)}`,this.victoryScreenElement.style.display="flex")}showGameOverScreen(t){if(!this.victoryScreenElement||this.isVictoryAchieved||this.isGameOver)return;this.isGameOver=!0;const i=this.victoryScreenElement.querySelector("#victory-title"),e=this.victoryScreenElement.querySelector("#victory-subtitle"),s=this.victoryScreenElement;i&&(i.textContent="üíÄ Game Over",i.style.color="#FF6B6B"),e&&(e.textContent="Your railway empire has gone bankrupt!"),s.style.background="linear-gradient(135deg, rgba(60, 0, 0, 0.95) 0%, rgba(30, 0, 0, 0.95) 100%)",document.getElementById("final-revenue").textContent=`$${Math.floor(t.totalRevenue)}`,document.getElementById("final-deliveries").textContent=t.totalDeliveries.toString(),document.getElementById("final-time").textContent=`${Math.floor(t.gameDays)} days`,this.victoryScreenElement.style.display="flex"}hide(){if(this.victoryScreenElement&&(this.victoryScreenElement.style.display="none"),this.isVictoryAchieved=!1,this.isGameOver=!1,this.victoryScreenElement){this.victoryScreenElement.style.background="linear-gradient(135deg, rgba(30, 60, 114, 0.95) 0%, rgba(42, 82, 152, 0.95) 100%)";const t=this.victoryScreenElement.querySelector("#victory-title");t&&(t.textContent="üèÜ Victory!",t.style.color="#FFD700")}}setupEventListeners(t){document.getElementById("btn-play-again")?.addEventListener("click",t.onPlayAgain),document.getElementById("btn-victory-menu")?.addEventListener("click",t.onMainMenu)}}class z{constructor(){this.xp=0,this.level=1,this.nextLevelXp=1e3,this.unlockFlags=new Set,this.activeBonuses={speed:1,capacity:1,revenue:1},this.rewards=[{level:2,description:"Unlock Fast Trains",unlocks:["FAST_TRAIN"]},{level:3,description:"Unlock Heavy Trains",unlocks:["HEAVY_TRAIN"]},{level:4,description:"Unlock Advanced Industries (Steel, Tool Factory)"},{level:5,description:"Unlock Express Trains",unlocks:["EXPRESS_TRAIN"]},{level:6,description:"Master Tycoon Status"}],this.load()}addXp(t){this.xp+=t;const i=[];let e=!1;for(;this.xp>=this.nextLevelXp;)this.levelUp(i),e=!0;return this.save(),{notifications:i,leveledUp:e}}levelUp(t){this.xp-=this.nextLevelXp,this.level++,this.nextLevelXp=Math.floor(this.nextLevelXp*1.5);const i=this.rewards.find(e=>e.level===this.level);i?(t.push(`Level Up! ${this.level}: ${i.description}`),i.unlocks&&i.unlocks.forEach(e=>this.unlockFlags.add(e)),i.bonus&&(i.bonus.type==="SPEED"&&(this.activeBonuses.speed*=i.bonus.value),i.bonus.type==="CAPACITY"&&(this.activeBonuses.capacity*=i.bonus.value),i.bonus.type==="REVENUE"&&(this.activeBonuses.revenue*=i.bonus.value))):t.push(`Level Up! You are now level ${this.level}`)}getLevel(){return this.level}getXp(){return this.xp}getNextLevelXp(){return this.nextLevelXp}getBonuses(){return this.activeBonuses}isUnlocked(t){return this.unlockFlags.has(t)}save(){const t={xp:this.xp,level:this.level,nextLevelXp:this.nextLevelXp,unlockFlags:Array.from(this.unlockFlags),activeBonuses:this.activeBonuses};localStorage.setItem("railsim_progression",JSON.stringify(t))}loadData(t){t&&(this.xp=t.xp,this.level=t.level,this.nextLevelXp=t.nextLevelXp,this.unlockFlags=new Set(t.unlockFlags),this.activeBonuses=t.activeBonuses||{speed:1,capacity:1,revenue:1})}loadFromSave(t){this.loadData(t)}load(){const t=localStorage.getItem("railsim_progression");t&&this.loadData(JSON.parse(t))}}class at{constructor(t){this.currentGoal=null,this.goalElement=null,this.goalTextElement=null,this.progressionManager=t,this.goalElement=document.getElementById("goal-container"),this.goalTextElement=document.getElementById("current-goal-text"),this.generateNewGoal(),this.updateUI()}generateNewGoal(){const t=this.progressionManager.getLevel(),i=["money","delivery","trains","passengers","tracks"],e=i[Math.floor(Math.random()*i.length)];let s=0,n="",a=0;const r=1+(t-1)*.5;if(t===1&&!this.currentGoal){s=5,n="Build 5 Tracks",a=250,this.currentGoal={id:Date.now().toString(),description:n,target:s,current:0,type:"tracks",completed:!1,reward:a},console.log(`New Goal Generated: ${n}`);return}switch(e){case"money":s=Math.floor(500*r),n=`Earn $${s}`,a=Math.floor(100*r);break;case"delivery":s=Math.floor(10*r),n=`Deliver ${s} Cargo`,a=Math.floor(150*r);break;case"passengers":s=Math.floor(20*r),n=`Transport ${s} Passengers`,a=Math.floor(120*r);break;case"trains":s=Math.max(1,Math.floor(1*r*.5)),n=`Buy ${s} New Train${s>1?"s":""}`,a=Math.floor(200*r);break;case"tracks":s=Math.floor(20*r),n=`Build ${s} Tracks`,a=Math.floor(50*r);break}this.currentGoal={id:Date.now().toString(),description:n,target:s,current:0,type:e,completed:!1,reward:a},console.log(`New Goal Generated: ${n}`)}updateProgress(t,i){!this.currentGoal||this.currentGoal.completed||this.currentGoal.type===t&&(this.currentGoal.current+=i,this.currentGoal.current>=this.currentGoal.target?this.completeGoal():this.updateUI())}completeGoal(){this.currentGoal&&(this.currentGoal.completed=!0,this.currentGoal.current=this.currentGoal.target)}checkCompletion(){if(this.currentGoal&&this.currentGoal.completed){const t=this.currentGoal.reward;return this.generateNewGoal(),this.updateUI(),t}return 0}getCurrentGoal(){return this.currentGoal}restoreGoal(t){this.currentGoal=t,this.updateUI()}updateUI(){if(!this.goalTextElement||!this.goalElement)return;const t=this.currentGoal;t&&(this.goalTextElement.textContent=`${t.description} (${t.current}/${t.target})`,this.goalTextElement.style.color="#FFD700",this.goalElement.classList.remove("pulse"),this.goalElement.offsetWidth,this.goalElement.classList.add("pulse"))}}class ot{constructor(t,i){this.x=0,this.y=0,this.zoom=1,this.targetX=0,this.targetY=0,this.targetZoom=1,this.minZoom=.5,this.maxZoom=2,this.lerpFactor=.1,this.x=t,this.y=i,this.targetX=t,this.targetY=i}update(){this.x+=(this.targetX-this.x)*this.lerpFactor,this.y+=(this.targetY-this.y)*this.lerpFactor,this.zoom+=(this.targetZoom-this.zoom)*this.lerpFactor,Math.abs(this.targetX-this.x)<.1&&(this.x=this.targetX),Math.abs(this.targetY-this.y)<.1&&(this.y=this.targetY),Math.abs(this.targetZoom-this.zoom)<.001&&(this.zoom=this.targetZoom)}move(t,i){this.targetX+=t,this.targetY+=i}setPosition(t,i){this.targetX=t,this.targetY=i}setZoom(t,i,e){const s=Math.max(this.minZoom,Math.min(this.maxZoom,t));this.targetZoom=s}zoomIn(t){this.targetZoom=Math.min(this.maxZoom,this.targetZoom+t)}zoomOut(t){this.targetZoom=Math.max(this.minZoom,this.targetZoom-t)}}class rt{constructor(t){this.stats=t,this.revenueHistory=[],this.maxHistoryPoints=100,this.load()}recordDailyRevenue(t,i){this.revenueHistory.push({day:t,value:i}),this.revenueHistory.length>this.maxHistoryPoints&&this.revenueHistory.shift(),this.save()}getRevenueHistory(){return[...this.revenueHistory]}getRevenueToday(){return this.revenueHistory.length===0?0:this.revenueHistory[this.revenueHistory.length-1].value}getAverageRevenue(t=7){if(this.revenueHistory.length===0)return 0;const i=this.revenueHistory.slice(-t);return i.reduce((s,n)=>s+n.value,0)/i.length}getRevenueTrend(){if(this.revenueHistory.length<2)return"STABLE";const t=this.revenueHistory.slice(-7);if(t.length<2)return"STABLE";const i=t.slice(0,Math.floor(t.length/2)),e=t.slice(Math.floor(t.length/2)),s=i.reduce((o,c)=>o+c.value,0)/i.length,a=e.reduce((o,c)=>o+c.value,0)/e.length-s,r=s*.1;return a>r?"UP":a<-r?"DOWN":"STABLE"}renderMiniChart(t,i,e,s,n){if(this.revenueHistory.length<2)return;const a=this.revenueHistory,r=Math.max(...a.map(d=>d.value),1),o=Math.min(...a.map(d=>d.value),0),c=r-o||1;t.save(),t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillRect(i,e,s,n),t.strokeStyle="rgba(255, 255, 255, 0.1)",t.lineWidth=1;for(let d=0;d<=4;d++){const y=e+n/4*d;t.beginPath(),t.moveTo(i,y),t.lineTo(i+s,y),t.stroke()}t.strokeStyle="#51CF66",t.lineWidth=2,t.beginPath(),a.forEach((d,y)=>{const m=i+y/(a.length-1)*s,f=(d.value-o)/c,v=e+n-f*n;y===0?t.moveTo(m,v):t.lineTo(m,v)}),t.stroke();const h=this.getRevenueTrend(),l=h==="UP"?"üìà":h==="DOWN"?"üìâ":"‚û°Ô∏è",u=h==="UP"?"#51CF66":h==="DOWN"?"#FF6B6B":"#888";t.fillStyle=u,t.font="bold 12px Arial",t.textAlign="right",t.fillText(l,i+s-5,e+15),t.restore()}save(){const t={revenueHistory:this.revenueHistory};localStorage.setItem("railsim_charts",JSON.stringify(t))}load(){const t=localStorage.getItem("railsim_charts");if(t)try{const i=JSON.parse(t);this.revenueHistory=i.revenueHistory||[]}catch(i){console.error("Failed to load chart data:",i)}}reset(){this.revenueHistory=[],this.save()}}class lt{constructor(){this.routes=[]}createRoute(t,i){const e={id:this.generateId(),name:t,stops:[],color:i,assignedTrains:[]};return this.routes.push(e),e}deleteRoute(t){this.routes=this.routes.filter(i=>i.id!==t)}getRoute(t){return this.routes.find(i=>i.id===t)}getAllRoutes(){return this.routes}addStop(t,i,e){const s=this.getRoute(t);s&&s.stops.push({x:i,y:e})}removeStop(t,i){const e=this.getRoute(t);e&&i>=0&&i<e.stops.length&&e.stops.splice(i,1)}generateId(){return"route_"+Math.random().toString(36).substr(2,9)}}class ct{constructor(){this.trains=[],this.lastTime=0,this.selectedSpawnStation=null,this.selectedTrainType=M.NORMAL,this.autoSaveInterval=0,this.isPaused=!1,this.keys={},this.isDragging=!1,this.dragStartTile=null,this.dragEndTile=null,this.currentMouseTile=null,this.selectedTrain=null,this.lastBuildAction=null,this.lastDay=0,this.revenueAtStartOfDay=0,this.editingRouteId=null,this.isPlacingStation=!1,this.isSettingSpawn=!1,this.isDemolishing=!1,this.isPanning=!1,this.lastMouseX=0,this.lastMouseY=0;const t=document.getElementById("gameCanvas");this.renderer=new K(t),this.map=new B(20,15),this.trains=[],this.revenueSimulator=new q,this.economy=new C(2500),this.timeManager=new P,this.notificationManager=new j,this.statisticsManager=new G,this.achievementManager=new _,this.tooltipManager=new Z,this.marketManager=new J,this.maintenanceManager=new Q,this.audioManager=new tt,this.tutorialManager=new et,this.particleManager=new it,this.menuManager=new st,this.victoryManager=new nt,this.progressionManager=new z,this.goalManager=new at(this.progressionManager),this.eventManager=new X,this.camera=new ot(0,0),this.chartManager=new rt(this.statisticsManager),this.routeManager=new lt,this.editorManager=new Y(this),this.lastTime=performance.now();const i=A.load();if(i)this.loadGame(i);else{const e=this.map.getCapitalCity();e?(this.camera.x=-e.x*64+400,this.camera.y=-e.y*64+300):(this.camera.x=-100,this.camera.y=-100)}this.setupInput(t),this.setupUIControls(),this.setupRouteUI(),this.setupTrainDetailsUI(),this.setupMenuCallbacks(),this.setupVictoryCallbacks(),this.editorManager.setupUI(),this.updateUI(),this.loop(),setInterval(()=>{this.isPaused||this.saveGame()},3e4)}saveGame(){const t=document.getElementById("auto-save-indicator");t&&(t.style.opacity="1",setTimeout(()=>{t.style.opacity="0"},1500)),A.save(this.economy,this.timeManager,this.trains,this.map,this.progressionManager,this.statisticsManager,this.achievementManager,this.selectedSpawnStation,this.routeManager,this.goalManager,this.eventManager)}loadGame(t){console.log("Loading save data...",t),t&&t.economy?this.economy=new C(t.economy.balance):this.economy=new C(1e3),this.timeManager=new P,t&&t.time&&this.timeManager.setSpeed(t.time.gameSpeed);const i=t&&t.map&&t.map.width?t.map.width:20,e=t&&t.map&&t.map.height?t.map.height:15;if(this.map=new B(i,e),t&&t.map&&t.map.tiles)for(const s of t.map.tiles){const n=this.map.getTile(s.x,s.y);n&&(n.trackType=s.trackType,n.stationType=s.stationType,n.terrainType=s.terrainType||"GRASS",n.bitmaskValue=s.bitmaskValue||0,n.trackType==="station"&&n.stationType&&(this.map.restoreStation(n.x,n.y,n.stationType),(s.storage||s.lastProduction)&&this.map.restoreStationData(n.x,n.y,s.storage,s.lastProduction||0)))}if(this.trains=[],t&&t.trains)for(const s of t.trains){const n=new N(s.x,s.y,s.trainType,s.startTime,s.cargoType);if(s.assignedRouteId){const a=this.routeManager.getRoute(s.assignedRouteId);a&&(n.assignedRoute=a)}this.trains.push(n)}t&&t.goal&&this.goalManager.restoreGoal(t.goal),t&&t.event&&this.eventManager.restoreEvent(t.event),this.progressionManager=new z,t&&t.progression&&this.progressionManager.loadFromSave(t.progression),this.statisticsManager=new G,t&&t.statistics&&this.statisticsManager.loadStats(t.statistics),this.achievementManager=new _,t&&t.achievements&&this.achievementManager.loadData(t.achievements),t&&t.selectedSpawn&&(this.selectedSpawnStation=t.selectedSpawn),this.updateUI(),console.log("Game loaded!")}setupUIControls(){document.getElementById("btn-buy-train")?.addEventListener("click",()=>{this.buyTrain()}),document.getElementById("btn-pause")?.addEventListener("click",()=>{this.timeManager.setSpeed(0),this.isPaused=!0}),document.getElementById("btn-play")?.addEventListener("click",()=>{this.timeManager.setSpeed(1),this.isPaused=!1}),document.getElementById("btn-fast")?.addEventListener("click",()=>{this.timeManager.setSpeed(5),this.isPaused=!1}),document.getElementById("btn-train-normal")?.addEventListener("click",()=>{this.selectedTrainType=M.NORMAL,this.updateUI()}),document.getElementById("btn-train-fast")?.addEventListener("click",()=>{this.progressionManager.getLevel()>=x.getTrainInfo(M.FAST).unlockLevel&&(this.selectedTrainType=M.FAST,this.updateUI())}),document.getElementById("btn-train-heavy")?.addEventListener("click",()=>{this.progressionManager.getLevel()>=x.getTrainInfo(M.HEAVY).unlockLevel&&(this.selectedTrainType=M.HEAVY,this.updateUI())}),document.getElementById("btn-train-express")?.addEventListener("click",()=>{this.progressionManager.getLevel()>=x.getTrainInfo(M.EXPRESS).unlockLevel&&(this.selectedTrainType=M.EXPRESS,this.updateUI())}),document.getElementById("stats-toggle")?.addEventListener("click",()=>{const e=document.getElementById("stats-panel"),s=document.getElementById("stats-toggle");if(e&&s){const n=e.style.display==="none";e.style.display=n?"block":"none",s.textContent=n?"üìä Statistics ‚ñº":"üìä Statistics ‚ñ∂"}this.audioManager.playSound("click")}),document.getElementById("btn-sound-toggle")?.addEventListener("click",()=>{this.audioManager.toggleSound();const e=document.getElementById("btn-sound-toggle");e&&(e.textContent=this.audioManager.isSoundEnabled()?"üîä":"üîá")}),document.getElementById("btn-build-track")?.addEventListener("click",()=>{this.isPlacingStation=!1,this.isSettingSpawn=!1,this.isDemolishing=!1,this.updateCursor(),this.updateButtonStates(),this.notificationManager.addNotification("Build Mode Active (Drag to Build)",10,10,"#FFFFFF")}),document.getElementById("btn-place-station")?.addEventListener("click",()=>{this.isPlacingStation=!this.isPlacingStation,this.isSettingSpawn=!1,this.isDemolishing=!1,this.updateCursor(),this.updateButtonStates(),this.notificationManager.addNotification(this.isPlacingStation?"Click to Place Station":"Cancelled",10,10,"#FFFFFF")}),document.getElementById("btn-set-spawn")?.addEventListener("click",()=>{this.isSettingSpawn=!this.isSettingSpawn,this.isPlacingStation=!1,this.isDemolishing=!1,this.updateCursor(),this.updateButtonStates(),this.notificationManager.addNotification(this.isSettingSpawn?"Click Station to Set Spawn":"Cancelled",10,10,"#FFFFFF")}),document.getElementById("btn-demolish")?.addEventListener("click",()=>{this.isDemolishing=!this.isDemolishing,this.isPlacingStation=!1,this.isSettingSpawn=!1,this.updateCursor(),this.updateButtonStates(),this.notificationManager.addNotification(this.isDemolishing?"Click to Demolish (50% refund)":"Cancelled",10,10,"#FFFFFF")}),document.getElementById("btn-undo")?.addEventListener("click",()=>{this.undoLastBuild()}),document.getElementById("btn-close-help")?.addEventListener("click",()=>{const e=document.getElementById("help-overlay");e&&(e.style.display="none")});const i=(e,s)=>this.camera.move(e,s);document.getElementById("btn-cam-up")?.addEventListener("click",()=>i(0,-50)),document.getElementById("btn-cam-down")?.addEventListener("click",()=>i(0,50)),document.getElementById("btn-cam-left")?.addEventListener("click",()=>i(-50,0)),document.getElementById("btn-cam-right")?.addEventListener("click",()=>i(50,0)),document.getElementById("btn-cam-reset")?.addEventListener("click",()=>{this.camera.x=-100,this.camera.y=-100}),document.querySelectorAll("button").forEach(e=>{e.addEventListener("mouseenter",()=>{e.disabled||this.audioManager.playSound("ui-hover")}),e.addEventListener("click",()=>{e.disabled||this.audioManager.playSound("ui-click")})}),document.getElementById("btn-toggle-market")?.addEventListener("click",()=>{const e=document.getElementById("market-dashboard");e&&(e.style.display=e.style.display==="none"?"block":"none",e.style.display==="block"&&this.updateMarketUI())}),document.getElementById("btn-close-market")?.addEventListener("click",()=>{const e=document.getElementById("market-dashboard");e&&(e.style.display="none")})}buyTrain(){if(console.log("buyTrain called, balance:",this.economy.getBalance()),!this.selectedSpawnStation){this.notificationManager.addNotification("Select a spawn station first (press E)!",10,10,"#FF0000");return}const t=this.map.getTile(this.selectedSpawnStation.x,this.selectedSpawnStation.y);if(!t||t.trackType!=="station"){this.notificationManager.addNotification("Not a station! Build a station with Q.",10,10,"#FF0000"),this.audioManager.playSound("error");return}this.selectedSpawnStation.x===t.x&&(this.selectedSpawnStation.y,t.y);const i=x.getTrainInfo(this.selectedTrainType);if(this.economy.deduct(i.cost)){const e=p.PASSENGERS,s=new N(this.selectedSpawnStation.x,this.selectedSpawnStation.y,this.selectedTrainType,this.timeManager.getGameTimeDays(),e);if(this.editingRouteId){const a=this.routeManager.getRoute(this.editingRouteId);a&&a.stops.length>0&&(s.assignedRoute=a,this.notificationManager.addNotification(`Assigned to ${a.name}`,this.selectedSpawnStation.x,this.selectedSpawnStation.y-1,a.color))}this.trains.push(s),console.log(`Train added! Total trains: ${this.trains.length}`);const n=document.getElementById("train-count");n&&(n.innerText=this.trains.length.toString(),console.log("Train count UI updated to:",this.trains.length)),this.updateUI(),this.audioManager.playSound("build"),this.audioManager.playSound("build"),this.audioManager.playSound("whistle"),this.goalManager.updateProgress("trains",1),this.checkGoalCompletion(),this.particleManager.emit(b.SMOKE,this.selectedSpawnStation.x,this.selectedSpawnStation.y,10),!this.tutorialManager.isCompleted()&&this.tutorialManager.getCurrentStep()===1&&this.tutorialManager.nextStep(),this.notificationManager.addNotification("Train spawned! üöÇ",this.selectedSpawnStation.x,this.selectedSpawnStation.y,"#51CF66")}else this.notificationManager.addNotification("Not enough money!",this.selectedSpawnStation.x,this.selectedSpawnStation.y,"#FF0000"),this.audioManager.playSound("error")}setupInput(t){t.addEventListener("mousedown",i=>{const e=t.getBoundingClientRect(),s=i.clientX-e.left,n=i.clientY-e.top,a=this.renderer.getTileFromScreen(s,n,this.camera);if(this.editorManager.isEditorActive()){i.button===0&&(this.editorManager.handleClick(a.x,a.y),this.updateUI());return}if(i.button===2){this.isPanning=!0,this.lastMouseX=i.clientX,this.lastMouseY=i.clientY,t.style.cursor="grabbing";return}if(i.button===0){if(this.isPlacingStation){this.map.placeStation(a.x,a.y,this.economy,this.progressionManager.getLevel())?(this.audioManager.playSound("build"),this.particleManager.emit(b.DUST,a.x+.5,a.y+.5,12),this.selectedSpawnStation||(this.selectedSpawnStation={x:a.x,y:a.y},this.notificationManager.addNotification("Spawn Point Set!",a.x,a.y,"#00FF00")),this.updateUI(),this.isPlacingStation=!1,this.updateCursor()):(this.audioManager.playSound("error"),this.notificationManager.addNotification("Cannot Build Here!",a.x,a.y,"#FF0000"));return}if(this.isDemolishing){this.map.demolishTile(a.x,a.y,this.economy)?(this.audioManager.playSound("build"),this.particleManager.emit(b.DUST,a.x+.5,a.y+.5,12),this.notificationManager.addNotification("Demolished!",a.x,a.y,"#FFA500"),this.updateUI(),this.isDemolishing=!1,this.updateCursor()):(this.audioManager.playSound("error"),this.notificationManager.addNotification("Nothing to demolish!",a.x,a.y,"#FF0000"));return}if(this.isSettingSpawn){const o=this.map.getTile(a.x,a.y);o&&o.trackType==="station"?(this.selectedSpawnStation={x:a.x,y:a.y},this.notificationManager.addNotification("Spawn Point Set!",a.x,a.y,"#00FF00"),this.updateUI(),this.isSettingSpawn=!1,this.updateCursor()):this.notificationManager.addNotification("Not a Station!",a.x,a.y,"#FF0000");return}let r=!1;for(const o of this.trains){const c=o.getVisualPosition(),h=t.width/2,l=t.height/2,u=(s-h)/this.camera.zoom+h+this.camera.x,d=(n-l)/this.camera.zoom+l+this.camera.y,y=(c.x+.5)*40,m=(c.y+.5)*40,f=u-y,v=d-m;if(Math.sqrt(f*f+v*v)<20){this.selectedTrain=o,this.updateTrainDetailsUI(),r=!0,this.audioManager.playSound("click");break}}if(r||(this.selectedTrain&&(this.selectedTrain=null,this.updateTrainDetailsUI()),this.editingRouteId))return;this.isDragging=!0,this.dragStartTile={x:a.x,y:a.y},this.dragEndTile={x:a.x,y:a.y}}}),t.addEventListener("contextmenu",i=>i.preventDefault()),t.addEventListener("mousemove",i=>{const e=t.getBoundingClientRect(),s=i.clientX-e.left,n=i.clientY-e.top,a=this.renderer.getTileFromScreen(s,n,this.camera);if(this.currentMouseTile={x:a.x,y:a.y},this.isPanning){const o=i.clientX-this.lastMouseX,c=i.clientY-this.lastMouseY;this.camera.x-=o/this.camera.zoom,this.camera.y-=c/this.camera.zoom,this.lastMouseX=i.clientX,this.lastMouseY=i.clientY;return}this.isDragging?(this.dragEndTile={x:a.x,y:a.y},this.updateBuildCostPreview()):this.hideBuildCostPreview();let r=!1;for(const o of this.trains){const c=o.getVisualPosition(),h=t.width/2,l=t.height/2,u=(s-h)/this.camera.zoom+h+this.camera.x,d=(n-l)/this.camera.zoom+l+this.camera.y,y=(c.x+.5)*40,m=(c.y+.5)*40,f=u-y,v=d-m;if(Math.sqrt(f*f+v*v)<20){this.tooltipManager.showTrainTooltip(o,i.clientX,i.clientY),r=!0;break}}if(!r){const o=this.map.getTile(a.x,a.y);o&&o.trackType==="station"?this.tooltipManager.showStationTooltip(o,i.clientX,i.clientY):this.tooltipManager.hide()}}),t.addEventListener("mouseleave",()=>{this.tooltipManager.hide(),this.isDragging=!1,this.dragStartTile=null,this.dragEndTile=null}),window.addEventListener("mouseup",i=>{if(this.isPanning){this.isPanning=!1,t.style.cursor="default",this.updateCursor();return}if(this.editingRouteId){const e=t.getBoundingClientRect(),s=i.clientX-e.left,n=i.clientY-e.top,a=this.renderer.getTileFromScreen(s,n,this.camera),r=this.map.getTile(a.x,a.y);r&&r.trackType==="station"&&(this.routeManager.addStop(this.editingRouteId,a.x,a.y),this.updateRouteEditorUI(),this.audioManager.playSound("click"),this.particleManager.emit(b.SPARKLE,a.x+.5,a.y+.5,5));return}if(this.isDragging&&this.dragStartTile&&this.dragEndTile){const e=this.map.getTrackPath(this.dragStartTile,this.dragEndTile);this.map.buildTrackPath(e,this.economy,this.maintenanceManager,this.timeManager.getGameTimeDays())?(this.audioManager.playSound("build"),this.particleManager.emit(b.DUST,this.dragEndTile.x+.5,this.dragEndTile.y+.5,8),this.lastBuildAction={path:e,cost:e.length*20},this.updateUI(),this.goalManager.updateProgress("tracks",e.length),this.checkGoalCompletion()):(this.audioManager.playSound("error"),this.notificationManager.addNotification("Not Enough Money!",this.dragEndTile.x,this.dragEndTile.y,"#FF0000"))}this.isDragging=!1,this.dragStartTile=null,this.dragEndTile=null,this.hideBuildCostPreview()}),window.addEventListener("keydown",i=>{if(this.keys[i.code]=!0,i.code==="KeyQ"){if(this.currentMouseTile){const e=this.currentMouseTile;this.map.placeStation(e.x,e.y,this.economy,this.progressionManager.getLevel())?(this.audioManager.playSound("build"),this.particleManager.emit(b.DUST,e.x+.5,e.y+.5,12),this.selectedSpawnStation||(this.selectedSpawnStation={x:e.x,y:e.y},this.notificationManager.addNotification("Spawn Point Set!",e.x,e.y,"#00FF00")),this.updateUI()):(this.audioManager.playSound("error"),this.notificationManager.addNotification("Cannot Build Here!",e.x,e.y,"#FF0000"))}}else if(i.code==="KeyE"){if(this.currentMouseTile){const e=this.currentMouseTile,s=this.map.getTile(e.x,e.y);s&&s.trackType==="station"&&(this.selectedSpawnStation={x:e.x,y:e.y},console.log("Selected spawn station:",e.x,e.y),this.notificationManager.addNotification("Spawn Point Set!",e.x,e.y,"#00FF00"),this.updateUI())}}else if(i.code==="Space"){let e=0,s=0,n=!1;if(this.selectedSpawnStation)e=this.selectedSpawnStation.x,s=this.selectedSpawnStation.y,n=!0;else if(this.currentMouseTile){const a=this.map.getTile(this.currentMouseTile.x,this.currentMouseTile.y);a&&(a.trackType==="rail"||a.trackType==="station")&&(e=this.currentMouseTile.x,s=this.currentMouseTile.y,n=!0)}if(n){const a=new N(e,s,M.NORMAL,this.timeManager.getGameTimeDays());this.trains.push(a),this.audioManager.playSound("build"),this.particleManager.emit(b.SMOKE,e,s,10),this.updateUI()}else this.notificationManager.addNotification("Invalid Spawn!",10,10,"#FF0000"),this.audioManager.playSound("error")}if(i.key==="h"||i.key==="H"){const e=document.getElementById("help-overlay");if(e){const s=e.style.display==="flex";e.style.display=s?"none":"flex"}}(i.ctrlKey||i.metaKey)&&i.key==="z"&&(i.preventDefault(),this.undoLastBuild()),i.code==="Escape"&&(this.menuManager.getState()===I.PLAYING?(this.menuManager.setState(I.PAUSED),this.isPaused=!0):this.menuManager.getState()===I.PAUSED&&(this.menuManager.setState(I.PLAYING),this.isPaused=!1))}),window.addEventListener("keyup",i=>{this.keys[i.code]=!1}),t.addEventListener("wheel",i=>{i.preventDefault();const e=.1;i.deltaY<0?this.camera.zoomIn(e):this.camera.zoomOut(e)})}setupMenuCallbacks(){this.menuManager.setCallbacks({onStartGame:()=>{this.menuManager.setState(I.PLAYING),this.isPaused=!1,this.trains=[],this.selectedSpawnStation=null,this.economy=new C(2500),this.timeManager=new P,this.map=new B(60,40),this.updateUI(),this.tutorialManager.isCompleted()||setTimeout(()=>this.tutorialManager.start(),500)},onResumeGame:()=>{this.menuManager.setState(I.PLAYING),this.isPaused=!1},onRestartGame:()=>{localStorage.clear(),location.reload()},onOpenSettings:()=>{this.menuManager.setState(I.SETTINGS)},onExitToMain:()=>{this.menuManager.setState(I.MAIN_MENU),this.isPaused=!0},onOpenEditor:()=>{this.menuManager.setState(I.PLAYING),this.editorManager.setActive(!0),this.isPaused=!0}})}setupVictoryCallbacks(){this.victoryManager.setupEventListeners({onPlayAgain:()=>{this.victoryManager.hide(),this.menuManager.setState(I.PLAYING),this.isPaused=!1,this.trains=[],this.economy=new C(2500),this.timeManager=new P,this.statisticsManager=new G,this.map=new B(20,15),this.updateUI(),this.map=new B(20,15),this.updateUI(),this.checkGoalCompletion()},onMainMenu:()=>{this.victoryManager.hide(),this.menuManager.setState(I.MAIN_MENU)}})}updateUI(){const t=document.getElementById("revenue-display");t&&(t.innerText=this.economy.getBalance().toString());const i=document.getElementById("train-count");i&&(i.innerText=this.trains.length.toString());const e=document.getElementById("time-display");e&&(e.innerText=this.timeManager.getDayString());const s=document.getElementById("level-display");s&&(s.innerText=this.progressionManager.getLevel().toString());const n=document.getElementById("xp-display");if(n){const S=this.progressionManager.getXp(),E=this.progressionManager.getNextLevelXp()||1e3;n.innerText=`${S} / ${E}`}const a=this.statisticsManager.getStats(),r=document.getElementById("total-revenue");r&&(r.innerText=a.totalRevenue.toString());const o=document.getElementById("total-deliveries");o&&(o.innerText=a.totalDeliveries.toString());const c=document.getElementById("highest-revenue");c&&(c.innerText=a.highestRevenue.toString());const h=document.getElementById("achievement-count");h&&(h.innerText=this.achievementManager.getUnlockedCount().toString());const l=document.getElementById("stats-panel");if(l&&l.style.display!=="none"){const S=document.getElementById("revenue-chart");if(S){const E=S.getContext("2d");E&&this.chartManager.renderMiniChart(E,0,0,S.width,S.height)}}const u=document.getElementById("spawn-station");u&&(this.selectedSpawnStation?u.innerText=`(${this.selectedSpawnStation.x},${this.selectedSpawnStation.y})`:u.innerText="None");const d=document.getElementById("selected-train-type");if(d){const S=x.getTrainInfo(this.selectedTrainType);d.innerText=`${S.name} ($${S.cost})`,d.style.color=S.color}const y=document.getElementById("btn-train-normal"),m=document.getElementById("btn-train-fast"),f=document.getElementById("btn-train-heavy"),v=document.getElementById("btn-train-express");if(y&&y.classList.toggle("active",this.selectedTrainType===M.NORMAL),m){const S=this.progressionManager.getLevel()>=x.getTrainInfo(M.FAST).unlockLevel;m.classList.toggle("active",this.selectedTrainType===M.FAST),m.style.opacity=S?"1":"0.3",m.style.cursor=S?"pointer":"not-allowed",S||(m.title=`Unlocks at Level ${x.getTrainInfo(M.FAST).unlockLevel}`)}if(f){const S=this.progressionManager.getLevel()>=x.getTrainInfo(M.HEAVY).unlockLevel;f.classList.toggle("active",this.selectedTrainType===M.HEAVY),f.style.opacity=S?"1":"0.3",f.style.cursor=S?"pointer":"not-allowed",S||(f.title=`Unlocks at Level ${x.getTrainInfo(M.HEAVY).unlockLevel}`)}if(v){const S=this.progressionManager.getLevel()>=x.getTrainInfo(M.EXPRESS).unlockLevel;v.classList.toggle("active",this.selectedTrainType===M.EXPRESS),v.style.opacity=S?"1":"0.3",v.style.cursor=S?"pointer":"not-allowed",S||(v.title=`Unlocks at Level ${x.getTrainInfo(M.EXPRESS).unlockLevel}`)}const T=document.getElementById("btn-buy-train");if(T){const S=x.getTrainInfo(this.selectedTrainType);this.economy.getBalance()>=S.cost?(T.classList.add("pulse-button"),T.classList.add("success")):(T.classList.remove("pulse-button"),T.classList.remove("success"))}}updateBuildCostPreview(){if(!this.dragStartTile||!this.dragEndTile)return;const i=this.map.getTrackPath(this.dragStartTile,this.dragEndTile).length*20,e=document.getElementById("build-cost-preview"),s=document.getElementById("build-cost-amount");if(e&&s){e.style.display="flex",s.textContent=`$${i}`;const n=this.economy.getBalance()>=i;s.style.color=n?"#51CF66":"#FF6B6B",n||(s.style.transform="scale(1.1)",setTimeout(()=>s.style.transform="scale(1)",100))}}hideBuildCostPreview(){const t=document.getElementById("build-cost-preview");t&&(t.style.display="none")}celebrateFirstDelivery(t,i){const e=document.getElementById("gameCanvas");e&&(e.style.animation="screen-shake 0.3s",setTimeout(()=>{e.style.animation=""},300));for(let s=0;s<30;s++){const n=Math.PI*2*s/30,a=2+Math.random()*2,r=Math.cos(n)*a,o=Math.sin(n)*a;this.particleManager.emit(b.SPARKLE,t+r*.5,i+o*.5,1)}this.notificationManager.addNotification("üéâ FIRST DELIVERY! üéâ",t,i-2,"#FFD700"),this.audioManager.playSound("achievement")}undoLastBuild(){if(!this.lastBuildAction){this.notificationManager.addNotification("Nothing to undo!",10,10,"#FF6B6B");return}this.economy.add(this.lastBuildAction.cost),this.notificationManager.addNotification(`Refunded $${this.lastBuildAction.cost}`,10,10,"#51CF66"),this.audioManager.playSound("achievement"),this.lastBuildAction=null,this.updateUI()}checkGoalCompletion(){const t=this.goalManager.checkCompletion();if(t>0){this.economy.add(t),this.audioManager.playSound("achievement");const i=document.getElementById("gameCanvas"),e=i?i.width/2:window.innerWidth/2,s=i?i.height/2:window.innerHeight/2;this.notificationManager.addNotification(`Goal Complete! +$${t}`,e,s,"#FFD700");const n=Math.floor(t/10),a=this.progressionManager.addXp(n);for(const r of a.notifications)this.notificationManager.addNotification(r,e,s-30,"#51CF66");a.leveledUp&&(this.audioManager.playSound("levelUp"),this.particleManager.emit(b.LEVEL_UP,e,s,50)),this.updateUI()}}checkGameOver(){if(this.trains.length===0&&this.economy.getBalance()<20){const t=this.statisticsManager.getStats();this.victoryManager.showGameOverScreen({totalRevenue:t.totalRevenue,totalDeliveries:t.totalDeliveries,gameDays:this.timeManager.getGameTimeDays()}),this.isPaused||(this.audioManager.playSound("gameOver"),this.isPaused=!0)}}loop(){const t=performance.now();let i=(t-this.lastTime)/1e3;this.lastTime=t,this.camera.update();const e=500*i;if((this.keys.KeyW||this.keys.ArrowUp)&&this.camera.move(0,-e),(this.keys.KeyS||this.keys.ArrowDown)&&this.camera.move(0,e),(this.keys.KeyA||this.keys.ArrowLeft)&&this.camera.move(-e,0),(this.keys.KeyD||this.keys.ArrowRight)&&this.camera.move(e,0),this.isPaused||this.menuManager.getState()!==I.PLAYING){if(this.menuManager.getState()!==I.MAIN_MENU&&(this.renderer.render(this.map,this.trains,this.notificationManager,this.particleManager,this.camera,this.selectedSpawnStation,this.timeManager.getGameTimeDays(),this.eventManager,this.currentMouseTile),this.isDragging&&this.dragStartTile&&this.dragEndTile)){const a=this.map.getTrackPath(this.dragStartTile,this.dragEndTile);this.renderer.drawGhostTracks(a)}requestAnimationFrame(()=>this.loop());return}const s=this.timeManager.getSpeed();i*=s,this.timeManager.tick(i);const n=Math.floor(this.timeManager.getGameTimeDays());if(n>this.lastDay){const a=this.statisticsManager.getStats().totalRevenue,r=a-this.revenueAtStartOfDay;this.chartManager.recordDailyRevenue(this.lastDay,r),this.lastDay=n,this.revenueAtStartOfDay=a,console.log(`üìÖ Day ${n} started. Yesterday's revenue: $${r}`);const o=this.statisticsManager.getStats();this.victoryManager.checkVictory({totalRevenue:o.totalRevenue,totalDeliveries:o.totalDeliveries,gameDays:this.timeManager.getGameTimeDays()})&&(this.victoryManager.showVictoryScreen({totalRevenue:o.totalRevenue,totalDeliveries:o.totalDeliveries,gameDays:this.timeManager.getGameTimeDays(),trainCount:this.trains.length,achievementCount:this.achievementManager.getUnlockedCount(),highestRevenue:o.highestRevenue}),this.isPaused=!0)}Math.random()<.016&&this.checkGameOver();try{this.marketManager.update(this.timeManager.getGameTimeDays()),this.map.updateProduction(i),this.maintenanceManager.update(this.timeManager.getGameTimeDays()),this.notificationManager.update(i),this.particleManager.update(i);const a=this.eventManager.update(this.timeManager.getGameTimeDays());a&&(this.notificationManager.addNotification(a,10,5,"#FFA500"),this.audioManager.playSound("achievement"),this.eventManager.updateUI()),this.updateUI();for(let r=this.trains.length-1;r>=0;r--){const o=this.trains[r],c=this.progressionManager.getBonuses(),h=(c?c.speed:1)*this.eventManager.getSpeedModifier();if(o.tick(this.map,i*h),Math.random()<.3){const d=o.getVisualPosition();this.particleManager.emit(b.STEAM,d.x,d.y,1),o.trainType===M.HEAVY&&Math.random()<.1&&this.particleManager.emit(b.SPARKS,d.x,d.y,1)}const l=this.map.getTile(o.x,o.y);if(l&&l.trackType==="station"&&!o.hasDelivered){const d=o.x===o.startX&&o.y===o.startY;let y=!1;if(l.accepts&&l.accepts.includes(o.cargoType)&&!d){y=!0,o.hasDelivered=!0,l.storage||(l.storage={}),l.storage[o.cargoType]=(l.storage[o.cargoType]||0)+1,l.storage[o.cargoType]=Math.min(100,(l.storage[o.cargoType]||0)+5),console.log(`üöÇ Train delivered ${o.cargoType} at (${o.x}, ${o.y})`);const m=Math.abs(o.x-o.startX)+Math.abs(o.y-o.startY),v=this.timeManager.getGameTimeDays()-o.startTime,T=o.speed*50,S=this.marketManager.getCurrentPrice(o.cargoType);let E=this.revenueSimulator.calculateRevenue(S,m,v,T);E*=this.progressionManager.getBonuses().revenue,E*=this.eventManager.getRevenueModifier();const R=Math.floor(E/10),w=this.progressionManager.addXp(R);this.economy.add(E),this.notificationManager.addNotification(`+$${Math.floor(E)}`,o.x,o.y-1,"#51CF66");for(const O of w.notifications)this.notificationManager.addNotification(O,o.x,o.y-2,"#00FFFF");w.leveledUp&&(this.audioManager.playSound("levelUp"),this.particleManager.emit(b.LEVEL_UP,o.x,o.y,50)),this.statisticsManager.recordDelivery(E),this.statisticsManager.getStats().totalDeliveries===1&&this.celebrateFirstDelivery(o.x,o.y),this.goalManager.updateProgress("delivery",1),this.goalManager.updateProgress("money",E),this.checkGoalCompletion();const W=this.achievementManager.checkAchievements({totalRevenue:this.statisticsManager.getStats().totalRevenue,deliveries:this.statisticsManager.getStats().totalDeliveries,trainCount:this.trains.length,lastDeliveryTime:v});for(const O of W){const D=this.achievementManager.getAchievements().find(V=>V.id===O);D&&(this.notificationManager.addNotification(`${D.icon} ${D.name}!`,o.x,o.y-1,"#FFD700"),this.audioManager.playSound("achievement"))}}if(l.produces&&l.produces.length>0){for(const m of l.produces)if((l.storage?.[m]||0)>=5&&(y||d)&&l.storage){l.storage[m]-=5,o.cargoType=m,o.startX=o.x,o.startY=o.y,o.startTime=this.timeManager.getGameTimeDays(),o.hasDelivered=!1,this.notificationManager.addNotification(`Loaded ${m}`,o.x,o.y,"#FFFFFF"),this.audioManager.playSound("click");break}}}else l&&l.trackType==="station"&&o.hasDelivered;(!l||l.trackType!=="station")&&(o.hasDelivered=!1),this.checkGoalCompletion(),this.updateUI();const u=this.statisticsManager.getStats();this.victoryManager.checkVictory({totalRevenue:u.totalRevenue,totalDeliveries:u.totalDeliveries,gameDays:this.timeManager.getGameTimeDays()})&&(this.victoryManager.showVictoryScreen({totalRevenue:u.totalRevenue,totalDeliveries:u.totalDeliveries,gameDays:this.timeManager.getGameTimeDays(),trainCount:this.trains.length,achievementCount:this.achievementManager.getUnlockedCount(),highestRevenue:u.highestRevenue}),this.isPaused=!0),this.trains.splice(r,1)}if(Math.random()<.05)for(let r=0;r<this.map.getHeight();r++)for(let o=0;o<this.map.getWidth();o++){const c=this.map.getTile(o,r);c&&c.trackType==="station"&&(c.stationType==="STEEL_MILL"||c.stationType==="COAL_MINE"||c.stationType==="TOOL_FACTORY")&&this.particleManager.emit(b.SMOKE,o+.5,r+.2,1)}if(this.renderer.render(this.map,this.trains,this.notificationManager,this.particleManager,this.camera,this.selectedSpawnStation,this.timeManager.getGameTimeDays(),this.eventManager,this.isDragging?null:this.currentMouseTile,this.editingRouteId?this.routeManager.getRoute(this.editingRouteId):null),this.isDragging&&this.dragStartTile&&this.dragEndTile){const r=this.map.getTrackPath(this.dragStartTile,this.dragEndTile);this.renderer.drawGhostTracks(r)}}catch(a){console.error("Game Loop Error:",a),this.isPaused=!0,this.notificationManager.addNotification("Game Error! Check Console",10,10,"#FF0000")}requestAnimationFrame(()=>this.loop())}setupRouteUI(){const t=document.getElementById("route-panel"),i=document.getElementById("btn-toggle-routes"),e=document.getElementById("btn-close-routes"),s=document.getElementById("btn-new-route"),n=document.getElementById("btn-finish-route"),a=document.getElementById("btn-delete-route");i&&t&&i.addEventListener("click",()=>{t.style.display=t.style.display==="none"?"block":"none",this.updateRouteListUI()}),e&&t&&e.addEventListener("click",()=>{t.style.display="none",this.editingRouteId=null,this.updateRouteEditorUI()}),s&&s.addEventListener("click",()=>{const r=this.routeManager.createRoute(`Route ${this.routeManager.getAllRoutes().length+1}`,"#FF00FF");this.editingRouteId=r.id,this.updateRouteListUI(),this.updateRouteEditorUI()}),n&&n.addEventListener("click",()=>{this.editingRouteId=null,this.updateRouteEditorUI(),this.updateRouteListUI()}),a&&a.addEventListener("click",()=>{this.editingRouteId&&(this.routeManager.deleteRoute(this.editingRouteId),this.editingRouteId=null,this.updateRouteEditorUI(),this.updateRouteListUI())})}updateRouteListUI(){const t=document.getElementById("route-list");if(!t)return;t.innerHTML="";const i=this.routeManager.getAllRoutes();if(i.length===0){t.innerHTML='<div style="text-align: center; color: #888; font-size: 12px; padding: 10px;">No routes created</div>';return}i.forEach(e=>{const s=document.createElement("div");s.style.padding="8px",s.style.borderBottom="1px solid rgba(255,255,255,0.1)",s.style.cursor="pointer",s.style.backgroundColor=this.editingRouteId===e.id?"rgba(255,255,255,0.1)":"transparent",s.innerHTML=`
                <div style="font-weight: bold; color: ${e.color};">${e.name}</div>
                <div style="font-size: 10px; color: #aaa;">${e.stops.length} stops</div>
            `,s.addEventListener("click",()=>{this.editingRouteId=e.id,this.updateRouteListUI(),this.updateRouteEditorUI()}),t.appendChild(s)})}updateRouteEditorUI(){const t=document.getElementById("active-route-editor"),i=document.getElementById("btn-new-route");if(!(!t||!i))if(this.editingRouteId){t.style.display="block",i.style.display="none";const e=this.routeManager.getRoute(this.editingRouteId);if(e){const s=document.getElementById("editing-route-name");s&&(s.innerText=e.name);const n=document.getElementById("route-stops-list");n&&(n.innerHTML="",e.stops.forEach((a,r)=>{const o=document.createElement("li");o.style.padding="4px 0",o.style.borderBottom="1px solid rgba(255,255,255,0.05)",o.innerHTML=`
                            <span style="color: #aaa;">${r+1}.</span> 
                            Stop at (${a.x}, ${a.y})
                            <button class="delete-stop-btn" style="float: right; background: none; border: none; color: #FF6B6B; cursor: pointer;">‚úï</button>
                        `;const c=o.querySelector(".delete-stop-btn");c&&c.addEventListener("click",h=>{h.stopPropagation(),this.routeManager.removeStop(e.id,r),this.updateRouteEditorUI(),this.updateRouteListUI()}),n.appendChild(o)}))}}else t.style.display="none",i.style.display="block"}setupTrainDetailsUI(){const t=document.getElementById("train-details-panel"),i=document.getElementById("btn-close-train-details"),e=document.getElementById("train-route-select"),s=document.getElementById("btn-sell-train");i&&t&&i.addEventListener("click",()=>{t.style.display="none",this.selectedTrain=null}),e&&e.addEventListener("change",n=>{if(this.selectedTrain){const a=n.target.value;if(a){const r=this.routeManager.getRoute(a);r&&(this.selectedTrain.assignedRoute=r,this.notificationManager.addNotification(`Assigned to ${r.name}`,this.selectedTrain.x,this.selectedTrain.y-1,r.color))}else this.selectedTrain.assignedRoute=null,this.notificationManager.addNotification("Route Cleared",this.selectedTrain.x,this.selectedTrain.y-1,"#FFFFFF")}}),s&&s.addEventListener("click",()=>{if(this.selectedTrain){const n=Math.floor(x.getTrainInfo(this.selectedTrain.trainType).cost*.75);this.economy.add(n),this.audioManager.playSound("sell"),this.particleManager.emit(b.SPARKLE,this.selectedTrain.x,this.selectedTrain.y,10);const a=this.trains.indexOf(this.selectedTrain);a>-1&&this.trains.splice(a,1),this.selectedTrain=null,t&&(t.style.display="none"),this.updateUI()}})}updateTrainDetailsUI(){const t=document.getElementById("train-details-panel");if(!t||!this.selectedTrain){t&&(t.style.display="none");return}t.style.display="block";const i=document.getElementById("train-details-type"),e=document.getElementById("train-details-cargo"),s=document.getElementById("train-details-speed"),n=document.getElementById("train-sell-value"),a=document.getElementById("train-route-select"),r=x.getTrainInfo(this.selectedTrain.trainType),o=k.getCargoInfo(this.selectedTrain.cargoType);i&&(i.innerText=r.name),e&&(e.innerText=o.name),s&&(s.innerText=r.speed.toFixed(1)),n&&(n.innerText=Math.floor(r.cost*.75).toString()),a&&(a.innerHTML='<option value="">None</option>',this.routeManager.getAllRoutes().forEach(h=>{const l=document.createElement("option");l.value=h.id,l.innerText=h.name,l.style.color=h.color,this.selectedTrain?.assignedRoute?.id===h.id&&(l.selected=!0),a.appendChild(l)}))}updateMarketUI(){const t=document.getElementById("market-list");if(!t)return;t.innerHTML="";const i=this.marketManager.getAllPrices();for(const e of i){const s=k.getCargoInfo(e.cargoType),n=Math.floor(e.basePrice*e.currentMultiplier);let a="‚ûñ",r="#888";e.trend>0?(a="üìà",r="#00FF00"):e.trend<0&&(a="üìâ",r="#FF0000");const o=document.createElement("tr");o.style.borderBottom="1px solid #333",o.innerHTML=`
                <td style="padding: 8px; display: flex; align-items: center; gap: 8px;">
                    <div style="width: 12px; height: 12px; background: ${s.color}; border-radius: 50%;"></div>
                    ${s.name}
                </td>
                <td style="padding: 8px; text-align: right; font-family: monospace;">$${n}</td>
                <td style="padding: 8px; text-align: center; color: ${r};">${a}</td>
            `,t.appendChild(o)}}updateButtonStates(){const t=document.getElementById("btn-build-track"),i=document.getElementById("btn-place-station"),e=document.getElementById("btn-set-spawn"),s=document.getElementById("btn-demolish");t&&t.classList.remove("active"),i&&i.classList.remove("active"),e&&e.classList.remove("active"),s&&s.classList.remove("active"),this.isPlacingStation?i?.classList.add("active"):this.isSettingSpawn?e?.classList.add("active"):this.isDemolishing?s?.classList.add("active"):t?.classList.add("active")}updateCursor(){const t=document.getElementById("gameCanvas");t&&(this.isPlacingStation?t.style.cursor="crosshair":this.isSettingSpawn?t.style.cursor="pointer":this.isDemolishing?t.style.cursor="not-allowed":t.style.cursor="default")}}try{window.game=new ct,console.log("Game initialized successfully")}catch(g){console.error("Failed to initialize game:",g),window.gameError=g}
